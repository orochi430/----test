"use strict";(self.webpackChunkxianzhengding=self.webpackChunkxianzhengding||[]).push([[82537],{82537:function(e,n,t){t.r(n),t.d(n,{default:function(){return l}});var o,i=t(13682),a=t(88561),r=t(25108);function s(e){return o.apply(this,arguments)}var n={name:"czbLogin",data:function(){return{loading:""}},created:function(){this.loading=dsf.layer.loading("登录中..."),this.certificateEntry()},methods:{goLogin:function(){this.$router.push({name:"testLogin"})},certificateEntry:function(){var n=this;dsf.http.post("fn/GeneratorChallenge").then(function(e){e=e.data;n.token(e.challenge),r.log("getRandom")})},loginSuccessDeal:function(e){var n=e.data;a.Z.saveToSessionStore("user",n),a.Z.saveToSessionStore("loginToken",n.auth.token),a.Z.saveToLocalStore("loginToken",n.auth.token),a.Z.saveToLocalStore("user",n),a.Z.saveToLocalStore("loginData",e),this.toNext()},toNext:function(){var t=this,n=a.Z.loadSessionStore("user"),o=a.Z.loadLocalStore("loginData");a.Z.logIn(function(){var e=n.user_id;r.log("Client",a.Z.getClientName()),r.log("shkt",o.shkt,1==o.shkt),"app"==a.Z.getClientName()&&1==o.shkt?(r.log("xsfCommon"),xsfCommon.bsCaLogin("",function(e){var n=JSON.parse(e).result;r.log("bsCaLogin",e,(0,i.Z)(e)),1==n&&t.goUrl()},function(e){r.log("bsCaLogin",e,(0,i.Z)(e)),t.tokenFail("",e)})):dsf.config.login.loginSaveUUID?(e="fn/sso/devicesave?DeviceId="+t.DeviceId+"&DeviceName="+t.DeviceName+"&userId="+e,dsf.http.get(e).then(function(e){t.goUrl()}).catch(function(e){t.tokenFail("",e.message)})):t.goUrl()})},goUrl:function(){dsf.layer.closeLoading(this.loading),dsf.config.login.defaultUrl?this.$router.replace(dsf.config.login.defaultUrl):this.$router.replace("/index")},token:function(e){var n=this;if(n.isIE())try{n.tokenActiveX(e)}catch(e){n.tokenFail(e,"客户端可能不支持activex方式获取票据."+e.message)}else try{n.tokenWebSocket2(e)}catch(e){n.tokenFail(e,"客户端可能不支持websocket方式获取票据."+e.message)}},tokenActiveX:(o=function(e){var n=this,t=document.getElementById(tokenActiveXId);if(null==t)n.tokenFail(1,"请检查是否在页面上定义了activeX控件:"+tokenActiveX);else{t.GetSignAndToken(e);if(t.lResult,0!=t.lResult)return e="activeX处理错误:"+t.bstrError,n.tokenFail(1,e),!1;n.tokenSuccess(random,t.bstrSignValAndToken)}},s.toString=function(){return o.toString()},s),tokenWebSocket2:function(n){r.log(n);var t=this,o='<?xml version="1.0" encoding="utf-8"?><getsignandtokenreq version="1"><challenge>'+n+"</challenge></getsignandtokenreq>",i=new WebSocket("ws://127.0.0.1:30318"),a=null,s=!0,l=0;i.onopen=function(e){i.send(o),l=1},i.onerror=function(e){s=!1,1==l?t.tokenFail(e,"WebSocket异常."+e.type):t.tokenFail(e,"WebSocket连接异常，请检查客户端安装或本地监听端口是否正常."+e.type)},i.onclose=function(e){return 0!=s&&(null==a||""==a?(t.tokenFail(e,"WebSocket连接关闭，但客户端未返回票据信息，请检查是否插KEY、是否配置设备以及设备是否工作正常等"),!1):void 0)},i.onmessage=function(e){return null==(a=e.data)||""==a?(t.tokenFail(e,"WebSocket连接成功，但客户端未返回票据信息，请检查是否插KEY、是否配置设备以及设备是否工作正常等"),!1):0!=a.split("</result>")[0].split("<result>")[1]?(e=a.split("</errorinfo>")[0].split("<errorinfo>")[1],t.tokenFail(3,e),!1):(e=a.split("</tokeninfo>")[0].split("<tokeninfo>")[1],r.log("token",e),void t.tokenSuccess(n,e))}},tokenSuccess:function(e,n){var t=this;dsf.http.post("fn/mobileProjectAuth/auth",{challenge:e,tokeninfo:n},{headers:{"Content-Type":"application/json"}}).then(function(e){e=e.data;r.log("auth",e),a.Z.saveToLocalStore("lastLoginType","user"),1==e.rcode?t.loginSuccessDeal(e):t.tokenFail("","未获取到身份信息")})},tokenFail:function(e,n,t){dsf.layer.closeLoading(self.loading),dsf.layer.toast(n)},isIE:function(){var e=!1,n=navigator.userAgent.toLowerCase(),t=-1<n.indexOf("Opera");return e=-1<n.indexOf("compatible")&&-1<n.indexOf("msie")&&!t?!0:e}}},l=(0,t(51900).Z)(n,function(){return(0,this._self._c)("div",{staticClass:"czbLogin",on:{click:this.goLogin}})},[],!1,null,"1af3f834",null).exports}}]);
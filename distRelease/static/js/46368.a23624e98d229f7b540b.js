"use strict";(self.webpackChunkxianzhengding=self.webpackChunkxianzhengding||[]).push([[46368,18868],{30819:function(e,t,n){n.d(t,{Z:function(){return d}});var t=n(26243),a=n.n(t),t=n(62680),s=n.n(t),t=n(95366),i=n.n(t),t=n(6919),o=n.n(t),r=n(77193),t=n(73473),c=n.n(t);function l(t,e){var n,o=a()(t);return s()&&(n=s()(t),e&&(n=n.filter(function(e){return i()(t,e).enumerable})),o.push.apply(o,n)),o}var t={name:"WorkFlowDialog",props:{formData:{type:Object,default:function(){return{}}},metaData:{type:Object,default:function(){return{}}}},data:function(){return{text:"退回",message:"",showDialog:!1,submitAfter:function(){},h:0,isNeedWrite:dsf.config.setting["SYS-FLOW-0038"]||0,personSelectData:[],secPeo:!1,columns:[],SendRequest:{}}},created:function(){},mounted:function(){},computed:{isShowUser:function(){return 1<this.columns.length||dsf.config.commonFlow.onePersonBackIsShow}},methods:{cancel:function(){this.showDialog=!1,this.h=0,this.$emit("close")},sendBack:function(){var t=this,e={pid:this.formData.pid||this.formData.pId,pnid:this.formData.pnid||this.formData.pnId,wfId:this.formData.flowId,backReason:this.message},n=dsf.layer.loading(this.text+"中");dsf.http.post("/fn/mobileFlow/sendBack",e).then(function(e){dsf.layer.closeLoading(n),t.dsf.layer.toast(t.text+"成功",!0),t.cancel(),setTimeout(function(){t.$emit("change")},100)})},sendBackNew:function(){var t,e,n=this,o=!0;n.metaData.buttons.mainButtons.some(function(e){"NoopinionBack"==e.action&&(o=!1)}),""==n.message.trim()&&1==n.isNeedWrite&&1==o?dsf.layer.toast("请输入退回原因"):n.personSelectData.length<1&&n.isShowUser?dsf.layer.toast("请选择退回人员"):(t=dsf.layer.loading(n.text+"中"),e={TPID:n.SendRequest.tpid,CurLinkID:n.personSelectData[0].LinkID,WFID:n.SendRequest.wfid,backType:1,Remark:n.message,inherit:"",MultSendBackMod:n.SendRequest.multSendBackMod,IsMergeTodo:n.SendRequest.isMergeTodo,NGR:0,SendBackTo:n.SendRequest.sendBackTo},dsf.http.post("/fn/flow/submitSendBackNode",e).then(function(e){dsf.layer.closeLoading(t),n.dsf.layer.toast(n.text+"成功",!0),n.cancel(),setTimeout(function(){n.$emit("change")},100)}))},show:function(e){var n=this,e=e.text,t=(this.personSelectData=[],{pId:this.metaData.parameters?this.metaData.parameters.pId:this.formData.pid||this.formData.pId,flowId:(this.metaData.parameters||this.formData).flowId,pk:this.metaData.parameters?this.metaData.parameters.pk:this.formData.info_d||this.formData.info_id,pnId:this.metaData.parameters?this.metaData.parameters.pnId:this.formData.pnid||this.formData.pnId});return dsf.http.get("fn/flow/getGPNodeProcess",t).then(function(e){var t,e=e.data;"200"==e.code&&(t=[],n.SendRequest=e.data.SendRequest,e.data.processArray.forEach(function(e){t.push(function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach(function(e){(0,r.Z)(t,e,n[e])}):o()?Object.defineProperties(t,o()(n)):l(Object(n)).forEach(function(e){Object.defineProperty(t,e,i()(n,e))})}return t}({text:e.Sender.UserName+"(".concat(e.PARENT_NODENAME,")")},e))}),n.columns=t,1==n.columns.length&&(n.personSelectData=t),n.initHeight())}),this.text=e||"",this.message="退回"==e&&dsf.config.setting["SYS-MOBILE-FORM-0005"]||"",this.showDialog=!0,new(c())(function(e){n.submitAfter=e})},initHeight:function(){var e=this;this.$nextTick(function(){e.isShowUser?e.h=e.$refs.content.offsetHeight-270:e.h=e.$refs.content.offsetHeight-160})},close:function(){this.showDialog=!1,this.h=0},showPersonModel:function(){this.secPeo=!this.secPeo},onConfirm:function(e){this.personSelectData=[],this.personSelectData.push(e),this.showPersonModel()},closePerson:function(e,t){this.personSelectData.splice(t,1)},submitFun:function(){this.submitAfter(),this.text,this.sendBackNew()}}},d=(0,n(51900).Z)(t,function(){var o=this,e=o._self._c;return e("div",{directives:[{name:"show",rawName:"v-show",value:o.showDialog,expression:"showDialog"}],staticClass:"ds-workflow_dialog"},[e("div",{staticClass:"header"},[e("van-nav-bar",{attrs:{title:o.text+"理由","left-text":"取消"},on:{"click-left":function(e){return o.cancel()}}})],1),o._v(" "),e("div",{ref:"content",staticClass:"content"},[o.isShowUser?e("div",{ref:"user",staticClass:"sheetBox"},[e("p",{staticClass:"reasonLabel"},[o._v("退回人员")]),o._v(" "),e("div",{staticClass:"disfr ac",staticStyle:{padding:"10px 0"}},[e("div",{staticClass:"peopleSec disfr ac flex1"},[o._l(o.personSelectData,function(t,n){return e("van-tag",{key:n,attrs:{closeable:"",size:"large",type:"primary"},on:{close:function(e){return o.closePerson(t,n)}}},[o._v("\n            "+o._s(t.text)+"\n          ")])}),o._v("\n            \n        ")],2),o._v(" "),e("van-button",{staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"default"},on:{click:o.showPersonModel}},[o._v("选择人员")])],1),o._v(" "),e("p",{staticClass:"reasonLabel",staticStyle:{"margin-bottom":"0.2rem"}},[o._v("退回原因")])]):o._e(),o._v(" "),e("van-field",{ref:"reason",staticClass:"reason",attrs:{rows:"5",type:"textarea",placeholder:"请输入"+o.text+"理由",border:""},model:{value:o.message,callback:function(e){o.message=e},expression:"message"}})],1),o._v(" "),e("div",{staticClass:"footer"},[e("van-button",{attrs:{type:"theme",block:""},on:{click:o.submitFun}},[o._v("确认"+o._s(o.text))])],1),o._v(" "),e("van-popup",{style:{height:"50vh"},attrs:{position:"bottom",round:""},model:{value:o.secPeo,callback:function(e){o.secPeo=e},expression:"secPeo"}},[e("div",{staticStyle:{width:"100%"}},[e("van-picker",{attrs:{title:"请选择退回人员","show-toolbar":"",columns:o.columns},on:{confirm:o.onConfirm,cancel:o.showPersonModel}})],1)])],1)},[],!1,null,"447cfcb4",null).exports},90647:function(e,t,n){n.r(t),n.d(t,{default:function(){return h}});var o=n(77193),a=n(66250),t=n(8450),d=n.n(t),t=n(26243),s=n.n(t),t=n(62680),i=n.n(t),t=n(95366),r=n.n(t),t=n(6919),c=n.n(t),t=n(33453),u=n.n(t),t=n(96345),l=n(30819),f=n(25108);function m(t,e){var n,o=s()(t);return i()&&(n=i()(t),e&&(n=n.filter(function(e){return r()(t,e).enumerable})),o.push.apply(o,n)),o}function p(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?m(Object(n),!0).forEach(function(e){(0,o.Z)(t,e,n[e])}):c()?Object.defineProperties(t,c()(n)):m(Object(n)).forEach(function(e){Object.defineProperty(t,e,r()(n,e))})}return t}var t={components:{sendFile:t.Z,workFlowDialog:l.Z},data:function(){return{showFlowSend:!1,moduleId:this.$route.query.moduleId,pk:this.$route.query.pk,todoId:this.$route.query.todoId||"",djAccount:"",fileData:{},pnid:"",nodeName:"",formUrl:"",attachmentUrl:"",fileTimer:null,user:dsf.util.loadSessionStore("user")||{},FileIds:"",showFlowBack:!1,selected:{},alreadyLoaded:!1}},mounted:function(){var n=this;return(0,a.Z)(u().mark(function e(){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=dsf.util.loadSessionStore("user").privileges.some(function(e){return"点聚手写签批授权"===e.name}),e.next=3,n.getDianJuAcount();case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0="";case 6:n.djAccount=e.t0,t?(n.link(),n.formUrl=dsf.base64.encode("/commonForm/".concat(n.moduleId,"/").concat(n.pk,"/1?").concat(n.todoId?"todoId="+n.todoId:"","&isShowHeader=0&isdjOpen=1&activeTab=formTab&hideOtherTab=1&needBtn=0")).replace(new RegExp("/","gm"),"@"),n.attachmentUrl=dsf.base64.encode("/commonForm/".concat(n.moduleId,"/").concat(n.pk,"/1?").concat(n.todoId?"todoId="+n.todoId:"","&isShowHeader=0&isdjOpen=1&activeTab=relevantFile&hideOtherTab=1&needBtn=0")).replace(new RegExp("/","gm"),"@")):(dsf.config.commonForm.dianJu.isEnable=!1,n.alreadyLoaded=!0,n.$router.replace({path:"/commonForm/".concat(n.moduleId,"/").concat(n.pk,"/1"),query:{todoId:n.todoId,webViewBack:!0,isdjOpen:1,closePage:1}}));case 8:case"end":return e.stop()}},e)}))()},methods:{dianJuFileOpen:function(i,r,c){var l=this;return(0,a.Z)(u().mark(function e(){var t,n,o,a,s;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=l,s="1"===String(i.canEdit),a=dsf.url.getRootPath(),l.FileIds=i.id,n=a+"fn/mobileOffice/upload?fileId=".concat(i.id,"&moduleId=").concat(i.moduleId,"&pnId=").concat(l.pnid,"&nodeName=").concat(t.nodeName,"&fileType=1&infoId=").concat(i.infoId,"&extension=").concat(c,"&x-auth-token=").concat(dsf.util.loadSessionStore("loginToken")),a={fileUrl:o=a+r,title:i.title,canEdit:s,uploadUrl:n,keyId:i.id,userName:dsf.util.loadSessionStore("user").name,backBtn:!0,webData:{webDianjutTab:!0,formUrl:location.href.split("#/")[0]+"#/autoLoginToUrl/".concat(dsf.util.loadSessionStore("loginToken"),"/").concat(l.formUrl,"/")+Math.random()+"?isdjOpen=1",attachmentUrl:location.href.split("#/")[0]+"#/autoLoginToUrl/".concat(dsf.util.loadSessionStore("loginToken"),"/").concat(l.attachmentUrl,"/")+Math.random()+"?isdjOpen=1"},useFingerWrite:"false",tab:[{title:"签批单",type:"sign"},{title:"附件",type:"attachment"},{title:"表单",type:"form"}]},f.log("点聚参数",a),e.next=10,l.isSignFileLock(i.id);case 10:s=e.sent,a.djAccount=l.djAccount,l.alreadyLoaded=!0,!s&&l.djAccount?xsfCommon.dianJuSdk(d()(a),function(e){e=JSON.parse(e),f.log("打开点聚的回调参数",e),"dianjuUploadSuccess"==e.message?t.send():"dianjuBackSuccess"==e.message?(t.showFlowBack=!0,t.$nextTick(function(){t.$refs.wfDialog.show({text:"退回"})}),t.handleFlowBackChange=function(){t.showFlowBack=!1,t.onRefresh(),t.destroyFileInterval(i.id)}):"dianjuOpenSuccess"==e.message?t.continueLockFile(i.id):"dianjuOpenError"==e.message?dsf.layer.alert({message:"文件打开失败:"+o}):"dianjuFileClose"==e.message&&("open"==e.type&&e.result?"send"==e.type&&t.send():e.secondOpen||t.destroyFileInterval(i.id))},function(e){f.log("open failed: ",e)}):(dsf.config.commonForm.dianJu.isEnable=!1,l.$router.replace({path:"/commonForm/".concat(l.moduleId,"/").concat(l.pk,"/1"),query:{todoId:l.todoId,webViewBack:!0,isdjOpen:1,closePage:1}}));case 14:case"end":return e.stop()}},e)}))()},link:function(){var t,n=this,e={pk:this.pk,moduleId:this.moduleId},a=[];this.todoId&&(e.todoId=this.todoId),dsf.http.get("fn/xform/getInfo",e).then(function(e){e=e.data;t={info_id:e.struct.parameters.infoId||e.struct.parameters.pk,infoId:e.struct.parameters.infoId||e.struct.parameters.pk,nodeId:e.struct.parameters.nodeId,flowId:e.struct.parameters.flowId,moduleId:e.struct.parameters.moduleId,start:1,limit:100},n.selected={pid:e.struct.parameters.pId,info_id:e.struct.parameters.pk,flowId:e.struct.parameters.flowId,pnId:e.struct.parameters.pnId},n.fileData=p(p({},e.struct.parameters),{},{pid:e.struct.parameters.pId,pnid:e.struct.parameters.pnId,id:e.struct.parameters.pk,sendType:"",bt:"",moduleName:"",infoId:e.struct.parameters.pk,info_id:e.struct.parameters.pk}),n.nodeName=e.struct.parameters.nodeName,n.pnid=e.struct.parameters.pnId,dsf.http.post("fn/mobileAttachment/getFormAttachment",t).then(function(e){var t,e=e.data.rows,o=dsf.util.loadSessionStore("loginToken");e.forEach(function(n){n.document&&n.document.forEach(function(e,t){e={id:e.id,title:e.title,type:e.type,size:e.showFileSize||"",navtiveUrl:e.url,initUrl:"fn/office/downloadFile?infoId=".concat(e.infoId,"&fileId=").concat(e.id,"&fileName=").concat(e.title,"&nrType=").concat(e.type,"&moduleId=").concat(e.moduleId,"&x-auth-token=").concat(o,"&fullfilename=").concat(e.title,"&file=").concat(e.title),infoId:e.infoId,moduleId:e.moduleId,isHandwrite:e.isHandwrite,isRevise:e.isRevise,isNoModify:e.isNoModify,canEdit:e.canEdit,canDownLoad:e.canDownLoad,name:1<n.document.length?"".concat(n.name).concat(t+1):n.name};"1"==e.isHandwrite&&"-5"==e.type&&a.push(e)})}),a.length?(t=(e=a[0]).navtiveUrl.lastIndexOf("."),t=e.navtiveUrl.substr(t+1),n.dianJuFileOpen(e,e.initUrl,t)):(dsf.config.commonForm.dianJu.isEnable=!1,n.$router.replace({path:"/commonForm/".concat(n.moduleId,"/").concat(n.pk,"/1"),query:{todoId:n.todoId,webViewBack:!0,isdjOpen:1,closePage:1}}))}).catch(function(e){return f.log(e)})})},handleFlowBackChange:function(){this.showFlowBack=!1,this.destroyFileInterval(this.FileIds)},changeFrameHeight:function(t){f.log("changeFrameHeight高度变化");var n=this;this.$nextTick(function(){try{var e=n.$refs.enclosurePre.offsetHeight;f.log("parentHeight高度变化"+e),document.querySelector("#filePreview"+t).style.height=e+"px"}catch(e){throw new Error("自定义错误setIframeHeight Error")}})},send:function(){var e=this;this.showFlowSend=!0,this.$nextTick(function(){e.$refs.sendFile.show("isList")})},handleFlowSendChange:function(){this.showFlowSend=!1},closeSendFile:function(){this.showFlowSend=!1},closeSendFilePopup:function(){this.destroyFileInterval(this.FileIds)},getContainer:function(){return document.body},getDianJuAcount:function(){return(0,a.Z)(u().mark(function e(){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t="",e.next=3,dsf.http.post("ctrl/thirdPartyInterfaces/getDianJuAcount").then(function(e){f.log("isLock-res",e),"200"==e.data.code?t=e.data.data.djAccount:dsf.layer.toast(e.data.message)}).error(function(e){f.log(e)});case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}},e)}))()},isSignFileLock:function(n){return(0,a.Z)(u().mark(function e(){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=!1,dsf.config.commonForm.isInterceptMultiPersonSign)return e.next=4,dsf.http.post("fn/office/isLock",{fileId:n}).then(function(e){f.log("isLock-res",e),"error"==e.data.type&&(dsf.layer.alert({message:"当前文件正在由"+e.data.data.uname+"办理，请稍后处理。"},function(){xsfWindow.closeWebView()}),t=!0)});e.next=4;break;case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}},e)}))()},continueLockFile:function(e){dsf.config.commonForm.isInterceptMultiPersonSign&&(this.fileTimer=setInterval(function(){dsf.http.post("fn/office/continueLock",{fileId:e}).then(function(e){f.log(e,"文件定时上锁")})},3e4))},destroyFileInterval:function(e){clearInterval(this.fileTimer),this.fileTimer=null,dsf.config.commonForm.isInterceptMultiPersonSign?dsf.http.post("fn/office/unLock",{fileId:e}).then(function(e){f.log(e,"文件解锁"),xsfWindow.closeWebView()}):xsfWindow.closeWebView()},destroyFileIntervalAll:function(e){clearInterval(this.fileTimer),this.fileTimerfileTimer=null,dsf.config.commonForm.isInterceptMultiPersonSign&&dsf.http.post("fn/office/releaseLock",{pk:e}).then(function(e){f.log(e,"所有文件解锁成功")})}},destroyed:function(){this.destroyFileIntervalAll(this.pk)}},h=(0,n(51900).Z)(t,function(){var t=this,e=t._self._c;return e("div",{ref:"enclosurePre",staticClass:"mzt_dianju"},[t.alreadyLoaded?t._e():e("van-loading",{staticStyle:{"text-align":"center"},attrs:{size:"24px"}},[t._v("加载中...")]),t._v(" "),e("van-popup",{ref:"sendPop",staticStyle:{height:"90vh"},attrs:{"get-container":t.getContainer,"lock-scroll":"",position:"bottom",round:""},on:{close:t.closeSendFilePopup},model:{value:t.showFlowSend,callback:function(e){t.showFlowSend=e},expression:"showFlowSend"}},[e("sendFile",{directives:[{name:"show",rawName:"v-show",value:t.showFlowSend,expression:"showFlowSend"}],ref:"sendFile",attrs:{"form-data":t.fileData,isShowWriteOpintionBtn:!0},on:{change:t.handleFlowSendChange,close:t.closeSendFile}})],1),t._v(" "),e("van-popup",{attrs:{"get-container":t.getContainer,"close-on-click-overlay":!1,"lock-scroll":"",position:"bottom",round:""},model:{value:t.showFlowBack,callback:function(e){t.showFlowBack=e},expression:"showFlowBack"}},[e("work-flow-dialog",{ref:"wfDialog",attrs:{"form-data":t.selected},on:{change:t.handleFlowBackChange,close:function(e){t.showFlowBack=!1,t.destroyFileInterval(t.FileIds)}}})],1)],1)},[],!1,null,"2ce17b22",null).exports},18868:function(e,t,n){var s=n(25108);const i=(o,a=500,s=!0)=>{let i,r=0,c,l,d=n=>{i=setTimeout(()=>{var e=(new Date).getTime(),t=e-r;t<n?(r=e,d(a-t)):(s||o.apply(c,l),clearTimeout(i),i=null)},n)};return function(){c=this,l=arguments;var e=(new Date).getTime();r=e,i||(s&&o.apply(c,l),d(a))}};t.Z={name:"DebounceClick",functional:!0,render(e,t){var n,o=t.props.time,a=t.props.immediate,t=t.slots().default;return void 0===t?(s.warn("<debounce> 组件必须要有子元素"),null):((t=t[0]||null).data.on&&t.data.on.click?(n=t.data.on.click,n=i(n,o,a),t.data.on.click=n):t.componentOptions&&t.componentOptions.listeners.click&&(n=t.componentOptions.listeners.click,n=i(n,o,a),t.componentOptions.listeners.click=n),t)}}}}]);
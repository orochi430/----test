"use strict";(self.webpackChunkxianzhengding=self.webpackChunkxianzhengding||[]).push([[8940,18868],{98559:function(e,t,n){n.r(t),n.d(t,{default:function(){return i}});var y=n(522),o=n(66250),t=n(33453),f=n.n(t),t=n(8450),g=n.n(t),t=n(27921),a=n.n(t),t=n(85579),c=n.n(t),t=n(22013),l=n.n(t),t=n(96345),v=n(25108);function k(e,t){var n,o,i,s,r=void 0!==c()&&e[l()]||e["@@iterator"];if(r)return o=!(n=!0),{s:function(){r=r.call(e)},n:function(){var e=r.next();return n=e.done,e},e:function(e){o=!0,i=e},f:function(){try{n||null==r.return||r.return()}finally{if(o)throw i}}};if(Array.isArray(e)||(r=function(e,t){var n;if(e)return"string"==typeof e?d(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?a()(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),s=0,{s:t=function(){},n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var t={components:{sendFile:t.Z},data:function(){return{showFlowSend:!1,moduleId:this.$route.query.moduleId,pk:this.$route.query.pk,todoId:this.$route.query.todoId||"",fileData:{},formUrl:"",attachmentUrl:"",istopForm:-2,typedata:"",showType:!1,istopSendstr:!1,sendtypestr:!1,infoId:"",distribIds:this.$route.query.distribIds,qydFlag:this.$route.query.qydFlag,fileTimer:null,flag_dy:this.$route.query.flag_dy||!1,user:dsf.util.loadSessionStore("user")||{},qydFiles:[],ifra:!1,FileIds:"",spHandleJS:{}}},mounted:function(){dsf.config.login.toRegularForm?this.$router.replace({path:"/commonForm/".concat(this.moduleId,"/").concat(this.pk,"/1"),query:{todoId:this.todoId,webViewBack:!0}}):(this.link(),this.formUrl=dsf.base64.encode("/commonForm/".concat(this.moduleId,"/").concat(this.pk,"/1?").concat(this.todoId?"todoId="+this.todoId:"","&isShowHeader=0&isdjOpen=1&activeTab=formTab&hideOtherTab=1")).replace(new RegExp("/","gm"),"@"),this.attachmentUrl=dsf.base64.encode("/commonForm/".concat(this.moduleId,"/").concat(this.pk,"/1?").concat(this.todoId?"todoId="+this.todoId:"","&isShowHeader=0&isdjOpen=1&activeTab=relevantFile&hideOtherTab=1")).replace(new RegExp("/","gm"),"@"))},methods:{dianJuFileOpen:function(a,c,l){var d=arguments,u=this;return(0,o.Z)(f().mark(function e(){var n,o,i,t,s,r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=3<d.length&&void 0!==d[3]&&d[3],n=u,o=dsf.url.getRootPath(),i=[],t=o+"ctrl/qpController/saveLogDate?infoId=".concat(u.pk,"&nodeId=").concat(u.fileData.nodeId,"&userId=").concat(dsf.util.loadSessionStore("user").user_id),s=o+"ctrl/checkMD5/getMD5byFileId",a.forEach(function(e){var t=e.navtiveUrl.lastIndexOf("."),t=e.navtiveUrl.substr(t+1),t=o+"fn/mobileOffice/upload?fileId=".concat(e.id,"&moduleId=").concat(e.moduleId,"&pnId=").concat(u.fileData.pnId,"&nodeName=").concat(u.fileData.nodeName,"&fileType=1&infoId=").concat(e.infoId,"&extension=").concat(t,"&x-auth-token=").concat(dsf.util.loadSessionStore("loginToken")),n=o+e.initUrl,n=(u.FileIds=u.FileIds?u.FileIds+","+e.id:e.id,{title:e.name,type:"sign",fileUrl:n,fileName:e.title,uploadUrl:t,canEdit:"1"==String(e.canEdit),templateUrl:"",fileID:e.id});i.push(n)}),r={keyId:u.pk,userName:dsf.util.loadSessionStore("user").name,tab:i,mainButtons:c,unifyMessage:l,closeDianju:r,logUrl:t,mdUrl:s},e.next=10,u.isSignFileLock(u.FileIds);case 10:e.sent||(v.log("点聚参数",r),xsfCommon.dianJuTabSdk(g()(r),function(e){var t;e=JSON.parse(e),v.log("打开点聚的回调参数",e),"setFocus"==e.type?n.setFocus():"deleteFocus"==e.type?n.deleteFocus():"agreeRecycle"==e.type?n.agreeRecycle():"refuseRecycle"==e.type?n.refuseRecycle():"dianjuUploadSuccess"==e.message?n.istopSendstr?n.istopSend():n.sendtypestr?n.showType=!0:n.send():"dianjuOpenSuccess"==e.message?(n.continueLockFile(n.FileIds),n.flag_dy&&(t={infoIds:n.pk,distribIds:n.distribIds,shareContent:"已阅"},dsf.http.post("fn/mobileToReadOperation/readed",t).then(function(e){e=e.data;e.message,e.result,e.type}).error(function(){dsf.layer.clear()}))):"dianjuOpenError"==e.message?dsf.layer.alert({message:"文件打开失败:"+down_url}):"dianjuFileClose"==e.message&&("open"==e.type&&e.result?"send"==e.type&&(n.istopSendstr?n.istopSend():n.sendtypestr?n.showType=!0:n.send()):n.destroyFileInterval(n.FileIds))},function(e){v.log("open file error: ",e)}));case 12:case"end":return e.stop()}},e)}))()},link:function(){var l,h=this,m=0<arguments.length&&void 0!==arguments[0]&&arguments[0],I=[],e=(this.qydFiles=[],{pk:this.pk,moduleId:this.moduleId});this.todoId&&(e.todoId=this.todoId),dsf.http.get("fn/xform/getInfo",e).then(function(e){var o,i,e=e.data,t=(l={info_id:e.struct.parameters.infoId||e.struct.parameters.pk,infoId:e.struct.parameters.infoId||e.struct.parameters.pk,nodeId:e.struct.parameters.nodeId,flowId:e.struct.parameters.flowId,moduleId:e.struct.parameters.moduleId,start:1,limit:100},{}),s=h,u=(((null==(r=dsf.util.loadSessionStore("user"))?void 0:r.privileges)||[]).forEach(function(e){"发送设置重要"==e.name?o=!0:"发送设置分类"==e.name&&(i=!0)}),[]),f="";function n(e){var t,n={};"istopSend"==e.action&&o?s.istopSendstr=!0:"sendtype"==e.action&&i?s.sendtypestr=!0:"setFocus"==e.action?(t=e.parameters.find(function(e){return"infoId"==e.key}),s.infoId=t.value,n.action="setFocus"):"deleteFocus"==e.action?(t=e.parameters.find(function(e){return"infoId"==e.key}),s.infoId=t.value,n.action="deleteFocus"):"agreeRecycle"==e.action?n.action="agreeRecycle":"refuseRecycle"==e.action&&(n.action="refuseRecycle"),"{}"!=g()(n)&&u.push(n)}e.struct.parameters.applyRecycleMessage&&(f=e.struct.parameters.applyRecycleMessage),e.struct.parameters.distribId&&(s.distribIds=e.struct.parameters.distribId),e.struct.buttons.mainButtons.forEach(function(e){n(e)}),e.struct.buttons.commonButtons.forEach(function(e){n(e)});var r=(null==(r=e.struct.buttons.commonButtons.find(function(e){return"send"==e.action}))?void 0:r.parameters)||(null==(r=e.struct.buttons.mainButtons.find(function(e){return"send"==e.action}))?void 0:r.parameters),a=(r&&r.forEach(function(e){t[e.key]=e.value}),1),c=!1,p=(e.struct.controls.forEach(function(e){"controlEditOpinion"==e.controlType&&1==e.privilege.visible&&(a=0),"controlOpinionTagView"==e.controlType&&(c=!0)}),e.struct.parameters);h.fileData={pk:p.pk,id:p.pk,moduleId:p.moduleId,pid:p.pId||0,pId:p.pId||0,pnid:p.pnId||0,pnId:p.pnId||0,flowId:p.flowId,infoId:p.pk,info_id:p.pk,moduleName:"",todo:h.todoId,allowEditOpinion:a&&p.allowEditOpinion,opinionRequired:p.opinionRequired,nodeId:p.nodeId,nodeName:p.nodeName,bt:e.data.main.B0001.value,sendType:"",nextLineId:(null==t?void 0:t.isBackTrack)||0,direction:null==t?void 0:t.isBackTrack,determineUser:null==t?void 0:t.isBackTrack,nextNodeId:null==t?void 0:t.isBackTrack,endOtherLink:0,isBackTrack:null==t?void 0:t.isBackTrack,hasControlOpinionTagView:c},dsf.http.post("fn/mobileAttachment/getFormAttachment",l).then(function(e){var t,n=dsf.util.loadSessionStore("loginToken"),o=k(e.data.rows);try{for(o.s();!(t=o.n()).done;){var i=t.value;if(i.document){var s,r=k(i.document.entries());try{for(r.s();!(s=r.n()).done;){var a=(0,y.Z)(s.value,2),c=a[0],l=a[1],d={id:l.id,title:l.title,type:l.type,size:l.showFileSize||"",navtiveUrl:l.url,url:dsf.url.getServerUrl("fn/office/openMobileOffice?fileId=".concat(l.id,"&moduleId=").concat(l.moduleId,"&fileName=").concat(l.title,"&nodeId=").concat(p.nodeId,"&flowId=").concat(p.flowId,"&x-auth-token=").concat(n,"&canEdit=").concat(l.canEdit)),initUrl:"fn/file/download?infoId=".concat(l.infoId,"&fileId=").concat(l.id,"&fileName=").concat(l.title,"&nrType=").concat(l.type,"&moduleId=").concat(l.moduleId,"&x-auth-token=").concat(n,"&fullfilename=").concat(l.title),infoId:l.infoId,moduleId:l.moduleId,isHandwrite:l.isHandwrite,isRevise:l.isRevise,isNoModify:l.isNoModify,canEdit:l.canEdit,canDownLoad:l.canDownLoad,name:1<i.document.length?"".concat(i.name).concat(c+1):i.name};h.qydFlag?h.qydFiles.push(d):l.hasOwnProperty("isHandwrite")&&1!=l.isHandwrite||I.push(d)}}catch(e){r.e(e)}finally{r.f()}}}}catch(e){o.e(e)}finally{o.f()}I.length?h.dianJuFileOpen(I,u,f,m):h.qydFiles.length?h.ifra=!0:h.$router.replace({path:"/commonForm/".concat(h.moduleId,"/").concat(h.pk,"/1"),query:{todoId:h.todoId,webViewBack:!0}})}).catch(function(e){return v.log(e)})})},onClick:function(e){v.log(e)},changeFrameHeight:function(t){v.log("changeFrameHeight高度变化");var n=this;this.$nextTick(function(){try{var e=n.$refs.enclosurePre.offsetHeight;v.log("parentHeight高度变化"+e),document.querySelector("#filePreview"+t).style.height=e+"px"}catch(e){throw new Error("自定义错误setIframeHeight Error")}})},send:function(){var e=this;this.showFlowSend=!0,this.$nextTick(function(){e.$refs.sendFile.show("isList")})},handleFlowSendChange:function(){this.showFlowSend=!1},closeSendFile:function(){this.showFlowSend=!1},closeSendFilePopup:function(){this.destroyFileInterval(this.FileIds)},closealertPopup:function(){this.destroyFileInterval(this.FileIds)},deleteFocus:function(){var t=this,n=dsf.layer.loading("提交中"),e={infoId:this.infoId,"x-auth-token":dsf.util.loadSessionStore("loginToken")};dsf.http.post("/fn/mobileFocus/deleteFocus",e).then(function(e){e=e.data.message;dsf.layer.closeLoading(n),dsf.layer.toast(e),"操作成功"==e&&t.link()})},setFocus:function(){var t,e,n=this;1!=dsf.config.setting["SYS-MOBILE-FORM-0018"]&&(t=dsf.layer.loading("提交中"),e={fid:0,infoId:this.infoId,"x-auth-token":dsf.util.loadSessionStore("loginToken")},dsf.http.post("fn/mobileFocus/setFocus",e).then(function(e){e=e.data.message;dsf.layer.closeLoading(t),dsf.layer.toast(e),n.link()}))},agreeRecycle:function(){var t=this,e={pk:this.pk,todoId:this.todoId,moduleId:this.moduleId};dsf.http.post("fn/flow/agreeRecycle",e).then(function(e){dsf.layer.toast("操作成功",!0),t.link(!0)})},refuseRecycle:function(){var t=this,e={pk:this.pk,todoId:this.todoId,moduleId:this.moduleId};dsf.http.post("fn/flow/refuseRecycle",e).then(function(e){dsf.layer.toast("操作成功",!0),t.link()})},setInfos:function(e){-2!=this.istopForm&&dsf.http.post("fn/flow/istop",{pk:this.pk,type:this.istopForm,column:e})},istopSend:function(){var e=this;dsf.layer.confirm({message:"是否设置为重要文件?"},function(){e.istopForm=2,e.setInfos(1),e.send()},function(){e.istopForm=1,e.setInfos(1),e.send()})},sendtype:function(e){switch(this.showType=!1,e){case"呈批":this.istopForm=2,this.setInfos(2);break;case"阅件":this.istopForm=3,this.setInfos(2);break;case"外出报备":this.istopForm=4,this.setInfos(2);break;case"信息":this.istopForm=5,this.setInfos(2)}this.send()},getContainer:function(){return document.body},isSignFileLock:function(n){return(0,o.Z)(f().mark(function e(){var t;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=!1,dsf.config.commonForm.isInterceptMultiPersonSign)return e.next=4,dsf.http.post("fn/office/isLock",{fileId:n}).then(function(e){v.log("isLock-res",e),"error"==e.data.type&&(dsf.layer.alert({message:"当前文件正在由"+e.data.data.uname+"办理，请稍后处理。"},function(){xsfWindow.closeWebView()}),t=!0)});e.next=4;break;case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}},e)}))()},continueLockFile:function(e){dsf.config.commonForm.isInterceptMultiPersonSign&&(this.fileTimer=setInterval(function(){dsf.http.post("fn/office/continueLock",{fileId:e}).then(function(e){v.log(e,"文件定时上锁")})},3e4))},destroyFileInterval:function(e){clearInterval(this.fileTimer),this.fileTimer=null,dsf.config.commonForm.isInterceptMultiPersonSign?dsf.http.post("fn/office/unLock",{fileId:e}).then(function(e){v.log(e,"文件解锁"),xsfWindow.closeWebView()}):xsfWindow.closeWebView()},destroyFileIntervalAll:function(e){clearInterval(fileTimer),fileTimer=null,dsf.config.commonForm.isInterceptMultiPersonSign&&dsf.http.post("fn/office/releaseLock",{pk:e}).then(function(e){v.log(e,"所有文件解锁成功")})},beforeUnload:function(){this.destroyFileInterval(this.FileIds)}},destroyed:function(){}},i=(0,n(51900).Z)(t,function(){var n=this,o=n._self._c;return o("div",{ref:"enclosurePre",staticClass:"dianju"},[n.ifra?o("van-tabs",n._l(n.qydFiles,function(e,t){return o("van-tab",{key:e.id,attrs:{title:e.name}},[o("iframe",{key:e.url,attrs:{frameborder:"0",width:"100%",src:e.url,id:"filePreview"+t},on:{load:function(e){return n.changeFrameHeight(t)}}})])}),1):n._e(),n._v(" "),o("van-popup",{ref:"sendPop",staticStyle:{height:"90vh"},attrs:{"get-container":n.getContainer,"lock-scroll":"",position:"bottom",round:""},on:{close:n.closeSendFilePopup},model:{value:n.showFlowSend,callback:function(e){n.showFlowSend=e},expression:"showFlowSend"}},[o("sendFile",{directives:[{name:"show",rawName:"v-show",value:n.showFlowSend,expression:"showFlowSend"}],ref:"sendFile",attrs:{"form-data":n.fileData,isShowWriteOpintionBtn:!0},on:{change:n.handleFlowSendChange,close:n.closeSendFile}})],1),n._v(" "),o("van-popup",{staticClass:"center",style:{width:"60%"},attrs:{closeable:"",round:"","close-on-click-overlay":!1},on:{"click-close-icon":n.closealertPopup},model:{value:n.showType,callback:function(e){n.showType=e},expression:"showType"}},[o("van-cell-group",[o("van-cell",{attrs:{title:"呈批",clickable:""},on:{click:function(e){return n.sendtype("呈批")}}}),n._v(" "),o("van-cell",{attrs:{title:"阅件",clickable:""},on:{click:function(e){return n.sendtype("阅件")}}}),n._v(" "),o("van-cell",{attrs:{title:"外出报备",clickable:""},on:{click:function(e){return n.sendtype("外出报备")}}}),n._v(" "),o("van-cell",{attrs:{title:"信息",clickable:""},on:{click:function(e){return n.sendtype("信息")}}})],1)],1)],1)},[],!1,null,"68ff7f60",null).exports},18868:function(e,t,n){var s=n(25108);const r=(o,i=500,s=!0)=>{let r,a=0,c,l,d=n=>{r=setTimeout(()=>{var e=(new Date).getTime(),t=e-a;t<n?(a=e,d(i-t)):(s||o.apply(c,l),clearTimeout(r),r=null)},n)};return function(){c=this,l=arguments;var e=(new Date).getTime();a=e,r||(s&&o.apply(c,l),d(i))}};t.Z={name:"DebounceClick",functional:!0,render(e,t){var n,o=t.props.time,i=t.props.immediate,t=t.slots().default;return void 0===t?(s.warn("<debounce> 组件必须要有子元素"),null):((t=t[0]||null).data.on&&t.data.on.click?(n=t.data.on.click,n=r(n,o,i),t.data.on.click=n):t.componentOptions&&t.componentOptions.listeners.click&&(n=t.componentOptions.listeners.click,n=r(n,o,i),t.componentOptions.listeners.click=n),t)}}},79156:function(e,t,n){n.d(t,{Z:function(){return i}});var o=n(78149);function i(e){if(o(e))return e}},26511:function(e,t,n){function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}n.d(t,{Z:function(){return o}})},522:function(e,t,n){n.d(t,{Z:function(){return r}});var o=n(79156),d=n(85579),u=n(22013);var i=n(33422),s=n(26511);function r(e,t){return(0,o.Z)(e)||function(e,t){var n=null==e?null:void 0!==d&&e[u]||e["@@iterator"];if(null!=n){var o,i,s,r,a=[],c=!0,l=!1;try{if(s=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(o=s.call(n)).done)&&(a.push(o.value),a.length!==t);c=!0);}catch(e){l=!0,i=e}finally{try{if(!c&&null!=n.return&&(r=n.return(),Object(r)!==r))return}finally{if(l)throw i}}return a}}(e,t)||(0,i.Z)(e,t)||(0,s.Z)()}}}]);
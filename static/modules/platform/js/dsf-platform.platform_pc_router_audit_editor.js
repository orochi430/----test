/*!
 * Name: @dsf/cli-platform
 * Version: 5.17.0-alpha.5
 * Description: 平台基础包
 * BuildTime: 2024/6/19 17:49:40
*/
(("undefined"!==typeof self?self:this)["webpackJsonpplatform"]=("undefined"!==typeof self?self:this)["webpackJsonpplatform"]||[]).push([[58],{468:function(e,t,a){var i=a(614);"string"===typeof i&&(i=[[e.i,i,""]]),i.locals&&(e.exports=i.locals);var n=a(19).default;n("18813f42",i,!0,{sourceMap:!1,shadowMode:!1})},613:function(e,t,a){"use strict";a(468)},614:function(e,t,a){"use strict";a.r(t)},977:function(e,t,a){"use strict";a.r(t);var i,n,r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"stats-audit-formula-form"},[a("div",{staticClass:"sa-ff-tabs-box"},[a("div",{staticClass:"sa-ff-tabs-head"},[a("el-input",{staticClass:"sa-ff-tabs-head-input",attrs:{placeholder:"请输入内容"},on:{change:e.getAuditFormulaList},model:{value:e.search,callback:function(t){e.search=t},expression:"search"}},[a("el-button",{attrs:{slot:"append",icon:"el-icon-plus"},on:{click:function(t){return t.stopPropagation(),e.addAuditFormula()}},slot:"append"})],1)],1),a("el-tabs",{directives:[{name:"loading",rawName:"v-loading",value:e.listLoading,expression:"listLoading"}],staticClass:"sa-ff-tabs",attrs:{type:"border-card","tab-position":"left"},on:{"tab-click":function(t){return e.tabClick("check")}},model:{value:e.acAuditTabName,callback:function(t){e.acAuditTabName=t},expression:"acAuditTabName"}},e._l(e.auditFormulaTabsList,(function(e){return a("el-tab-pane",{key:e.id||e.$hash,attrs:{label:e.label,name:e.id||e.$hash}})})),1)],1),a("div",{staticClass:"sa-ff-main"},[a("div",{staticClass:"sa-ff-main-box"},[a("DsfFlexibleBox",{attrs:{isClosed:!e.showInfoForm,barWidth:"340px"},scopedSlots:e._u([{key:"bar",fn:function(){return[a("div",{staticClass:"sa-ff-main-base"},[a("div",{staticClass:"sa-ff-from-title"},[e._v("基础信息")]),a("div",{staticClass:"sa-ff-from-box"},[a("el-form",{ref:"form",attrs:{model:e.acAuditFormulaForm,"label-width":"160px"}},[a("el-form-item",{staticClass:"is-required",attrs:{label:"公式标识",error:e.errorMaps[e.getItemKey("flag")]}},[a("el-input",{model:{value:e.acAuditFormulaForm[e.getItemKey("flag")],callback:function(t){e.$set(e.acAuditFormulaForm,e.getItemKey("flag"),t)},expression:"acAuditFormulaForm[getItemKey('flag')]"}})],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"公式中文名称",error:e.errorMaps[e.getItemKey("name")]}},[a("el-input",{model:{value:e.acAuditFormulaForm[e.getItemKey("name")],callback:function(t){e.$set(e.acAuditFormulaForm,e.getItemKey("name"),t)},expression:"acAuditFormulaForm[getItemKey('name')]"}})],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"公式英文名称",error:e.errorMaps[e.getItemKey("english_name")]}},[a("el-input",{model:{value:e.acAuditFormulaForm[e.getItemKey("english_name")],callback:function(t){e.$set(e.acAuditFormulaForm,e.getItemKey("english_name"),t)},expression:"acAuditFormulaForm[getItemKey('english_name')]"}})],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"状态",error:e.errorMaps[e.getItemKey("status")]}},[a("el-radio-group",{on:{change:function(t){return e.selectChange("status")}},model:{value:e.acAuditFormulaForm[e.getItemKey("status")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("status")],"value",t)},expression:"acAuditFormulaForm[getItemKey('status')].value"}},e._l(e.getInitDict("status",[]),(function(t){return a("el-radio",{key:t.value,attrs:{label:t.value}},[e._v(" "+e._s(t.text)+" ")])})),1)],1),a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"is-required",attrs:{label:"公式类型",error:e.errorMaps[e.getItemKey("types")]}},[a("el-radio-group",{on:{change:function(t){return e.selectChange("types")}},model:{value:e.acAuditFormulaForm[e.getItemKey("types")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("types")],"value",t)},expression:"acAuditFormulaForm[getItemKey('types')].value"}},e._l(e.getInitDict("types",[]),(function(t){return a("el-radio",{key:t.value,attrs:{label:t.value}},[e._v(" "+e._s(t.text)+" ")])})),1)],1),a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"is-required",attrs:{label:"子表名称",error:e.errorMaps[e.getItemKey("sub_table")]}},[a("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectChange("sub_table")}},model:{value:e.acAuditFormulaForm[e.getItemKey("sub_table")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("sub_table")],"value",t)},expression:"\n                      acAuditFormulaForm[getItemKey('sub_table')].value\n                    "}},e._l(e.getInitDict("sub_table",[]),(function(e){return a("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1),a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"is-required",attrs:{label:"统计公式用途",error:e.errorMaps[e.getItemKey("used")]}},[a("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectChange("used")}},model:{value:e.acAuditFormulaForm[e.getItemKey("used")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("used")],"value",t)},expression:"acAuditFormulaForm[getItemKey('used')].value"}},e._l(e.getInitDict("used",[]),(function(e){return a("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"统计公式审核方式",error:e.errorMaps[e.getItemKey("audit_method")]}},[a("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectChange("audit_method")}},model:{value:e.acAuditFormulaForm[e.getItemKey("audit_method")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("audit_method")],"value",t)},expression:"\n                      acAuditFormulaForm[getItemKey('audit_method')].value\n                    "}},e._l(e.getInitDict("audit_method",[]),(function(e){return a("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"统计公式权限",error:e.errorMaps[e.getItemKey("permission")]}},[a("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectChange("permission")}},model:{value:e.acAuditFormulaForm[e.getItemKey("permission")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("permission")],"value",t)},expression:"\n                      acAuditFormulaForm[getItemKey('permission')].value\n                    "}},e._l(e.getInitDict("permission",[]),(function(e){return a("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"统计公式强制性类型",error:e.errorMaps[e.getItemKey("mandatory_type")]}},[a("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectChange("mandatory_type")}},model:{value:e.acAuditFormulaForm[e.getItemKey("mandatory_type")].value,callback:function(t){e.$set(e.acAuditFormulaForm[e.getItemKey("mandatory_type")],"value",t)},expression:"\n                      acAuditFormulaForm[getItemKey('mandatory_type')].value\n                    "}},e._l(e.getInitDict("mandatory_type",[]),(function(e){return a("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1),a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"is-required",attrs:{label:"审核字段",error:e.errorMaps[e.getItemKey("audit_fields")]}},[a("el-input",{attrs:{type:"textarea",rows:4,placeholder:"请输入内容"},model:{value:e.acAuditFormulaForm[e.getItemKey("audit_fields")],callback:function(t){e.$set(e.acAuditFormulaForm,e.getItemKey("audit_fields"),t)},expression:"acAuditFormulaForm[getItemKey('audit_fields')]"}})],1),a("el-form-item",{staticClass:"is-required",attrs:{label:"错误提示",error:e.errorMaps[e.getItemKey("hint")]}},[a("el-input",{attrs:{type:"textarea",rows:4,placeholder:"请输入内容"},model:{value:e.acAuditFormulaForm[e.getItemKey("hint")],callback:function(t){e.$set(e.acAuditFormulaForm,e.getItemKey("hint"),t)},expression:"acAuditFormulaForm[getItemKey('hint')]"}})],1)],1)],1)])]},proxy:!0},{key:"default",fn:function(){return[a("div",{staticClass:"sa-ff-main-right"},[a("div",{staticClass:"sa-ff-from-head"},[a("div",{staticClass:"sa-ff-from-title"},[e._v("审核编辑")]),a("div",{staticClass:"sa-ff-from-tabs-box"},[a("div",{staticClass:"sa-ff-from-tabs-box_inner"},[a("el-tabs",{staticClass:"sa-ff-from-tabs",attrs:{value:e.acTable&&e.acTable[e.nameSpaceKey],type:"card",addable:""},on:{"tab-remove":e.removeTable,"tab-add":e.addTablePage,"tab-click":e.tableChange}},e._l(e.tableList,(function(t){return a("el-tab-pane",{key:t[e.nameSpaceKey],attrs:{label:t.label,name:t[e.nameSpaceKey],closable:!t.hideClosable}})})),1)],1)])]),a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.viewpartLoading,expression:"viewpartLoading"}],staticClass:"sa-ff-report-box"},e._l(e.tableList,(function(t){return a("DsfReportFormPickUp",{directives:[{name:"show",rawName:"v-show",value:e.acTable&&e.acTable[e.nameSpaceKey]==t[e.nameSpaceKey],expression:"\n                  acTable && acTable[nameSpaceKey] == table[nameSpaceKey]\n                "}],key:t[e.nameSpaceKey],ref:"reportForm-"+t[e.nameSpaceKey],refInFor:!0,staticClass:"sa-ff-report-viewpart",attrs:{path:e.reportFormUrl(t),hasExtJs:!0},on:{dblclickFormControl:e.dblclickFormControl,ready:function(a){return e.initProxyReportFormItems(t,a)}}})})),1),a("div",{staticClass:"sa-ff-code-edit"},[a("el-tabs",{attrs:{value:e.activeEdit},on:{"tab-click":e.editTabClick}},[a("el-tab-pane",{attrs:{label:"伪代码",name:"PseudoCode"}}),a("el-tab-pane",{attrs:{label:"Python",name:"Python"}}),a("el-tab-pane",{attrs:{label:"JavaScript",name:"JavaScript"}},[a("template",{slot:"label"},[a("span",{staticStyle:{"margin-right":"6px"}},[e._v("JavaScript")]),a("el-popover",{attrs:{placement:"bottom",title:"使用帮助",width:"auto",trigger:"hover"}},[a("dsf-icon",{attrs:{slot:"reference",name:"icon_yiwenkongxin"},slot:"reference"}),a("div",{staticStyle:{width:"auto",height:"300px",overflow:"auto"}},[a("span",{staticStyle:{"white-space":"pre"}},[e._v(" "+e._s(e.jsTemplate)+" ")])])],1)],1)],2)],1),a("div",{staticClass:"sa-ff-code-edit-context"},[a("DsfMonacoCustom",{ref:"editor",attrs:{theme:"vs",model:e.activeEdit,language:e.acEditLanguage,editText:e.acEditText,loadTip:e.loadTip,loadTipCustom:e.loadTipCustom,loadHover:{isOpen:!0,hoverCb:e.hoverChange,language:["python","javascript"]},cancelJsCompletionItems:"PseudoCode"==e.activeEdit,config:e.config,suggestionSelectCallBack:e.suggestionSelectCallBack,turnOnBlock:!0,cancelJsDiagnostics:!0,customBlockStyle:e.customBlockStyle},on:{editLoaded:e.editLoaded}})],1)],1)])]},proxy:!0}])})],1),a("div",{staticClass:"sa-ff-main-bottom"},[a("DsfButton",{on:{click:e.verify}},[e._v("验证")]),a("DsfButton",{on:{click:e.save}},[e._v("保存")]),a("DsfButton",{attrs:{type:"plain"},on:{click:e.closePage}},[e._v("取消")])],1)])])},s=[],o=a(4),l=a.n(o),u=a(2),c=a.n(u),d=a(3),m=a.n(d),f=a(1),h=a.n(f),p='/**\r\n * #基本参数\r\n * $main 表单数据  \r\n * $main["form_key"] form_key是表单字段\r\n * $key 当前校验的字段\r\n * $val 当前校验的值\r\n * \r\n * #以下参数子表内组件才有\r\n * $row 当前组件所在字表行的数据\r\n * $index 当前组件所在字表行下标\r\n * \r\n *\r\n * 同步\r\n * 最后需要 return 一个 true 或 false\r\n * \r\n * 异步\r\n * return new Promise(function (resolve) {\r\n    // ... 异步代码\r\n\r\n    // 返回结果\r\n    resolve(true||false)\r\n })\r\n */\r\n//示例：例如判断当前文本框中值是否为abc\r\n//return $viewData["form_key"] == \'abc\'',v="​",g={SUM:[K],AVG:[K],MIN:[K],MAX:[K],SUMIFAND:[I],CASE:[C]};function y(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=i(e).body;return t&&(a=a.map((function(e){if("ExpressionStatement"==e.type)return e.expression}))),a.length>1?a:a[0]}function b(e,t){return estraverse.replace(e,{enter:function(e){if("CallExpression"==this.type()&&"get_main"==e.callee.name){var a=A(e,t),i="($viewData ".concat(a.expand?'&& $viewData["'.concat(a.tableName,".").concat(a.code,'"]'):"",' ? $viewData["').concat(a.tableName,".").concat(a.code,'"]').concat(a.expand?".".concat(a.expand):""," : undefined)");return"number"==a.type&&(i="TONUMBER(".concat(i,")")),y(i)}}})}function F(e,t){return estraverse.replace(e,{enter:function(e){if("CallExpression"==this.type()&&"get_row"==e.callee.name){var a=S(e,t),i="($row ".concat(a.expand?'&& $row["'.concat(a.tableName,".").concat(a.code,'"]'):"",' ? $row["').concat(a.tableName,".").concat(a.code,'"]').concat(a.expand?".".concat(a.expand):""," : undefined)");return"number"==a.type&&(i="TONUMBER(".concat(i,")")),y(i)}}})}function x(e,t){return estraverse.replace(e,{enter:function(e){if("CallExpression"==this.type()&&"get_row"==e.callee.name){var a=S(e,t),i="($loop_row ".concat(a.expand?'&& $loop_row["'.concat(a.tableName,".").concat(a.code,'"]'):"",' ? $loop_row["').concat(a.tableName,".").concat(a.code,'"]').concat(a.expand?".".concat(a.expand):""," : undefined)");return"number"==a.type&&(i="TONUMBER(".concat(i,")")),y(i)}}})}function K(e,t,a){estraverse.replace(e,{enter:function(e,t){if("CallExpression"==this.type()){if("get_main"==e.callee.name)return b.call(this,e,a);if("get_row"==e.callee.name){var i=S(e,a),n=i.tableName,r=i.code,s=i.type,o=i.expand;return y("get_sub_table_field(".concat(JSON.stringify({tableName:n,code:r,type:s,expand:o}),").value"))}}}})}function C(e){for(var t=0;t<e.arguments.length;t++){var a=e.arguments[t];if("FunctionDeclaration"!==a.type&&"ArrowFunctionExpression"!==a.type){var i=w(a);i&&e.arguments.splice(t,1,i)}}return y("\n  (function _CASE_FN(){\n    let args = Array.from(arguments)\n    let i = 0\n    while (i < args.length) {\n      let [caseFn,thenFn] = args.slice(i,i+2);\n      if (!thenFn) {\n        return caseFn()\n      } else {\n        if (caseFn()) {\n          return thenFn()\n        }\n      }\n      i += 2\n    }\n  })(".concat(e.arguments.map((function(e){return n(e)})).join(","),")\n"))}function I(e,t,a){var i;if(estraverse.replace(e,{enter:function(e){if("CallExpression"==this.type()){var t=e.callee.name;if("get_main"==t)return b.call(this,e,a);if("get_row"==t){var n=S(e,a);if(n.tableName){if(i&&i!=n.tableName)throw new Error("SUMIFAND 函数中不能出现多子表字段");i=n.tableName}return x.call(this,e,a)}}}}),!i)throw new Error("SUMIFAND 函数中必须要有子表字段");return y('\n    (function _SUMIFAND_FN(){\n      var table = get_sub_table("'.concat(i,'");\n      var sum = [];\n      if(').concat(!!e.arguments[1],"){\n        table.forEach(function(row){\n          var $loop_row = row;\n          var state = (").concat(n(e.arguments[0]),");\n          if (state) {\n            sum.push(").concat(n(e.arguments[1]),")\n          }\n        });\n      }\n      return SUM(sum)\n    }).call(this)\n  "))}function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"_invalid_fn";return i("function ".concat(t,"(){ return (").concat(n(e),")}")).body[0]}function S(e,t){var a={tableName:e.arguments[0].value,code:e.arguments[1].value},i=N(a,t),n=i.relation,r=i.type,s=i.expand;return a.relation=n,a.type=r,a.expand=s,a}function A(e,t){var a={tableName:e.arguments[0].value,code:e.arguments[1].value},i=N(a,t),n=i.relation,r=i.type,s=i.expand;return a.relation=n,a.type=r,a.expand=s,a}function N(e,t){var a,i,n,r=t.find((function(t){return t.id=="".concat(e.tableName,".").concat(e.code)})),s="string";return null===r||void 0===r||null===(a=r.valueAttributes)||void 0===a||a.forEach((function(e){var t;"value"==e.code&&(n="text"),"number"==(null===e||void 0===e||null===(t=e.type)||void 0===t?void 0:t.value)&&(i=!0)})),i&&(s="number"),{relation:r,type:s,expand:n}}function $(e,t){try{var a,r;i=null===(a=esprima)||void 0===a?void 0:a.parseScript,n=null===(r=escodegen)||void 0===r?void 0:r.generate,t=_.cloneDeep(t);var s=i(e);return estraverse.replace(s,{enter:function(e,a){var i=this.type();if("CallExpression"==i){var n=e.callee.name;if(g[n])return g[n][0].call(this,e,a,t);if("get_main"==n)return b.call(this,e,t);if("get_row"==n)return F.call(this,e,t)}}}),n(s)}catch(o){throw dsf.layer.message(o.message,!1),o}}function T(e,t){var a=e,i=new RegExp("( ?".concat(v,".*?").concat(v," ?)")),n=[],r=[];while(i.test(a))a=a.replace(i,(function(e){var a=_.cloneDeep(k(t,e));return a?(delete a._showNameList,!n.find((function(e){return e.showName===a.showName}))&&n.push(a),L(a)):(r.push(e),"")}));return{str:a,fieldRelationList:n,fieldRelationLoss:r.join(",")}}function k(e,t){for(var a in e){var i=e[a];if(i.showName.trim()==t.trim())return i}}function L(e){var t="get_main(";return e.isSubTable&&(t="get_row("),t+='"'.concat(e.tableName,'","').concat(e.code,'")'),t}var E="dsfa_formula";function M(){var e,t,a;return a={$hash:dsf.uuid()},m()(m()(m()(m()(m()(m()(m()(m()(m()(m()(a,E+".flag",""),E+".name","公式名称"),E+".table_name",""),E+".table_code",""),E+".english_name",""),E+".pseudo_code_explain","[]"),E+".pseudo_code",""),E+".content",""),E+".content_python",""),E+".content_js","return true;"),m()(m()(m()(m()(m()(m()(m()(m()(m()(m()(a,E+".content_execute_js","return true;"),E+".business_id",""),E+".hint",""),E+"_cross",[]),E+".types",{text:"",value:""}),E+".used",{text:"",value:""}),E+".audit_method",{text:"上报审核",value:"2"}),E+".permission",{text:"共用公式",value:"2"}),E+".mandatory_type",{text:"强制性",value:"1"}),E+".status",{text:"启用",value:"0"}),m()(m()(m()(m()(a,E+".source",{text:null===(e=this.$route.query)||void 0===e?void 0:e.sourceName,value:null===(t=this.$route.query)||void 0===t?void 0:t.source}),E+".audit_fields",""),E+".sub_table",{text:"",value:""}),E+"_fields",[])}var D=dsf.component({name:"DsfStatsAuditFormulaForm",ctrlCaption:"审核公式维护",components:{},mixins:[$mixins.control],data:function(){return{showInfoForm:!0,$tableList:[],viewpartLoading:!1,acTableName:void 0,activeEdit:"PseudoCode",search:"",auditFormulaList:[],initData:{},initPrefix:E,acAuditTabName:null,nameSpace:"dsfa.formula",pageName:"edit",addAuditFormulaList:[],errorMaps:{},listLoading:!1,acAuditFormulaForm:M.call(this),editorInstance:null,loadTip:{type:"local",isOpenTip:!0,localLanguage:["javascript","python"]},config:{minimap:{enabled:!1}}}},computed:{acTable:function(){var e=this;return this.acTableName&&this.tableList.find((function(t){return t[e.nameSpaceKey]==e.acTableName}))||null},acAuditFormulaFormCrossList:function(){var e,t=this.getItemKey("cross","_");return(null===(e=this.acAuditFormulaForm)||void 0===e?void 0:e[t])||[]},tableList:function(){var e=this,t=this.queryString,a=[m()(m()(m()(m()(m()({label:"(".concat((null===t||void 0===t?void 0:t.t_num)||"",")").concat((null===t||void 0===t?void 0:t.t_title)||"当前主表")},this.getCrossSubKey("namespace"),null===t||void 0===t?void 0:t.n),this.getCrossSubKey("page_name"),null===t||void 0===t?void 0:t.p),this.getCrossSubKey("name"),null===t||void 0===t?void 0:t.t_title),this.getCrossSubKey("table_code"),null===t||void 0===t?void 0:t.t_num),"hideClosable",!0)].concat(c()(this.acAuditFormulaFormCrossList)).filter((function(t){return 1!=t[e.getCrossSubKey("ds_deleted")]}));return a},acEditText:function(){return this.acAuditFormulaForm[this.acEditTextKey]},acEditTextKey:function(){var e=this.activeEdit,t=this.getItemKey;return t("Python"==e?"content_python":"PseudoCode"==e?"pseudo_code":"content_js")},acEditLanguage:function(){return"python"==this.activeEdit?"python":"javascript"},jsTemplate:function(){return p},auditFormulaTabsList:function(){var e=this;return this.auditFormulaList.map((function(e){return{id:e.id,$hash:e.$hash,label:e["name"]}})).concat(this.addAuditFormulaList.map((function(t){return{id:t.id,$hash:t.$hash,label:t[e.getItemKey("name")]}})))},acNameSpace:function(){var e;return this.acTable?e=this.acTable[this.nameSpaceKey]:this.queryString.n&&(e=this.queryString.n),e},acPageName:function(){var e;return this.acTable?e=this.acTable[this.pageNameKey]:this.queryString.p&&(e=this.queryString.p),e},nameSpaceKey:function(){return this.getCrossSubKey("namespace")},pageNameKey:function(){return this.getCrossSubKey("page_name")}},watch:{auditFormulaList:{immediate:!0,handler:function(e){var t=this;_.each(e,(function(e,a){t.$set(e,"$order",a)}))}}},methods:{customBlockStyle:function(e){e=dsf.isString(e)?e:e.value;var t="editor-custom-block-error",a=this.getFieldRelationInShowName("".concat(v).concat(e).concat(v));a&&(t="editor-custom-block");var i={inlineClassName:t,stickiness:monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,description:e};return i},dblclickFormControl:function(e){var t=e.args,a=this.acAuditFormulaForm[this.getItemKey("audit_fields")];if(a=a?new Set(a.split(",")):new Set,!this.metadataDict)return console.error(new Error("找不到metadataDict"));var i=t.metadata;if(i){var n=this.getFieldRelationInId(i.dataKey);if(!n)return dsf.layer.message("没有找到对应关联描述数据",!1);if(n.isCrossTable&&"JavaScript"==this.activeEdit)return dsf.layer.message("JavaScript不支持跨表验证",!1);a.add(n.id),this.$refs.editor.addCode(n.showName.replace(new RegExp("(".concat(v,")"),"g"),""),"focus",{isAddBlock:!0}),this.$set(this.acAuditFormulaForm,this.getItemKey("audit_fields"),Array.from(a).join(",")),dsf.layer.message("【".concat(n.showName,"】代码已插入到编辑器中"))}},reportFormUrl:function(e){var t=e[this.nameSpaceKey],a=e[this.pageNameKey];return t&&a?"".concat(t.replace(/\./g,"/"),"/").concat(a):""},getCrossSubKey:function(e){return"".concat(this.getItemKey("cross","_"),".").concat(e)},addTablePage:function(){var e=this;dsf.layer.openDialog({title:"新增报表",width:"1200px",height:"70vh",params:{path:"#/pc/dsbi/md/report/hqbb"},btns:[{text:"确定",handler:function(t){var a,i=R((null===t||void 0===t||null===(a=t.$refs)||void 0===a||null===(a=a.view)||void 0===a||null===(a=a.$refs)||void 0===a||null===(a=a.datagrid2)||void 0===a?void 0:a.multipleSelection)||[]),n=e.acAuditFormulaFormCrossList;return i=i.map((function(t){return m()(m()(m()(m()({_id:t._id,label:"(".concat(t.stat_tab_number,")").concat(t.name)},e.getCrossSubKey("name"),t.name),e.getCrossSubKey("table_code"),t.stat_tab_number),e.pageNameKey,t.pagename),e.nameSpaceKey,t.namespace)})).filter((function(t){var a=n.findIndex((function(a){return a[e.nameSpaceKey]==t[e.nameSpaceKey]}));if(a<0)return!0;delete n[a][e.getCrossSubKey("ds_deleted")]})),n.push.apply(n,c()(i)),!0}},{text:"取消",handler:function(){}}]})},removeTable:function(e){var t=this,a=this.tableList.find((function(a){return a[t.nameSpaceKey]==e}));a&&(this.$set(a,this.getCrossSubKey("ds_deleted"),1),a[this.nameSpaceKey]==this.acTableName&&this.tableChange({name:this.tableList[0][this.nameSpaceKey]}))},tableChange:function(e){this.acTableName=e.name},hoverChange:function(e,t,a){var i=new RegExp(" ?".concat(v,".*?").concat(v," ?")),n=i.exec(a),r=0;while(n){if(r+n.index<=t.column&&t.column<=r+n.index+n[0].length)break;r+=n.index+n[0].length,n=i.exec(n.input.substring(n.index+n[0].length))}var s=[];if(!n)return{contents:s};var o=n[0];if(o){var l=this.getFieldRelationInShowName(o);if(l){var u=l.isSubTable,c=l.isCrossTable,d=l.reportCode,m=[];m.push("表类型："+(c?"关联表-":"")+(u?"子表":"主表")),m.push("主表名称："+(l.reportName||l.pageTite)),d&&m.push("主表表号："+d),m.push("主表名："+l.nameSpace),u&&m.push("子表名："+l.tableCode),s.push({value:"```javascript\n"+m.join("\n")+"\n```"}),s.push({value:"```javascript\n"+["字段名称："+l.name,"字段名："+l.code].join("\n")+"\n```"})}else s.push({value:"```javascript\n"+o+"字段丢失，请重新选择\n```"})}return{contents:s}},buildMetadataDictTree:function(e,t,a){if(a){var i={},n=this.queryString.n;for(var r in a){var s=a[r];if("field"==s.type){var o=q.call(this,s,e,t,n);i[o.id]=o}}this.fieldRelationMap=Object.assign({},this.fieldRelationMap||{},i);var l={};Object.values(this.fieldRelationMap).forEach((function(e){var t=e.showName;l[t]||(l[t]=[]),l[t].push(e)})),Object.values(l).forEach((function(e){e.length>1&&e.forEach((function(e){e.orgin_showName=e.showName,e._showNameList[e._showNameList.length-2]=e._showNameList[e._showNameList.length-2].replace(/^\[(.*)\]$/,"[$1(".concat(e.code,")]")),e.showName=e._showNameList.join("")}))}))}},getFieldRelationInId:function(e){for(var t in this.fieldRelationMap)if(this.fieldRelationMap[t].id==e)return this.fieldRelationMap[t];return null},getFieldRelationInShowName:function(e){for(var t in this.fieldRelationMap)if(this.fieldRelationMap[t].showName.trim()==e.trim())return this.fieldRelationMap[t];return null},loadTipCustom:function(e,t,a){var i=[],n={suggestions:i},r=this.fieldRelationMap;if(!r)return n;var s=t.column,o=t.column;while(o>0&&" "!==a.charAt(o)&&"("!==a.charAt(o)&&")"!==a.charAt(o))o--;var l=a.slice(o,s-o),u=l.split(".");if(u.length>1)return n;for(var c in r){var d=r[c];if(d.name.includes(l)||d.code.includes(l)){var m={label:d.tipLabel,kind:monaco.languages.CompletionItemKind.Field,insertText:d.showName,filterText:d.tipLabel.replace(/\s/g,"").replace(/[\u4e00-\u9fa5\w$ ]/g,"$&-"),command:{id:"editor.suggest"}};i.push(m)}}return this.dsfFormula.customFuctionList.forEach((function(e){if(0==e[0].indexOf(l)||e[1].indexOf(l)>=0){var t="".concat(e[0],"(").concat(e[1],")"),a={label:t,kind:monaco.languages.CompletionItemKind.Function,insertText:e[0],filterText:t.replace(/\s/g,"").replace(/[\u4e00-\u9fa5\w$ ]/g,"$&-"),command:{id:"editor.suggest"}};i.push(a)}})),n},suggestionSelectCallBack:function(){this.handleParseZero2decoration()},editLoaded:function(e){this.isEditLoaded=!0,this.editorInstance=e,this.$refs.editor.setValue(this.acEditText||"")},handleParseZero2decoration:function(){this.isEditLoaded&&this.$refs.editor.handleParseZero2decoration()},getContentKey:function(e){return e||(e=this.activeEdit),"Python"==e?this.getItemKey("content_python"):"PseudoCode"==e?this.getItemKey("pseudo_code"):this.getItemKey("content_js")},editTabClick:function(e){var t=e.name,a=this.activeEdit;this.$set(this.acAuditFormulaForm,this.getContentKey(this.activeEdit),this.$refs.editor.getValue()||""),this.activeEdit=t,this.$refs.editor.addModel(t,this.acEditLanguage,this.acEditText||"",a)},tabClick:function(e){var t=this;return l()(h.a.mark((function a(){var i,n,r,s,o;return h.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if("check"==e&&(t.isEdit=!0),t.errorMaps={},n=M.call(t),r=function(){if(t.isEditLoaded){var e,a,i,n,r,s;null===(e=t.$refs.editor.editModels)||void 0===e||null===(e=e["Python"])||void 0===e||null===(e=e.model)||void 0===e||null===(a=e.setValue)||void 0===a||a.call(e,t.acAuditFormulaForm[t.getContentKey("Python")]||""),null===(i=t.$refs.editor.editModels)||void 0===i||null===(i=i["PseudoCode"])||void 0===i||null===(i=i.model)||void 0===i||null===(n=i.setValue)||void 0===n||n.call(i,t.acAuditFormulaForm[t.getContentKey("PseudoCode")]||""),null===(r=t.$refs.editor.editModels)||void 0===r||null===(r=r["JavaScript"])||void 0===r||null===(r=r.model)||void 0===r||null===(s=r.setValue)||void 0===s||s.call(r,t.acAuditFormulaForm[t.getContentKey("JavaScript")]||"");var o=t.$refs.editor.editModels[t.activeEdit].model;t.editorInstance.setModel(o),t.$refs.editor.handleParseZero2decoration()}},s=t.auditFormulaList.find((function(e){return e.id==t.acAuditTabName||e.$hash==t.acAuditTabName})),null===(i=s)||void 0===i||!i.id){a.next=8;break}return t.getTabFormData(null===(o=s)||void 0===o?void 0:o.id).done((function(e){if(e.success){var a,i=e.data||{},n=t.getItemKey("content");i[n]&&(i[n]=i[n].replace(/\u200d/g,v));var s=t.getItemKey("content_python");i[s]||(i[s]=""),j(i,t.getItemKey("content")),j(i,t.getItemKey("pseudo_code")),j(i,t.getItemKey("pseudo_code_explain")),j(i,t.getItemKey("content_python")),j(i,t.getItemKey("content_js")),j(i,t.getItemKey("content_execute_js"));var o=t.getItemKey("cross","_");null!==(a=i[o])&&void 0!==a&&a.length?i[o]=i[o].map((function(e){return e.label="(".concat(e[t.getCrossSubKey("table_code")],")").concat(e[t.getCrossSubKey("name")]),e})):i[o]=[],t.$set(t,"acAuditFormulaForm",i),r()}})),a.abrupt("return");case 8:if(s=t.addAuditFormulaList.find((function(e){return e.$hash==t.acAuditTabName})),!s){a.next=13;break}return t.acAuditFormulaForm=s,r(),a.abrupt("return");case 13:t.acAuditFormulaForm=n,r();case 15:case"end":return a.stop()}}),a)})))()},addAuditFormula:function(){var e=m()({},E+".name","公式名称"),t=this.getInitDict("status",[]);t.length&&(e[E+".status"]={text:t[0].text,value:t[0].value});var a=this.getInitDict("types",[]);a.length&&(e[E+".types"]={text:a[0].text,value:a[0].value});var i=Object.assign(M.call(this),e);this.addAuditFormulaList.push(i),this.acAuditTabName=i.$hash,this.tabClick()},getItemKey:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".";return this.initPrefix+t+e},getInitDict:function(e,t){var a;return(null===(a=this.initData)||void 0===a||null===(a=a[this.getItemKey(e)])||void 0===a?void 0:a.dataSource)||t},getInit:function(){var e=this;dsf.http.get("/meta/init",{pageName:this.pageName,namespace:this.nameSpace}).done((function(t){e.initData=t.data||{},e.getSubTable()}))},validate:function(){var e,t,a,i=this.getItemKey,n=this.acAuditFormulaForm,r={};return n[i("flag")]||(r[i("flag")]="请输入公式标识"),n[i("name")]||(r[i("name")]="请输入公式中文名称"),n[i("english_name")]||(r[i("english_name")]="请输入公式英文名称"),null!==(e=n[i("permission")])&&void 0!==e&&e.value||(r[i("permission")]="请选择统计公式权限"),null!==(t=n[i("audit_method")])&&void 0!==t&&t.value||(r[i("audit_method")]="请选择统计公式审核方式"),null!==(a=n[i("mandatory_type")])&&void 0!==a&&a.value||(r[i("mandatory_type")]="请选择统计公式强制性类型"),n[i("hint")]||(r[i("hint")]="请输入错误提示"),this.errorMaps=r,Object.keys(this.errorMaps).length>0},updateEditText:function(){this.$set(this.acAuditFormulaForm,this.acEditTextKey,this.$refs.editor.getValue()||"")},save:function(e){var t=this;this.updateEditText();var a,i,n=this.acAuditFormulaForm[this.getItemKey("pseudo_code")];if(n){if(a=T(n,this.fieldRelationMap),a.fieldRelationLoss)return dsf.layer.message("".concat(a.fieldRelationLoss,"字段丢失，请重新选择"),!1);var r,s=!!a.fieldRelationList.find((function(e){return e.nameSpace!=t.queryString.n}));if(s)i="return true;";else i=$(a.str,a.fieldRelationList),i="return (".concat((null===(r=i)||void 0===r?void 0:r.replace(/\;$/,""))||"true",")")}else{if(n=this.acAuditFormulaForm[this.getItemKey("content_js")],a=T(n,this.fieldRelationMap),a.fieldRelationLoss)return dsf.layer.message("".concat(a.fieldRelationLoss,"字段丢失，请重新选择"),!1);a.str&&(i=$("(function(){".concat(a.str,"}).call(this)"),a.fieldRelationList)),i="return ".concat(i||"true")}this.$set(this.acAuditFormulaForm,this.getItemKey("content_execute_js"),i),this.$set(this.acAuditFormulaForm,this.getItemKey("pseudo_code_explain"),JSON.stringify(a.fieldRelationList||[]));var o=this.acAuditFormulaForm,l=this.validate();if(l)dsf.layer.message("请检查数据是否填写完整",!1);else{o[this.getItemKey("business_id")]||(o[this.getItemKey("business_id")]=this.$route.query.bid),this.$set(o,this.getItemKey("page_name"),this.$route.query.p),this.$set(o,this.getItemKey("namespace"),this.$route.query.n),o=_.cloneDeep(o),o[this.getItemKey("cross","_")].forEach((function(e){delete e.label})),o[this.getItemKey("table_name")]=this.queryString.t_title,o[this.getItemKey("table_code")]=this.queryString.t_num;var u=o.$hash;delete o.$hash;var c={namespace:this.nameSpace,pageName:this.pageName,data:JSON.stringify(o),attach:JSON.stringify({})},d=dsf.url.queryStringStringify(this.queryString),m="/meta/persistData".concat(d?"?"+d:""),f=dsf.layer.loading();dsf.http.post(m,c).done((function(e){if(e&&e.success){var a,i;dsf.layer.message("保存成功");var n=t.addAuditFormulaList.findIndex((function(e){return u==e.$hash}));n>=0&&t.addAuditFormulaList.splice(n,1),t.acAuditTabName=null===e||void 0===e||null===(a=e.data)||void 0===a?void 0:a._id,t.getAuditFormulaList();var r=null===(i=window)||void 0===i||null===(i=i.opener)||void 0===i||null===(i=i.openerVms)||void 0===i?void 0:i[window.name];r&&r.reloadData&&r.reloadData()}else dsf.layer.message(e.message,!1)})).finally((function(){dsf.layer.closeLoading(f)}))}},getAuditFormulaList:function(){var e=this;return this.listLoading=!0,dsf.http.get("/formula/queryListByBusiness",{pageNum:1,pageSize:2e4,keywords:this.search,source:this.$route.query.source||"",businessId:this.$route.query.bid||"",namespace:this.nameSpace,pageName:this.pageName}).done((function(t){var a;t.success?((a=e.auditFormulaList).splice.apply(a,[0,e.auditFormulaList.length].concat(c()(t.data||[]))),e.isEdit||(e.addAuditFormulaList.length?e.acAuditTabName=e.addAuditFormulaList[e.addAuditFormulaList.length-1].$hash||e.addAuditFormulaList[e.addAuditFormulaList.length-1].id:e.addAuditFormula()),e.isEdit=!1):dsf.layer.message(t.message,!1)})).finally((function(){e.tabClick(),e.listLoading=!1}))},getSubTable:function(){var e=this;dsf.http.get("/formula/getTableInfo",{namespace:this.$route.query.n,pageName:this.$route.query.p}).done((function(t){e.initData[e.getItemKey("sub_table")]={dataSource:(t.data.subTable||[]).map((function(e){return{value:e.code,text:e.name}}))}}))},selectChange:function(e){var t=this.getInitDict(e,[]),a=this.acAuditFormulaForm[this.getItemKey(e)].value,i=t.find((function(e){return e.value==a}));i&&(this.acAuditFormulaForm[this.getItemKey(e)].text=i.text)},closePage:function(){window.close()},initProxyReportFormItems:function(e,t){var a=t.args,i=a.viewPart.content;try{var n=["DsfButtonBar"];for(var r in i.$refs){var s=i.$refs[r];n.includes(s.ctrlName)&&s.$emit("update:visible",!1)}}catch(o){console.error(o)}this.metadataDict=i.metadataDict,this.buildMetadataDictTree(e,i.$page.title,i.metadataDict),this.handleParseZero2decoration()},getTabFormData:function(e){return dsf.http.get("meta/data",{namespace:"dsfa.formula",pageName:"edit",id:e,data:JSON.stringify({_id:e})},!0)},verify:function(){var e,t="";this.updateEditText(),t="Python"==this.activeEdit?this.acAuditFormulaForm[this.getItemKey("content_python")]:this.acAuditFormulaForm[this.getItemKey("pseudo_code")];var a=dsf.layer.loading();dsf.http.post("/formula/check",{content:null===(e=t)||void 0===e?void 0:e.replace(new RegExp(v,"g"),"")}).done((function(e){if(e&&e.success&&e.data.status)dsf.layer.message("验证成功");else{var t,a=e.message;null!==e&&void 0!==e&&null!==(t=e.data)&&void 0!==t&&null!==(t=t.message)&&void 0!==t&&t.length&&(a=e.data.message.join("</br>")),dsf.layer.message(a,!1)}})).catch((function(e){dsf.layer.message((null===e||void 0===e?void 0:e.message)||"未知异常",!1)})).finally((function(){dsf.layer.closeLoading(a)}))}},created:function(){var e=this;return l()(h.a.mark((function t(){var a;return h.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,dsf.formula;case 2:return e.dsfFormula=t.sent,e.$route.query.id&&(e.isEdit=!0,e.acAuditTabName=e.$route.query.id),e.queryString.n&&(e.acTableName=e.queryString.n),a=dsf.layer.loading(),t.next=8,e.$http.importFiles([dsf.url.getWebPath("$/js/libs/esprima/esprima.browser.min.js"),dsf.url.getWebPath("$/js/libs/esprima/estraverse.browser.min.js"),dsf.url.getWebPath("$/js/libs/esprima/escodegen.browser.min.js")]).catch((function(){dsf.layer.message("伪代码转换器加载失败",!1)})).finally((function(){dsf.layer.closeLoading(a)}));case 8:return t.next=10,e.getAuditFormulaList();case 10:e.getInit();case 11:case"end":return t.stop()}}),t)})))()},mounted:function(){return l()(h.a.mark((function e(){return h.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},design:{isMask:!0,fit:!0}});function R(e){return(null===e||void 0===e?void 0:e.map((function(e){var t={};for(var a in e)if(!["$buttons","$allowClick","$editing"].includes(a)){var i=a.split(".");t[i[1]||i[0]]=e[a]}return t})))||[]}function q(e,t,a,i){var n={};n.id=e.id,n.code=e.id.split(".")[1],n.pageTite=a,n.nameSpace=t[this.getCrossSubKey("namespace")],n.pageName=t[this.getCrossSubKey("page_name")],n.reportName=t[this.getCrossSubKey("name")],n.reportCode=t[this.getCrossSubKey("table_code")],n.tableName=e.id.split(".")[0],n.tableCode="",n.isSubTable=!!e.inSubTable,n.isCrossTable=n.nameSpace!=i,n.tipLabel="".concat(e.name,"(").concat(e.id,")"),n.name=e.name,n.order=e.order;var r=[v];n.type=e.type,n.valueAttributes=Object.values(e.valueAttributesDetail||{}),n.isCrossTable&&r.push("R(".concat(t[this.getCrossSubKey("table_code")],")")),n.isSubTable&&(n.tableCode=n.tableName.replace("".concat(n.nameSpace.replace(/\./g,"_"),"_"),""),r.push("T(".concat(n.tableCode,")")));var s=n.name||n.code;return r.push("[".concat(s,"]")),r.push(v),n._showNameList=r,n.showName=n._showNameList.join(""),n}function j(e,t){e[t]&&(e[t]=e[t].replace(/\u200d/g,v))}var P=D,O=(a(613),a(0)),B=Object(O["a"])(P,r,s,!1,null,null,null);t["default"]=B.exports}}]);
//# sourceMappingURL=../../../smap/platform/dsf-platform.platform_pc_router_audit_editor.js.map
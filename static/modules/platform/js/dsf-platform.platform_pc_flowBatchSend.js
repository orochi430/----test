/*!
 * Name: @dsf/cli-platform
 * Version: 5.17.0-alpha.5
 * Description: 平台基础包
 * BuildTime: 2024/6/19 17:49:40
*/
(("undefined"!==typeof self?self:this)["webpackJsonpplatform"]=("undefined"!==typeof self?self:this)["webpackJsonpplatform"]||[]).push([[42],{941:function(e,t,n){"use strict";n.r(t);var i=n(3),s=n.n(i),o=n(8),l=n.n(o),a=n(4),r=n.n(a),d=n(1),u=n.n(d),c={flowSend:function(e,t,n){var i=this,s=t.targetButton,o=t._self,l=s.line,a=s.completed,r=this.$vm.flows.flowInfo;if(r){var d=r.chooseFlow.dsfa_rm_id;if(d){var u,c,f,v=Object.assign({},dsf.removePoint(this.$vm.$viewData),this.$route.query),h="wfr/batchStartSend",p={sObjects:JSON.stringify(n),sWFID:d,sCurNodeID:"",sExInfos:JSON.stringify(v)};if(this.$route.query.sPID||o.$vm.$dialog||this.queryString.sPID){h="wfr/batchSend";var m=[];n.forEach((function(e){m.push({PID:o.$vm.$dialog?e.sPID:i.$route.query.sPID||i.queryString.sPID,LinkID:o.$vm.$dialog?e.sCurLinkID:i.$route.query.sCurLinkID||i.queryString.sCurLinkID})})),p.sObjects=JSON.stringify(m)}null!==(u=this.$vm)&&void 0!==u&&null!==(u=u.flows)&&void 0!==u&&null!==(u=u.disposeIdea)&&void 0!==u&&u.sOpinion&&(p.sOpinion=JSON.stringify(this.$vm.flows.disposeIdea.sOpinion)),(null!==(c=this.$vm)&&void 0!==c&&null!==(c=c.flows)&&void 0!==c&&null!==(c=c.sOpinion)&&void 0!==c&&c.Content||(null===(f=this.$vm)||void 0===f||null===(f=f.flows)||void 0===f||null===(f=f.sOpinion)||void 0===f||null===(f=f.Attachments)||void 0===f?void 0:f.length)>0)&&(p.sOpinion=JSON.stringify(this.$vm.flows.sOpinion)),l&&(p.sLineIDs=l.LineID);var g={param:p,url:h};dsf.http.post(g.url,g.param,!0).then((function(e){i.handler(e,a)})).catch((function(e){dsf.layer.message("发送异常",!1),i._RequestID=null})).finally((function(){setTimeout((function(){s.disabled=!1}),1e3)}))}else dsf.layer.message("请先配置流程信息控件的'选择流程'",!1)}else dsf.layer.message("请先配置流程信息控件的'选择流程'",!1)},listFlowSend:function(e,t,n){var i=this,s=e.targetButton,o=s.completed,l={param:t,url:n};dsf.http.post(l.url,l.param,!0).then((function(e){i.handler(e,o)})).catch((function(e){dsf.layer.message("发送异常",!1),i._RequestID=null})).finally((function(){setTimeout((function(){s.disabled=!1}),1e3)}))},handler:function(e,t){if(this.dialog&&(this.dialog.close(),this.dialog=null),2e4==e.data.state){var n=e.data.data;if(this._RequestID=n.RequestID,2e4==n.Code||20001==n.Code||20003==n.Code||20004==n.Code||20005==n.Code)this.directlySend(n,t);else if(81e3==n.Code)this.chooseSendNode(n);else if(82e3==n.Code)this.chooseSendTree(n);else{var i=n.Message;n.EsMessage&&(i=i+"."+n.EsMessage),dsf.layer.message(i||"未知流程类型发送",!1)}}else{this._RequestID=null;var s=data.Message;data.EsMessage&&(s=s+"."+data.EsMessage),dsf.layer.message(s||"发送异常",!1)}},directlySend:function(e,t){var n,i,s,o=this;if(e.BatchResults)return dsf.layer.message("发送成功"),void this.closeOpener();var l={1:function(e){return e.UserName},2:function(e){return"".concat(e.DeptName,"-").concat(e.RoleName)},3:function(e){return e.JobName},4:function(e){return"".concat(e.UserName,"-").concat(e.RelationName)},5:function(e){return e.RobotName}},a={};null===e||void 0===e||null===(n=e.Links)||void 0===n||n.forEach((function(e){if([0,-1,-2].includes(e.Status)&&e.LinkUser){var t,n=(null===(t=a[e.LineID])||void 0===t?void 0:t.list)||[],i=e.LineID,s=e.CC,o=e.LineName;a[i]={isCC:3===s||4===s,LineName:o,LineID:i,list:n},n.push(l[e.LinkUser.Type](e.LinkUser)),a[i].list=_.uniq(n)}}));var r=Object.values(a).sort((function(e,t){return e.isCC-t.isCC})),d="已发送至：";[2e4,20001,20003].includes(null===e||void 0===e?void 0:e.Code)||[20004,20005].includes(null===e||void 0===e?void 0:e.Code)&&(currBtn.completed?owner.$replace(currBtn.completed,owner.$expressParams(e)):"文件已办结",d="提示"),dsf.layer.openDialog({title:d,width:dsf.global.$isMobile?"96%":"640px",height:"auto",content:"SendFlowDialog",showClose:!1,footerAlign:"center",params:{listMap:_.uniq(r),showCountDown:-1!=this.countDown&&-1!=(null===(i=this.$vm.flows.flowInfo)||void 0===i?void 0:i.countDown)&&!this.$vm.$dialog,countDownTime:this.countDown||(null===(s=this.$vm.flows.flowInfo)||void 0===s?void 0:s.countDown)},btns:[{text:"确定",class:"sendFlow",handler:function(e){return o.closeOpener(),!0}}]})},chooseSendNode:function(e){var t,n=[];null!==(t=e.SendParams)&&void 0!==t&&null!==(t=t.Lines)&&void 0!==t&&null!==(t=t[0])&&void 0!==t&&t.SendToLineID&&n.push({text:"返回",class:"plain",handler:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){var t,n={sRequestID:requestID,sLineID:null===(t=e.SendParams.Lines[0])||void 0===t?void 0:t.BackLineID};return httpProxy("post","wfr/setLineToBack",n).done((function(e){handler(e)})),!0}))}),this.dialog=dsf.layer.openDialog({title:"请选择要发送的环节：",width:"400px",height:"auto",overflow:"auto",footerAlign:"center",content:"ChooseSendNode",params:{lines:e.SendParams.Lines,callback:this.handler.bind(this),requestID:this._RequestID,type:"next",isBatch:!0},btns:n})},chooseSendTree:function(e){var t=this;this.dialog=dsf.layer.openDialog({title:"请选择办理人",width:"1200px",height:"480px",overflow:"hidden",content:"ChooseSendTree",params:{lines:e.SendParams.Lines},btns:[{text:"确定",handler:function(e){if(e.validate()){var n,i=e.yes(),s={sRequestID:t._RequestID,sReceivers:i},o=!t.isStart||t.$route.query.sPID||t.queryString.sPID?"wfr/batchSendToReceivers":"wfr/batchStartSendToReceivers";return t.$http.post(o,s,!0).then((function(e){2e4==e.data.state&&t.handler(e)})),null===(n=document.querySelector(".close-send-node"))||void 0===n||n.click(),!0}return!1}},{text:"取消"}]})},closeOpener:function(){var e,t,n,i,s,o,l,a,r,d,u,c,f;if(this.$form){if(null!==this&&void 0!==this&&null!==(e=this.$vm)&&void 0!==e&&e.$dialog)null===(i=this.$vm.$dialog)||void 0===i||null===(i=i.openerVm)||void 0===i||null===(s=i.reloadData)||void 0===s||s.call(i,!0),null===(o=this.$vm.$dialog)||void 0===o||null===(l=o.close)||void 0===l||l.call(o);else if(null!==this&&void 0!==this&&null!==(t=this.$vm)&&void 0!==t&&t.$openerVm){var v,h,p,m;null===(v=this.$vm.$openerVm)||void 0===v||null===(h=v.reloadData)||void 0===h||h.call(v,!0),null===(p=this.$vm)||void 0===p||null===(m=p.$closeWindow)||void 0===m||m.call(p)}else if(null!==(n=window)&&void 0!==n&&n.opener){var g,w;null===(g=window)||void 0===g||null===(g=g.opener)||void 0===g||null===(w=g.reloadData)||void 0===w||w.call(g,!0),window.close()}}else if(null!==this&&void 0!==this&&null!==(a=this.$vm)&&void 0!==a&&a.$dialog)null===(d=(u=this.$vm.$dialog).reloadData)||void 0===d||d.call(u,!0),null===(c=(f=this.$vm).reloadData)||void 0===c||c.call(f,!0);else if(null!==this&&void 0!==this&&null!==(r=this.$vm)&&void 0!==r&&r.reloadData){var D,$;null===(D=($=this.$vm).reloadData)||void 0===D||D.call($,!0)}else{var S;null===this||void 0===this||null===(S=this.reloadData)||void 0===S||S.call(this)}},isStart:!0,$form:!1,countDown:3,dialog:null},f=function(){var e=r()(u.a.mark((function e(t){var n,i,o,a,d,f,v,h,p,m,g,w,D,$,S,b,I,y,O,C,x,L,k,q,N,_;return u.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t.targetButton.disabled){e.next=2;break}return e.abrupt("return");case 2:if(t.targetButton.disabled=!0,c.$form=t._self.$form,!c.$form){e.next=19;break}return e.prev=5,n={isSilent:!0,isRefresh:!1,savedClose:!1,successMsg:"",errorMsg:""},e.next=9,c.$form.formSave(n);case 9:i=e.sent,i&&i.data?(o=[],a=t._self.$vm&&t._self.$vm.$dialog&&t._self.$vm.$dialog.dialogArgs&&t._self.$vm.$dialog.dialogArgs.data||[],t._self.$vm.$dialog&&a.length>0?o=a:(w=l()(t.params,3),D=w[0],$=w[1],S=w[2],D=null===(d=D)||void 0===d||null===(f=d.split)||void 0===f?void 0:f.call(d,","),$=null===(v=$)||void 0===v||null===(h=v.split)||void 0===h?void 0:h.call(v,","),S=null===(p=S)||void 0===p||null===(m=p.split)||void 0===m?void 0:m.call(p,","),null===(g=D)||void 0===g||g.forEach((function(e,t){var n;null===(n=i.data[e])||void 0===n||n.forEach((function(e){o.push({ObjectID:e[$[t]||$[0]],ObjectName:e[S[t]||S[0]]})}))}))),Object.assign(t._self,c),t._self.flowSend(i,t,o)):setTimeout((function(){t.targetButton.disabled=!1}),200),e.next=17;break;case 13:e.prev=13,e.t0=e["catch"](5),e.t0,setTimeout((function(){t.targetButton.disabled=!1}),200);case 17:e.next=33;break;case 19:if(I=t.owner.multipleSelection,!I||0!==I.length){e.next=24;break}return dsf.layer.message("请选择至少一条数据",!1),t.targetButton.disabled=!1,e.abrupt("return");case 24:y=l()(t.params,6),O=y[0],C=y[1],x=y[2],L=y[3],k=y[4],q=y[5],c.countDown=q,N={sWFID:(null===(b=I[0])||void 0===b?void 0:b[O])||O,sObjects:[]},c.isStart=!0,I.forEach((function(e){e[C]&&(c.isStart=!1);var t=Object.keys(e).map((function(t){var n=t.split(".");return s()({},n[n.length-1],e[t])}));N.sObjects.push({PID:null===e||void 0===e?void 0:e[C],LinkID:null===e||void 0===e?void 0:e[x],ObjectID:null===e||void 0===e?void 0:e[L],ObjectName:null===e||void 0===e?void 0:e[k],sExInfos:t})})),N.sObjects=JSON.stringify(N.sObjects),_=c.isStart?"wfr/batchStartSend":"wfr/batchSend",Object.assign(t._self,c),c.isStart?t._self.listFlowSend(t,N,_):dsf.layer.openDialog({title:"填写处理意见",width:"660px",height:"auto",params:{path:"dsfa/flow/basic/batch"},btns:[{text:"确定",handler:function(){var e=r()(u.a.mark((function e(n){var i;return u.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,n.yes();case 2:i=e.sent,N.sOpinion=JSON.stringify(i),t._self.listFlowSend(t,N,_);case 5:case"end":return e.stop()}}),e)})));function n(t){return e.apply(this,arguments)}return n}()}]});case 33:case"end":return e.stop()}}),e,null,[[5,13]])})));return function(t){return e.apply(this,arguments)}}();t["default"]=f}}]);
//# sourceMappingURL=../../../smap/platform/dsf-platform.platform_pc_flowBatchSend.js.map
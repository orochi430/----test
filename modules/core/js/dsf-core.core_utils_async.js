/*!
 * Name: @dsf/cli-core
 * Version: 5.17.0-alpha.5
 * Description: 核心模块
 * BuildTime: 2024/6/19 17:49:24
*/
(("undefined"!==typeof self?self:this)["webpackJsonpcore"]=("undefined"!==typeof self?self:this)["webpackJsonpcore"]||[]).push([[11],{297:function(e,t,n){"use strict";n.r(t);var i=n(45),a=n.n(i),s=n(26),r=n.n(s),o=n(27),l=n.n(o),u=n(2),c=n.n(u),p=n(24),h=n.n(p),d=n(148),f=n.n(d);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){c()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function w(e,t,n){v(e,t),t.set(e,n)}function v(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function m(e,t,n){return e.set(y(e,t),n),n}function b(e,t){return e.get(y(e,t))}function y(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}var M=f.a.CancelToken,x=1073741824,S=2097152,W=9437184,z={readying:"readying",ready:"ready",uploading:"uploading",suspend:"suspend",stop:"stop",finish:"finish",error:"error"},T={ready:"ready",uploading:"uploading",suspend:"suspend",stop:"stop",finish:"finish",error:"error",speed:"speed"},j=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,O=window.Worker?re:oe,N=new WeakMap,P=new WeakMap,D=new WeakMap,F=new WeakMap,U=new WeakMap,C=new WeakMap,E=new WeakMap,$=new WeakMap,A=new WeakMap,I=new WeakMap,L=new WeakMap,H=new WeakMap,q=new WeakMap,B=new WeakMap,J=new WeakMap,Y=new WeakMap,R=new WeakMap,V=new WeakMap,G=new WeakMap,K=new WeakMap,Q=new WeakMap,X=new WeakMap,Z=new WeakMap,ee=new WeakMap,te=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r()(this,e),w(this,N,null),w(this,P,""),w(this,D,null),w(this,F,dsf.config.setting_public_upload_split_threshold),w(this,U,dsf.config.setting_public_upload_split_chunksize),w(this,C,0),w(this,E,0),w(this,$,null),w(this,A,null),w(this,I,"/file/uploadAuth/"),w(this,L,"/file/check"),w(this,H,"/file/uploadChunkAuth"),w(this,q,{isPublic:1,isStatic:0}),w(this,B,""),w(this,J,""),w(this,Y,""),w(this,R,0),w(this,V,0),w(this,G,0),w(this,K,null),w(this,Q,{ready:[],uploading:[],suspend:[],stop:[],finish:[],error:[],speed:[]}),w(this,X,(function(e,n){var i;null!==(i=b(Q,t)[e])&&void 0!==i&&i.length&&_.each(b(Q,t)[e],(function(e){return e(n)}))})),w(this,Z,(function(e,n){var i=b(D,t).size,a=_.floor(1e4*e/i)/100||0;return a>100&&(a=100),m(R,t,b(R,t)+n),{loaded:e,total:i,progress:a,speed:b(G,t),_loaded:dsf.fileSizeToString(e),_total:dsf.fileSizeToString(i),_speed:dsf.fileSizeToString(b(G,t))+"/s"}})),w(this,ee,a()(h.a.mark((function e(){var n,i,a,s,r,o;return h.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=b(P,t),m(P,t,z.uploading),b(X,t).call(t,T.uploading,b(Z,t).call(t,b(C,t)*b(U,t),0)),!(b(D,t).size<b(F,t))){e.next=20;break}return e.prev=4,m(A,t,M.source()),e.next=8,ce.call(t,{cancelToken:b(A,t).token,url:b(I,t),file:b(D,t),pageName:b(B,t),namespace:b(J,t),extendData:b(q,t),caption:b(Y,t)},(function(e){var n=e.loaded,i=e.offLoaded;b(X,t).call(t,T.uploading,b(Z,t).call(t,n,i))}));case 8:i=e.sent,m(P,t,z.finish),b(X,t).call(t,T.finish,i),e.next=19;break;case 13:e.prev=13,e.t0=e["catch"](4),console.error(e.t0),clearTimeout(b(K,t)),m(P,t,z.error),b(X,t).call(t,T.error,e.t0);case 19:return e.abrupt("return",t);case 20:if(e.prev=20,n===z.suspend){e.next=36;break}return e.next=24,le.call(t,{url:b(L,t),hash:b(N,t),file:b(D,t),pageName:b(B,t),namespace:b(J,t),extendData:b(q,t),caption:b(Y,t)});case 24:if(a=e.sent,0!=a.upload){e.next=29;break}m(C,t,0),e.next=36;break;case 29:if(1!=a.upload){e.next=33;break}m(C,t,a.chunkIndex),e.next=36;break;case 33:return m(P,t,z.finish),b(X,t).call(t,T.finish,[a.fileInfo]),e.abrupt("return");case 36:s=null,r=h.a.mark((function e(){var n,i,a;return h.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=b(C,t)*b(U,t),i=n+b(U,t)>=b(D,t).size?b(D,t).size:n+b(U,t),a=j.call(b(D,t),n,i),m(A,t,M.source()),e.next=5,ue.call(t,{cancelToken:b(A,t).token,url:b(H,t),hash:b(N,t),blob:a,file:b(D,t),currentChunk:b(C,t),chunks:b(E,t),position:n,pageName:b(B,t),namespace:b(J,t),extendData:b(q,t),caption:b(Y,t)},(function(e){var i=e.loaded,a=e.offLoaded;b(X,t).call(t,T.uploading,b(Z,t).call(t,n+i,a))}));case 5:s=e.sent,m(C,t,(o=b(C,t),o++,o));case 7:case"end":return e.stop()}}),e)}));case 38:if(!(b(C,t)<b(E,t)&&b(P,t)===z.uploading)){e.next=42;break}return e.delegateYield(r(),"t1",40);case 40:e.next=38;break;case 42:m(A,t,null),b(P,t)===z.uploading&&(m(P,t,z.finish),b(X,t).call(t,T.finish,s)),e.next=63;break;case 46:e.prev=46,e.t2=e["catch"](20),console.error(e.t2),clearTimeout(b(K,t)),m(A,t,null),e.t3=null===e.t2||void 0===e.t2?void 0:e.t2.message,e.next=e.t3===z.stop?54:e.t3===z.suspend?55:57;break;case 54:return e.abrupt("break",63);case 55:return b(X,t).call(t,T.suspend,b(Z,t).call(t,b(C,t)*b(U,t),0)),e.abrupt("break",63);case 57:m(P,t,z.error),m(C,t,0),m(R,t,0),m(V,t,0),m(G,t,0),b(X,t).call(t,T.error,e.t2);case 63:return e.abrupt("return",t);case 64:case"end":return e.stop()}}),e,null,[[4,13],[20,46]])})))),dsf.isNumber(n.chunkSize)&&m(U,this,n.chunkSize),dsf.isNumber(n.threshold)?m(F,this,n.threshold):m(F,this,dsf.config.setting_public_upload_split_threshold),dsf.isNumber(n.chunkSize)?m(U,this,n.chunkSize):m(U,this,dsf.config.setting_public_upload_split_chunksize),dsf.isString(n.uploadFileUrl)&&m(I,this,n.uploadFileUrl),dsf.isString(n.queryChunkUrl)&&m(L,this,n.queryChunkUrl),dsf.isString(n.uploadChunkUrl)&&m(H,this,n.uploadChunkUrl),dsf.isObject(n.owner)&&m($,this,n.owner),dsf.isObject(n.extendData)&&m(q,this,Object.assign({isPublic:1,isStatic:0},n.extendData)),dsf.isString(n.pageName)&&m(B,this,n.pageName),dsf.isString(n.namespace)&&m(J,this,n.namespace),dsf.isString(n.caption)&&m(Y,this,n.caption)}return l()(e,[{key:"file",get:function(){return b(D,this)}},{key:"hash",get:function(){return b(N,this)}},{key:"status",get:function(){return b(P,this)}},{key:"owner",get:function(){return b($,this)}},{key:"load",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return m(N,this,null),m(D,this,e),m(R,this,0),m(V,this,0),m(G,this,0),e.size<b(F,this)?(m(P,this,z.ready),b(X,this).call(this,T.ready),n&&this.run(),this):(b(U,this)||m(U,this,e.size<x?S:W),m(C,this,0),m(E,this,Math.ceil(e.size/b(U,this))),m(P,this,z.readying),ne(e).then((function(e){m(N,t,e),m(P,t,z.ready),b(X,t).call(t,T.ready,e),n&&t.run()})).catch((function(e){m(P,t,z.error),b(X,t).call(t,T.error,e)})),this)}},{key:"run",value:function(){var e=this;if(!b(D,this))return this;b(ee,this).call(this);var t=function t(){b(P,e)===z.uploading&&m(K,e,setTimeout((function(){var n=b(D,e).size,i=_.floor(1e4*b(R,e)/n)/100||0;i>100&&(i=100),m(G,e,Math.round((b(R,e)-b(V,e))/2)),m(V,e,b(R,e)),b(X,e).call(e,T.speed,{progress:i,speed:b(G,e),_speed:dsf.fileSizeToString(b(G,e))+"/s"}),t()}),2e3))};return clearTimeout(b(K,this)),t(),this}},{key:"suspend",value:function(){var e;return b(D,this)?(clearTimeout(b(K,this)),null===(e=b(A,this))||void 0===e||e.cancel(z.suspend),m(R,this,0),m(V,this,0),m(G,this,0),m(P,this,z.suspend),this):this}},{key:"stop",value:function(){var e;return b(D,this)?(clearTimeout(b(K,this)),null===(e=b(A,this))||void 0===e||e.cancel(z.stop),m(N,this,null),m(D,this,null),m(C,this,0),m(E,this,0),m(R,this,0),m(V,this,0),m(G,this,0),m(P,this,z.stop),b(X,this).call(this,T.stop),this):this}},{key:"on",value:function(e,t){if(!b(Q,this)[e]||!dsf.isFunction(t))return this;var n=_.findIndex(b(Q,this)[e],(function(e){return e===t}));-1==n&&b(Q,this)[e].push(t)}},{key:"off",value:function(e,t){if(!b(Q,this)[e])return this;if(void 0===t)return b(Q,this)[e]=[],this;if(dsf.isFunction(t)){var n=_.findIndex(b(Q,this)[e],(function(e){return e===t}));n>-1&&b(Q,this)[e].splice(n,1)}return this}}]),e}();function ne(e){return new Promise((function(t,n){O(e,(function(e){t(e)}),(function(e){return n({message:e.message})}))}))}function ie(e,t){return new te(t).load(e,!0)}c()(te,"STATUS",z),c()(te,"EVENT_TYPE",T);var ae=null,se={};function re(e,t,n){ae||(ae=new Worker(dsf.url.getWebPath("$/js/libs/sparkMd5/worker.js")),ae.addEventListener("message",(function(e){var t=e.data,n=t.success,i=t.id,a=t.data,s=t.message;se[i]&&(n?se[i].cb(a):se[i].error(s),delete se[i])})));var i=dsf.uuid();se[i]={cb:t,error:n},ae.postMessage({id:i,file:e})}function oe(e,t,n){dsf.http.importFiles(dsf.url.getWebPath("$/js/libs/sparkMd5/index.min.js")).then((function(){var i=new SparkMD5.ArrayBuffer,a=2097152,s=0,r=Math.ceil(e.size/a),o=new FileReader;function l(){var t=s*a,n=t+a>=e.size?e.size:t+a,i=j.call(e,t,n);o.readAsArrayBuffer(i)}o.onload=function(e){if(i.append(e.target.result),s++,s<r)l();else{var n=i.end();t(n)}},o.onerror=function(e){return n(e.message)},l()})).catch((function(e){n(e.message)}))}function le(e){var t,n,i,a=e.url,s=e.hash,r=e.file,o=e.pageName,l=e.namespace,u=e.extendData,c=e.caption,p=[a,k(k({},u),{},{pageName:o,namespace:l,fileHash:s,originalFileName:r.name,size:r.size,contentType:r.type,caption:c})];return(null!==(t=this.owner)&&void 0!==t&&t.$http?(n=this.owner.$http).get.apply(n,p.concat([!0])):(i=dsf.http).get.apply(i,p)).done((function(e){var t=e.success,n=e.data,i=e.message;if(t)return n;throw{message:i}}))}function ue(e,t){var n,i,a,s=e.cancelToken,r=e.url,o=e.hash,l=e.blob,u=e.file,c=e.currentChunk,p=e.chunks,h=e.position,d=e.pageName,f=e.namespace,g=e.extendData,w=e.caption,v=0,m=[r,k(k({},g),{},{pageName:d,namespace:f,position:h,fileHash:o,chunkIndex:c+1,chunkCount:p,file:l,originalFileName:u.name,size:u.size,contentType:u.type,caption:w}),{cancelToken:s,onUploadProgress:function(e){var n=e.loaded,i=n-v;v=n,t({loaded:n,offLoaded:i})}}];return(null!==(n=this.owner)&&void 0!==n&&n.$http?(i=this.owner.$http).upload.apply(i,m.concat([!0])):(a=dsf.http).upload.apply(a,m)).done((function(e){var t=e.success,n=e.data,i=e.message;if(t)return n;throw{message:i}}))}function ce(e,t){var n,i,a,s=e.cancelToken,r=e.url,o=e.file,l=e.pageName,u=e.namespace,c=e.extendData,p=e.caption,h=0,d=[r,k(k({},c),{},{pageName:l,namespace:u,file:o,caption:p}),{cancelToken:s,onUploadProgress:function(e){var n=e.loaded,i=n-h;h=n,t({loaded:n,offLoaded:i})}}];return(null!==(n=this.owner)&&void 0!==n&&n.$http?(i=this.owner.$http).upload.apply(i,d.concat([!0])):(a=dsf.http).upload.apply(a,d)).done((function(e){var t=e.success,n=e.data,i=e.message;if(t)return n;throw{message:i}}))}t["default"]={SplitUploader:te,fileToHash:ne,createUploader:ie}}}]);
//# sourceMappingURL=../../../smap/core/dsf-core.core_utils_async.js.map
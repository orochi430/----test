/*!
 * Name: @dsf/cli-platform
 * Version: 5.17.0-alpha.5
 * Description: 平台基础包
 * BuildTime: 2024/6/19 17:49:40
*/
(("undefined"!==typeof self?self:this)["webpackJsonpplatform"]=("undefined"!==typeof self?self:this)["webpackJsonpplatform"]||[]).push([[71],{1088:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("DsfFormControlBox",{staticClass:"ds-upload-file",class:{"hide-btns":e.hideBtns,"--simple":e.simple},attrs:{owner:e._self},scopedSlots:e._u([{key:"simple",fn:function(){return[i("DsfTextProxy",e._b({model:{value:e.value,callback:function(t){e.value=t},expression:"value"}},"DsfTextProxy",e._self.$props,!1))]},proxy:!0},{key:"content",fn:function(){return[e.$$readOnly?e._e():[e.allowDownload&&e.showMultipleFiles&&e.showMultipleFiles.length>0&&!e.uploadOneFile&&!e.simpleFileStyle&&!e.hideBtns?i("dsf-button",{staticClass:"download-button",attrs:{icon:"yunduanxiazai"},on:{click:e.downLoadAll}},[e._v(" 全部下载 ")]):e._e(),i("el-upload",{ref:"upload",staticClass:"ds-upload-file-bar",class:{"upload-one-file":e.uploadOneFile,"simple-file-style":e.simpleFileStyle,"has-file-list":e.showMultipleFiles.length,"hide-btns":e.hideBtns},attrs:{disabled:e.showMultipleFiles.length>=e.limit||e.$$disabled,accept:e.acceptMime,multiple:e.multiple,drag:e.isDragable,limit:e.limit,"show-file-list":!1,"http-request":e.httpRequest,"before-upload":e.beforeUpload,"on-exceed":e.handleExceed,action:"","auto-upload":""}},[e.isDragable?[i("i",{staticClass:"el-icon-upload"}),i("div",{staticClass:"el-upload__text"},[e._v("点击上传，或将文件拖拽到此处")])]:e.simpleFileStyle?[e.simple&&!e.$$readOnly?i("dsf-button",{attrs:{"btn-style":"icon-text",disabled:e.$$disabled}},[e._v(" "+e._s(e.showBtnName?e.btnName:"")+" ")]):e._e()]:e.uploadOneFile?[i("div",{staticClass:"one-file-button"},[e._v(" "+e._s(e.showBtnName?e.btnName:"")+" ")])]:[i("dsf-button",{attrs:{disabled:e.showMultipleFiles.length>=e.limit||e.$$disabled,icon:"yunduanshangchuan"}},[e._v(" "+e._s(e.showBtnName?e.btnName:"")+" ")])]],2)],e.showMultipleFiles.length?[e.simple&&!e.isDesign?i("div",{staticClass:"file-list"},[e._l(e.showMultipleFiles,(function(t,a){return[t.status?i("span",{key:t.id,staticClass:"file-item --uploading"},[i("i",{staticClass:"icon dsf-file-icon",class:t.suffix}),i("span",[e._v(e._s(t.name))]),e.$$readOnly?e._e():i("dsf-icon",{staticClass:"file-item-bt",attrs:{name:"shanchu1",title:"删除"},on:{click:function(e){return e.stopPropagation(),t.stopHandler.apply(null,arguments)}}}),"error"==t.status.type?i("dsf-icon",{staticClass:"file-item-bt",staticStyle:{color:"#f56c6c"},attrs:{name:"icon_refresh",title:"上传失败，请重新上传"},on:{click:function(e){return e.stopPropagation(),t.suspendHandler.apply(null,arguments)}}}):i("i",{staticClass:"file-item-progress"},[e._v(e._s(t.status._progress)+"%")])],1):i("span",{key:t.id,staticClass:"file-item",attrs:{title:e.getFileTitle(t)}},[e.mxFileEncryptIsFileEncrypt?i("DsfIcon",{attrs:{name:"suo1"}}):e._e(),i("i",{staticClass:"icon dsf-file-icon",class:t.suffix}),e.clickPreview?i("span",{staticClass:"view-name",on:{click:function(i){return e.rowBtClickPreview(t,a)}}},[e._v(e._s(t.name)+"."+e._s(t.suffix))]):i("span",[e._v(e._s(t.name)+"."+e._s(t.suffix))]),i("dsf-icon",{staticClass:"file-item-bt",attrs:{name:"yunduanxiazai",title:"下载"},on:{click:function(i){return i.stopPropagation(),e.rowBtClickDownload(t,a)}}}),e.$$readOnly?e._e():i("dsf-icon",{staticClass:"file-item-bt",attrs:{name:"weitongguo",title:"删除"},on:{click:function(i){return i.stopPropagation(),e.rowBtClickDelete(t)}}})],1)]}))],2):i("div",{staticClass:"file-list"},[i("div",{staticClass:"file-list-row header"},[i("div",{staticClass:"file-list-row-box"},[e.uploadOneFile?e._e():i("div",{staticClass:"file-list-col",staticStyle:{width:"60px"}},[e._v("序号")]),i("div",{staticClass:"file-list-col",staticStyle:{flex:"auto",width:"0"}},[e._v("文件名")]),e.showFileDate?i("div",{staticClass:"file-list-co file-list-multipleFilescol",staticStyle:{width:"160px"}},[e._v(" 上传时间 ")]):e._e(),e.showFileSize?i("div",{staticClass:"file-list-col",staticStyle:{width:"90px"}},[e._v("文件大小")]):e._e(),e.mxFileEncryptIsFileEncrypt?[i("div",{staticClass:"file-list-col",staticStyle:{width:"120px"}},[e._v("密级")]),e.editEncryptfileDeadline?i("div",{staticClass:"file-list-col",staticStyle:{width:"170px"}},[e._v(" 解密日期 ")]):e._e()]:e._e(),i("div",{staticClass:"file-list-col _bt _bt1",style:{width:e.$$readOnly?"90px":"220px"}})],2)]),e._l(e.showMultipleFiles,(function(t,a){return[t.status?i("div",{key:t.id,staticClass:"file-list-row"},[i("div",{staticClass:"file-list-row-progress",style:{transform:"scaleX("+t.status.progress/100+")"}}),i("div",{staticClass:"file-list-row-box"},[i("div",{staticClass:"file-list-col",staticStyle:{width:"60px"}},["error"==t.status.type?i("i",{staticClass:"el-icon-warning-outline"}):i("i",{staticClass:"el-icon-loading",class:{suspend:"suspend"==t.status.type}})]),i("div",{staticClass:"file-list-col",staticStyle:{flex:"auto",width:"0"}},[i("div",{staticClass:"ds-multi-ellipsis-1"},[i("i",{staticClass:"icon dsf-file-icon",class:t.suffix}),e._v(e._s(t.originalFileName)+" ")])]),i("div",{staticClass:"file-list-col",staticStyle:{width:"200px"}},[e._v(" "+e._s(e.computeFileSize(t.size))+" "),t.status.speed?i("span",{staticStyle:{opacity:"0.8"}},[e._v("("+e._s(t.status.speed)+")")]):e._e()]),i("div",{staticClass:"file-list-col",staticStyle:{width:"90px","text-align":"center"}},["suspend"==t.status.type?i("span",[e._v("已暂停")]):"error"==t.status.type?i("el-tooltip",{attrs:{content:t.status.errorMsg,effect:"light",placement:"top"}},[i("div",{staticClass:"ellipsis",staticStyle:{color:"#f56c6c"}},[e._v(e._s(t.status.errorMsg))])]):i("span",[e._v(e._s(t.status._progress)+"%")])],1),i("div",{staticClass:"file-list-col _bt _bt2",staticStyle:{width:"120px"}},[i("dsf-icon",{directives:[{name:"show",rawName:"v-show",value:"error"==t.status.type,expression:"info.status.type == 'error'"}],attrs:{name:"icon_refresh",title:"重新上传"},on:{click:t.suspendHandler}}),i("dsf-icon",{attrs:{name:"weitongguo"},on:{click:t.stopHandler}})],1)])]):i("div",{key:t.id,staticClass:"file-list-row"},[i("div",{staticClass:"file-list-row-box"},[e.uploadOneFile?e._e():i("div",{staticClass:"file-list-col",staticStyle:{width:"60px"}},[e._v(" "+e._s(a+1)+" ")]),i("div",{staticClass:"file-list-col",staticStyle:{flex:"auto",width:"0"}},[i("div",{staticClass:"ds-multi-ellipsis-1"},[e.mxFileEncryptIsFileEncrypt?i("DsfIcon",{attrs:{name:"suo1"}}):e._e(),i("i",{staticClass:"icon dsf-file-icon",class:t.suffix}),e.clickPreview?i("span",{staticClass:"view-name",on:{click:function(i){return e.rowBtClickPreview(t,a)}}},[e._v(e._s(t.originalFileName))]):i("span",[e._v(e._s(t.originalFileName))])],1)]),e.showFileDate?i("div",{staticClass:"file-list-col",staticStyle:{width:"160px"}},[e._v(" "+e._s(e._f("proxy")(t.uploadDate,e.dateFormatter))+" ")]):e._e(),e.showFileSize?i("div",{staticClass:"file-list-col",staticStyle:{width:"90px"}},[e._v(" "+e._s(e.computeFileSize(t.size))+" ")]):e._e(),e.mxFileEncryptIsFileEncrypt?[i("div",{staticClass:"file-list-col",staticStyle:{width:"120px"}},[t.isNew?i("div",{staticClass:"file-list-col-flex"},[i("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{focus:e.handleEncryptFocus,change:function(i){return e.securityLevelChange(i,t)}},model:{value:t.securityLevelValue,callback:function(i){e.$set(t,"securityLevelValue",i)},expression:"info.securityLevelValue"}},e._l(e.mxFileEncryptSecurityLevel,(function(e){return i("el-option",{key:e.value,attrs:{label:e.text,value:e.value}})})),1)],1):i("span",[e._v(e._s(t.securityLevelText))])]),e.editEncryptfileDeadline?i("div",{staticClass:"file-list-col",staticStyle:{width:"170px"}},[t.securityLevelExpiryDate?i("span",[e._v(e._s(e.dsf.date.format(t.securityLevelExpiryDate,"yyyy-mm-dd")))]):e._e()]):e._e()]:e._e(),i("div",{staticClass:"file-list-col _bt _bt1",style:{width:e.$$readOnly?"90px":"220px"}},[e._l(e.handleList,(function(s){return[s.hide&&s.hide(t,a)?e._e():i("dsf-icon",{key:s.id,attrs:{name:s.icon,title:s.name},on:{click:function(e){return s.hanlder(t,a)}}})]}))],2)],2)])]}))],2)]:e._e(),e.errors.length>0&&e.showMultipleFiles.length<=0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e()]},proxy:!0}])})},s=[],l=i(3),n=i.n(l),o=i(4),r=i.n(o),c=i(1),u=i.n(c);function d(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function p(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?d(Object(i),!0).forEach((function(t){n()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var f=["xls","xlsx","doc","docx"],h=["png","jpg","jpeg","bmp","gif"],m=[],g=dsf.component({name:"DsfUploadFile",mixins:[$mixins.formControl,$mixins.fileEncrypt],ctrlCaption:"文件上传",props:{simple:{type:Boolean,default:!1},simpleFileStyle:{type:Boolean,default:!1},dateFormatter:{type:String,default:"dateTime^yyyy-mm-dd hh:ii"},formatter:{type:String,default:"multipleFiles^originalFileName"},label:{type:String,default:"文件上传"},btnName:{type:String,default:"文件上传"},showBtnName:{type:Boolean,default:!0},multiple:{type:Boolean,default:!0},uploadFileNum:{type:[Number,String],default:5},uploadOneFile:{type:Boolean,default:!1},singleFileSizeLimitUnit:{type:String,default:"MB"},maxFileSize:{type:[Number,String],default:0},zipFileName:{type:String,default:""},required:{type:Boolean,default:!1},isViewImages:{type:Boolean,default:!0},isDragable:{type:Boolean,default:!1},requestUrl:{type:String,default:""},extsSetting:{type:Object,default:function(){return{}}},metadata:{type:Object,default:function(){var e=dsf.metadata.get("file-meta-data");return e=dsf.mix(e,{isFileEncrypt:!1,dataSource:{attachTipsMaps:{},code:dsf.config.setting_encrypt_level_dictionary,type:"dict"}}),e}},hideBtns:{type:Boolean,default:!1},files:{type:Array,default:function(){return[]}},clickPreview:{type:Boolean,default:!1},canFileNameEdit:{type:Boolean,default:!1},canOnlineEdit:{type:Boolean,default:!1},showRevisionMode:{type:Boolean,default:!1},showFileDate:{type:Boolean,default:!0},showFileSize:{type:Boolean,default:!0},canCutVideo:{type:Boolean,default:!1},isStatic:{type:Boolean,default:!1},isPublic:{type:Boolean,default:!0},initialFileName:{type:Boolean,default:!0},allowDownload:{type:Boolean,default:!0}},data:function(){return this.orders=[],{updateKey:0,limit:0,isShowDownloadBtn:!1,uploadFileType:"file",uploadFileExts:[],acceptMime:"",uploadingFileMap:{},cutSuccessMap:{},autoUpload:!0,uploadedFiles:0,uploadingFileIds:[]}},computed:{handleList:function(){var e=this;if(this.$$readOnly)return[{id:"preview",icon:"icon-visible",name:"预览",hanlder:this.rowBtClickPreview},{id:"download",icon:"yunduanxiazai",name:"下载",hanlder:this.rowBtClickDownload}];var t=[{id:"up",icon:"shang",name:"上移",hide:function(e,t){return!t},hanlder:this.rowBtClickUp},{id:"down",icon:"xia",name:"下移",hide:function(t,i){return i+1==e.showMultipleFiles.length},hanlder:this.rowBtClickDown},{id:"preview",icon:"icon-visible",name:"预览",hanlder:this.rowBtClickPreview},{id:"download",icon:"yunduanxiazai",name:"下载",hanlder:this.rowBtClickDownload},{id:"upload",icon:"yunduanshangchuan",name:"重新上传",hanlder:this.rowBtClickUpload}];return this.canCutVideo&&t.push({id:"videoSlicing",icon:"qiepian",name:"视频切片",hide:function(t){return"mp4"!==t.suffix.toLowerCase()||e.cutSuccessMap[t.id]},hanlder:this.rowBtClickVideoSlicing}),t.push({id:"edit",icon:"bianji",name:"在线编辑",hide:function(t){return!e.showOnlineEdit(t)},hanlder:this.rowBtClickEdit},{id:"delete",icon:"delete",name:"删除",hanlder:this.rowBtClickDelete}),this.canFileNameEdit&&t.push({id:"editFileName",icon:"icon-shezhi",name:"修改文件名",hanlder:this.rowBtClickEditFileName}),t},filesMap:function(){var e=this,t={};return _.each(this.files,(function(i){_.find(e.orders,(function(e){return e==i.id}))||e.orders.push(i.id),t[i.id]=i})),t},valueMap:function(){var e=this;if(!this.value&&!dsf.isString(this.value))return[];try{var t=JSON.parse(this.value);if(dsf.isArray(t)){var i={};return _.each(t,(function(t){_.find(e.orders,(function(e){return e==t.id}))||e.orders.push(t.id),i[t.id]=t})),i}return{}}catch(a){return{}}},multipleFiles:function(){var e=this,t=this.updateKey,i=this.orders,a=this.uploadingFileMap,s=this.filesMap,l=this.valueMap;t=parseInt(t);var n=[];return _.eachRight(i,(function(t,o){var r=s[t]||l[t]||a[t];if(r){if(e.mxFileEncryptIsFileEncrypt&&r.isNew&&-10==r.securityLevelValue)if(e.mxFileEncryptSecurityLevel.length){var c=e.mxFileEncryptSecurityLevel[0],u=c.text,d=c.value;r.securityLevelValue=d,r.securityLevelText=u}else r.securityLevelValue="";n.unshift(r)}else i.splice(o,1)})),n},showMultipleFiles:function(){var e=this;if(!this.mxFileEncryptIsFileEncrypt)return this.multipleFiles;var t=_.filter(this.multipleFiles,(function(t){return e.validate(t.securityLevelValue)}));return t},extendData:function(){var e=this.isStatic,t=this.isPublic,i={isStatic:Number(e),isPublic:Number(t)};return e&&this.$vm&&(i["namespace"]=this.$vm.nameSpace,i["pageName"]=this.$vm.pageName),this.mxFileEncryptIsFileEncrypt&&(i["securityLevelValue"]="",i["securityLevelText"]="",i["securityLevelExpiryDate"]=""),i},user_security_level:function(){var e,t=(null===(e=this.$vm)||void 0===e||null===(e=e.$viewInitData)||void 0===e||null===(e=e[this.metadata.dataKey||this.dataKey])||void 0===e?void 0:e.dataSource)||this.securityLevel||[];if(dsf.isArray(t)&&t.length>0){var i=_.map(t,(function(e){return e.value}));return Math.max.apply(null,i)+""}return"20"}},watch:{uploadOneFile:{handler:function(e){e?(this.$emit("update:multiple",!1),this.$emit("update:btnName","请点击上传文件"),this.limit=100):(this.$emit("update:multiple",!0),this.limit=parseInt(this.uploadFileNum))},immediate:!0},extsSetting:{handler:function(e){this.initExtsSetting(e)},immediate:!0},mxFileEncryptIsFileEncrypt:{handler:function(e){this.$set(this.metadata,"isFileEncrypt",e)},immediate:!0},showMultipleFiles:function(){this.uploadedFiles=this.showMultipleFiles.length}},created:function(){m.push(this),this.initExtsSetting(this.extsSetting)},beforeDestroy:function(){_.filter(this.uploadingFileMap,(function(e){return!!e.stopHandler})).forEach((function(e){return e.stopHandler()})),dsf.array.remove(m,this)},methods:{handleEncryptFocus:function(){""===this.mxFileEncryptFormEncryptLevel&&dsf.layer.message("请选择页面【密级】字段",!1)},securityLevelChange:function(e,t){var i=this;return r()(u.a.mark((function a(){var s,l,n;return u.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,i.mxFileEncryptGetExpiryDate(t.securityLevelValue);case 2:l=a.sent,n=null===(s=_.find(i.mxFileEncryptSecurityLevel,(function(t){return t.value===e})))||void 0===s?void 0:s.text,i.updateFileSecret(p(p({},t),{},{securityLevelExpiryDate:l,securityLevelText:n,securityLevelValue:e}),(function(){t.securityLevelText=n||"",t.securityLevelExpiryDate=l,i.updateValue(i.multipleFiles)}));case 5:case"end":return a.stop()}}),a)})))()},updateFileSecret:function(e,t){var i={dmId:e.id,securityLevelValue:e.securityLevelValue,securityLevelText:e.securityLevelText,securityLevelExpiryDate:e.securityLevelExpiryDate};this.$http.post("/file/updateFileSecret",i).then((function(e){var i=e.data,a=i.success,s=i.message;a?t():dsf.layer.message(s||"请求异常",!1)}))},computeFileSize:dsf.fileSizeToString,initExtsSetting:function(e){if(e.extStr){var t;this.uploadFileType=e.fileType,this.acceptMime=e.mineStr;var i=[];_.each((null===(t=e.extStr)||void 0===t?void 0:t.split(","))||[],(function(e){e=_.trim(e),e.startsWith(".")||i.push("."+e),i.push(e)})),this.uploadFileExts=i}},beforeUpload:function(e,t){var i=this;return r()(u.a.mark((function a(){var s,l,n,o,r;return u.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(i.uploadedFiles+=1,!i.$listeners["before-upload-customer"]){a.next=7;break}return a.next=4,new Promise((function(t,a){i.$emit("before-upload-customer",e,t)}));case 4:if(s=a.sent,"continue"===s){a.next=7;break}return a.abrupt("return",Promise.reject(!1));case 7:if(t||!(i.limit<i.uploadedFiles)){a.next=11;break}return dsf.layer.message("当前限制选择最多 ".concat(i.limit," 个文件"),!1),i.uploadedFiles-=1,a.abrupt("return",Promise.reject(!1));case 11:if(!i.uploadFileExts.length){a.next=17;break}if(l="."+i.getFileSuffix(e.name),~i.uploadFileExts.indexOf(l)){a.next=17;break}return dsf.layer.message("选择文件中包含不支持的文件格式,请选择包含这些格式的文件：".concat(i.uploadFileExts.join(",")),!1),i.uploadedFiles-=1,a.abrupt("return",Promise.reject(!1));case 17:if(n="","KB"!=i.singleFileSizeLimitUnit&&i.maxFileSize?n=i.getFileSize(i.maxFileSize):"KB"===i.singleFileSizeLimitUnit&&i.maxFileSize&&(n=parseInt(i.maxFileSize)),o=!n||e.size/1024<n,o){a.next=24;break}return dsf.layer.message("文件大小不能超过".concat(parseInt(i.maxFileSize)).concat(i.singleFileSizeLimitUnit||"MB"),!1),i.uploadedFiles-=1,a.abrupt("return",Promise.reject(!1));case 24:if(r=_.some(i.multipleFiles,(function(t){return t.originalFileName==e.name&&t.contentType===e.type&&t.size===e.size})),!r||t){a.next=29;break}return dsf.layer.message("已存在文件【".concat(e.name,"】，请修改后重新上传"),!1),i.uploadedFiles-=1,a.abrupt("return",Promise.reject(!1));case 29:case"end":return a.stop()}}),a)})))()},handleExceed:function(e,t){dsf.layer.message("当前限制选择最多 ".concat(this.limit," 个文件"),!1)},httpRequest:function(e,t){var i=this;return r()(u.a.mark((function a(){var s,l,n,o,c,d,f;return u.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return n=e.file,i.$refs.upload.clearFiles(),a.next=4,dsf.createUploader(n,{owner:i,uploadFileUrl:i.requestUrl||"/file/uploadAuth/",extendData:i.extendData,pageName:(null===(s=i.$vm)||void 0===s?void 0:s.pageName)||"",namespace:(null===(l=i.$vm)||void 0===l?void 0:l.nameSpace)||"",caption:i.caption});case 4:o=a.sent,c=i.getFileSuffix(n.name),d={id:dsf.uuid(),suffix:c,name:n.name.replace("."+c,""),size:n.size,contentType:n.type,originalFileName:n.name,status:{progress:0,_progress:0,loaded:"0B",speed:"校验中...",type:"reading"},stopHandler:function(){o.stop(),o=void 0,i.$delete(i.uploadingFileMap,d.id)},suspendHandler:function(){o.status==dsf.SplitUploader.STATUS.uploading?o.suspend():o.run()}},t?(f=_.findIndex(i.orders,(function(e){return e==t})),i.orders[f]=d.id):i.orders.push(d.id),i.$set(i.uploadingFileMap,d.id,d),o.on(dsf.SplitUploader.EVENT_TYPE.speed,(function(e){var t=e.progress,a=e._speed;i.$set(d.status,"speed",100==t?"合并文件...":a)})),o.on(dsf.SplitUploader.EVENT_TYPE.uploading,(function(e){var t=e._loaded,a=e._speed,s=e.progress;i.$set(d,"status",{progress:s,_progress:parseInt(s),speed:100==s?"合并文件...":a,loaded:t,type:"uploading"})})),o.on(dsf.SplitUploader.EVENT_TYPE.finish,function(){var e=r()(u.a.mark((function e(t){var a,s,l;return u.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(i.$refs.upload.uploadFiles=[],t=t[0],!i.canCutVideo||"mp4"!=c){e.next=7;break}return e.next=5,i.videoIsCut(t);case 5:a=e.sent,i.$set(i.cutSuccessMap,t.id,!!a);case 7:s=_.findIndex(i.orders,(function(e){return e==d.id})),i.orders[s]=t.id,i.$delete(i.uploadingFileMap,d.id),l=i.updateValue(p(p({},t),{},{isNew:!0})),o=void 0,i.$nextTick((function(){i.$dispatch("upload-file-complete",l)}));case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),o.on(dsf.SplitUploader.EVENT_TYPE.suspend,(function(e){var t=e._loaded,a=e._speed,s=e.progress;i.$set(d,"status",{progress:s,_progress:parseInt(s),speed:a,loaded:t,type:"suspend"})})),o.on(dsf.SplitUploader.EVENT_TYPE.error,(function(e){i.$refs.upload.uploadFiles=[],i.$set(d,"status",{progress:0,_progress:0,speed:"",loaded:n.size,type:"error",errorMsg:void 0===e.stack?e.message:"请求异常"}),i.$nextTick((function(){i.$dispatch("upload-file-error",n)}))})),o.on(dsf.SplitUploader.EVENT_TYPE.stop,(function(){i.$refs.upload.uploadFiles=[],o=void 0}));case 15:case"end":return a.stop()}}),a)})))()},getFileSize:function(e){var t=parseInt(e);return(t||e.indexOf("M")>-1||e.indexOf("m")>-1)&&(t*=1024),t},getFileSuffix:function(e){var t="",i=e.lastIndexOf(".");return i>0&&(t=e.substring(i+1).toLowerCase()),t},showOnlineEdit:function(e){return!!this.canOnlineEdit&&(!this.readonly&&f.indexOf(e.suffix)>=0)},rowBtClickUp:function(e,t){if(0!==t){var i=this.orders[t-1],a=this.orders[t];this.orders[t-1]=a,this.orders[t]=i,this.updateValue()}},rowBtClickEditFileName:function(e,t){var i=this,a=e.name,s=this;dsf.layer.pc.prompt({title:"修改文件名称",inputValue:a,closeOnClickModal:!1,inputValidator:function(e){return e?(a=e,!0):"不能为空"}}).then((function(){i.$http.post("/file/updateFileName",{dmId:e.id,originalFileName:a+"."+e.suffix,contentType:e.contentType,size:e.size}).then((function(t){var i=t.data,a=i.success,l=i.message;a?(e.name=i.data[0].name,e.originalFileName=i.data[0].originalFileName,s.$forceUpdate()):dsf.layer.message(l||"请求异常",!1)}))})).catch((function(){}))},rowBtClickDown:function(e,t){if(t+1<this.orders.length){var i=this.orders[t],a=this.orders[t+1];this.orders[t]=a,this.orders[t+1]=i,this.updateValue()}},rowBtClickPreview:function(e,t){var i=dsf.config.setting_public_file_host,a=this.$getWebPath(e.relativePath,!0);if(this.$listeners["file-view"])this.$dispatch("file-view",e);else{var s=h.find((function(t){return t===e.suffix.toLocaleLowerCase()}));if(s&&m.length&&this.isViewImages)this.imagesView(a);else{var l,n,o="".concat(i,"/view/").concat(null===(l=this.$vm)||void 0===l?void 0:l.nameSpace,"/").concat(null===(n=this.$vm)||void 0===n?void 0:n.pageName,"/upload/file/").concat(e.suffix,"/").concat(e.id);o="/preview/file?url="+encodeURIComponent(o),dsf.isMultiPage()?(o="#/iframeloader?src="+encodeURIComponent(o),_spv_.openPage({name:e.id,url:o,tagName:"文件预览"})):this.$openWindow({url:o,name:e.id})}}},rowBtClickDownload:function(e,t){var i,a;this.$listeners["file-download"]?this.$dispatch("file-download",e):dsf.file.download.call(this,"/file/download",{files:e.id,zipName:e.name,namespace:null===(i=this.$vm)||void 0===i?void 0:i.nameSpace,pageName:null===(a=this.$vm)||void 0===a?void 0:a.pageName,caption:this.caption},e.originalFileName,!0)},rowBtClickUpload:function(e,t){var i=this;dsf.file.load(this.acceptMime).then((function(t){!1!==i.beforeUpload(t,e.id)&&i.httpRequest({file:t},e.id)}))},rowBtClickDelete:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];!1!==i?dsf.layer.confirm("确定要删除【".concat(e.originalFileName,"】文件吗?")).then((function(){dsf.array.remove(t.orders,e.id),t.updateValue(),t.$nextTick((function(){t.$dispatch("file-remove",e)}))})).catch((function(e){return e})):(dsf.array.remove(this.orders,e.id),this.updateValue(),this.$nextTick((function(){t.$dispatch("file-remove",e)})))},rowBtClickVideoSlicing:function(e,t){var i=this,a="/slice/manual/video/".concat(e.id);if(this.$listeners["cut-file"])this.$dispatch("cut-file",e);else{var s=dsf.layer.loading();this.$http.get(a).done((function(t){var a=t.success,s=t.message;a?(i.$set(i.cutSuccessMap,e.id,!0),dsf.layer.message("视频切片发起成功！")):dsf.layer.message(s||"视频切片失败，请稍后再试",!1)})).error((function(e){dsf.layer.message((null===e||void 0===e?void 0:e.message)||"请求异常",!1)})).always((function(){dsf.layer.closeLoading(s)}))}},rowBtClickEdit:function(e,t){this.wpsOnlineEdit(e)},wpsOnlineEdit:function(e){var t=this;if(window.openOffice)this.onlineEdit(e);else{var i=[this.$getWebPath("$/js/libs/wpsOnlineEdit/static/js/json2.js"),this.$getWebPath("$/js/libs/wpsOnlineEdit/static/js/wps_sdk.js"),this.$getWebPath("$/js/libs/wpsOnlineEdit/static/js/wpsjsrpcsdk.js"),this.$getWebPath("$/js/libs/wpsOnlineEdit/static/js/wps-new.js"),this.$getWebPath("$/js/libs/wpsOnlineEdit/static/js/office-edit-wps.js")];this.$http.importFiles(i).then((function(){t.onlineEdit(e)})).catch((function(e){dsf.httpError("加载在线编辑插件出错",!1)}))}},onlineEdit:function(e){var t,i,a=this;window.openOffice&&this.$http.get("file/getAuthCode",{files:[e.id],namespace:null===(t=this.$vm)||void 0===t?void 0:t.nameSpace,pageName:null===(i=this.$vm)||void 0===i?void 0:i.pageName,caption:this.caption}).done((function(t){var i=t.success,s=t.data,l=t.message;if(i){var n=["xls","xlsx"].includes(e.suffix)?"excel":"word",o=e.id,r=e.name,c=dsf.session.get("user_name"),u=dsf.session.get("userId")||dsf.uuid(),d=a.showRevisionMode,p=a.getWebPath("file/downloadFile?code="+s),f={userName:c,userId:u,saveAsFileName:r,newFileName:r,realFileName:r,fileName:p,closeUrl:a.getWebPath("office/closeOffice"),uploadPath:a.getWebPath("office/saveOffice?fileId="+o),printWatermark:!1,buttonGroups:"",docId:o,disableBtns:"ExportToPDF,FileSaveAsPicture,SaveAsPicture,ReviewTrackChangesMenu,FileMenuSendMail,ExportToOFD,FileNew,FileOpen",funcs:[{OnOpenRevisionClickedFromWeb:{bShowRevision:d,bOpenRevision:d}},{OnClearRevDocClicked:{bShowRevision:d,bOpenRevision:d}},{setOpenType:{password:"123**",readonly:2,protectType:3,showRevisionMode:d}}],isOA:1};openOffice(f,n)}else dsf.httpError(l)})).error((function(e){dsf.httpError(e)}))},getWebPath:function(e){var t=window.location,i=t.origin;return i||(i=t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")),i+"/"+e},videoIsCut:function(e){var t=this,i="/slice/video/".concat(e.id);if(this.$listeners["video-cut"])return this.$dispatch("video-cut",e),Promise.resolve();var a=dsf.layer.loading();return this.$http.get(i).done((function(e){var i=e.success,a=e.data,s=e.message;if(i){var l=t.getFileSuffix(a.sd.name);return"m3u8"==l}dsf.layer.message("处理mp4文件"+s,!1)})).error((function(e){dsf.layer.message(e.message,!1)})).always((function(){dsf.layer.closeLoading(a)}))},imagesView:function(e){var t=this,i=null,a=[],s=0,l=0;_.forEach(m,(function(n){n.isViewImages&&n.multipleFiles.length&&_.forEach(n.multipleFiles,(function(o){i=h.find((function(e){return e===o.suffix.toLocaleLowerCase()})),i&&(a.push(t.$getWebPath(o.relativePath,!0)),n===t&&t.$getWebPath(o.relativePath,!0)==e&&(l=s),s++)}))})),dsf.layer.imagePreview({images:a,startPosition:l})},clearAll:function(){var e;null===(e=this.$refs.upload)||void 0===e||e.clearFiles(),this.orders=[],this.uploadingFileMap={},this.emitValueChange(JSON.stringify([]))},downLoadAll:function(){if(this.$listeners["file-all-download"])this.$dispatch("file-all-download",this);else{for(var e,t,i=[],a="",s=0;s<this.showMultipleFiles.length;s++){var l=this.showMultipleFiles[s].id,n=this.showMultipleFiles[s].name,o=l+"^"+n;i.push(o)}a=i.join(","),dsf.file.download.call(this,"/file/download",{files:a,zipName:this.zipFileName,initialFileName:this.initialFileName,namespace:null===(e=this.$vm)||void 0===e?void 0:e.nameSpace,pageName:null===(t=this.$vm)||void 0===t?void 0:t.pageName,caption:this.caption},this.zipFileName,!0)}},getFileTitle:function(e){return["".concat(e.name,".").concat(e.suffix),"上传时间：".concat(e.uploadDate),"大小：".concat(this.computeFileSize(e.size))].join("\n")},openSelectFile:function(){this.$refs.upload.$refs["upload-inner"].handleClick()},updateValue:function(e){var t=[],i=_.clone(this.valueMap);e&&(i[e.id]=e),_.each(this.orders,(function(e){var a=i[e];a&&t.push(a)}));var a=JSON.stringify(t);return this.value==a?this.updateKey++:this.emitValueChange(a),t},postBefore:function(){var e=this,t=[];_.forEach(this.multipleFiles,(function(e){""===e.securityLevelValue&&(e.securityLevelValue=-10),e.isNew&&t.push(e.id),delete e.isNew})),this.uploadingFileIds=t,this.updateValue(this.multipleFiles);var i=_.find(this.uploadingFileMap,(function(e){return e.status.type==dsf.SplitUploader.STATUS.readying||e.status.type==dsf.SplitUploader.STATUS.ready||e.status.type==dsf.SplitUploader.STATUS.uploading||e.status.type==dsf.SplitUploader.STATUS.suspend}));return i?new Promise((function(t,i){dsf.layer.confirm({confirmButtonText:"继续",cancelButtonText:"取消",title:"提示",message:"当前有文件正在上传中，继续提交表单，将终止上传，是否继续？"}).then((function(){_.filter(e.uploadingFileMap,(function(e){return!!e.stopHandler})).forEach((function(e){return e.stopHandler()})),t()})).catch((function(){i({type:"nextFalse",message:"当前还有文件正在上传中，终止表单提交。"})}))})):Promise.resolve()},postError:function(){var e=this;_.forEach(this.multipleFiles,(function(t){e.uploadingFileIds.includes(t.id)&&(t.isNew=!0)})),this.uploadingFileIds=[]},validate:function(e){return!e||Number(e)<=Number(this.user_security_level)}}}),v=g,y=(i(667),i(0)),b=Object(y["a"])(v,a,s,!1,null,null,null);t["default"]=b.exports},1089:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"ds-control ds-form-item ds-upload",class:e.getCss},[e.showLabel?i("DsfFieldLabel",{style:e.getLabelWidthStyle(),attrs:{mode:e.showDataCaptionMode,"show-icon":e.showDataCaptionIcon,trigger:e.showDataCaptionTrigger,"data-caption":e.dataCapion,"is-design":e.isDesign,owner:e._self}},[e._v(" "+e._s(e.$t(e.label))+" ")]):e._e(),i("div",{staticClass:"ds-form-block",style:e.getFormItemBlockMarginLeft()},[e.$$readOnly?e._e():i("el-upload",{ref:"upload",staticClass:"upload-demo",style:{visibility:e.$$readOnly?"hidden":"visible"},attrs:{accept:e.acceptMime,multiple:e.multiple,headers:e.headersParam,limit:parseInt(e.uploadFileNum),action:e.setRequestUrl,data:e.extendData,"show-file-list":!1,"before-upload":e.beforeUpload,"on-success":e.handleSuccess,"on-error":e.handleError,"on-exceed":e.handleExceed,"on-progress":e.handleProgress,"auto-upload":e.autoUpload}},[e._t("top",(function(){return[i("dsf-button",{attrs:{icon:"yunduanshangchuan"}},[e._v(" "+e._s(e.showBtnName?e.btnName:"")+" ")])]}))],2),e.allowDownload&&e.multipleFiles&&e.multipleFiles.length>0?i("dsf-button",{staticClass:"ds-button download-button",attrs:{icon:"yunduanxiazai"},on:{click:e.downLoadFn}},[e._v(" 全部下载 ")]):e._e(),!e.isDesign&&e.simple&&e.formatter?[e._v(" "+e._s(e._f("proxy")(e.multipleFiles,e.formatter))+" ")]:e._e(),e.multipleFiles&&e.multipleFiles.length>0?i("div",{staticClass:"img-container"},e._l(e.multipleFiles,(function(t,a){return i("div",{key:t.id,staticClass:"pic"},[i("el-image",{ref:"elImage",refInFor:!0,staticStyle:{width:"130px",height:"92px"},attrs:{src:e.$getWebPath(t.relativePath,!0),alt:t.originalFileName,"preview-src-list":[e.$getWebPath(t.relativePath,!0)],fit:"cover","z-index":e.zIndex},nativeOn:{click:function(t){return e.clickHandler(a,t)}}}),i("div",{staticClass:"title"},[i("p",{staticClass:"file-name ellipsis",attrs:{title:t.originalFileName}},[e._v(" "+e._s(t.originalFileName)+" ")]),e._l(e.handleList,(function(s,l){return["upload2"===l||"scissors"===l||e.$$readOnly?e._e():i("i",{key:l,class:["operation-icon","el-icon-"+l],attrs:{title:s},on:{click:function(i){return e.handleColumnClick(l,t,a,e.multipleFiles)}}}),e.isCutPic&&"scissors"===l&&!e.$$readOnly?i("i",{key:l,staticClass:"operation-icon el-icon-scissors",attrs:{title:s},on:{click:function(i){return e.handleColumnClick(l,t,a,e.multipleFiles)}}}):e._e(),"upload2"!==l||e.$$readOnly?e._e():i("el-upload",{key:l,staticClass:"list-upload",attrs:{accept:e.acceptMime,multiple:!1,headers:e.headersParam,limit:1,action:e.setRequestUrl,data:e.extendData,"show-file-list":!1,"before-upload":e.beforeUpload,"on-success":e.handleSuccess,"on-error":e.handleError,"on-exceed":e.handleExceed,"auto-upload":e.autoUpload}},[i("i",{staticClass:"operation-icon el-icon-upload2",attrs:{title:s},on:{click:function(i){return e.handleColumnClick(l,t,a,e.multipleFiles)}}})])]}))],2)],1)})),0):e._e(),e.description?i("div",{staticClass:"ds-upload-description"},[e._v(e._s(e.description))]):e._e(),e.errors.length>0&&e.multipleFiles.length<=0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e()],2),i("pc-crop-image",{attrs:{"edit-img":e.editImg,"edit-file-img":e.editFileImg,"aspect-ratio":e.aspectRatio,"lock-aspect-ratio":e.lockAspectRatio,"request-url":e.requestUrl||"/file/uploadAuth/","extend-data":e.extendData,format:e.format},on:{saveFile:e.editFile,handleClose:e.handleClose}})],1)},s=[],l=i(2),n=i.n(l),o=i(3),r=i.n(o),c=i(520),u=i.n(c);function d(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function p(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?d(Object(i),!0).forEach((function(t){r()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var f=dsf.component({name:"DsfUploadImg",mixins:[$mixins.formControl],ctrlCaption:"图片上传",props:{label:{type:String,default:"图片上传"},btnName:{type:String,default:"图片上传"},showBtnName:{type:Boolean,default:!0},multiple:{type:Boolean,default:!0},simple:{type:Boolean,default:!1},uploadFileNum:{type:[Number,String],default:2},maxFileSize:{type:[Number,String],default:0},zipFileName:{type:String,default:""},required:{type:Boolean,default:!1},isCutPic:{type:Boolean,default:!0},aspectRatio:{type:String,default:"1/1"},lockAspectRatio:{type:Boolean,default:!0},requestUrl:{type:String,default:""},extsSetting:{type:Object,default:function(){return{}}},description:{type:String,default:""},metadata:{type:Object,default:function(){return dsf.metadata.get("photo-meta-data")}},isStatic:{type:Boolean,default:!1},isPublic:{type:Boolean,default:!0},format:{type:String,default:"image/jpeg"},initialFileName:{type:Boolean,default:!0},uploadFileExts:{type:String,default:".bmp,.jpg,.jpeg,.png,.gif"},allowDownload:{type:Boolean,default:!0},formatter:{type:String,default:"multipleFiles^originalFileName"}},data:function(){return{loading:!1,autoUpload:!0,isShowDownloadBtn:!1,uploadFileType:"file",acceptMime:"",headersParam:p({"X-XSRF-TOKEN":dsf.getCookie("XSRF-TOKEN")||""},dsf.getTokenHttpHeader()),defaultcover:u.a,handleList:{back:"左移",right:"右移",delete:"删除",scissors:"裁剪",upload2:"重新上传"},isCutSuccess:!1,editImg:!1,editFileImg:{},cropper:"",uploadFile:{status:!1,index:0},zIndex:99999}},created:function(){this.rebuildDialogData(),this.$messageTips=_.debounce(this.messageTips,50)},computed:{setRequestUrl:function(){return this.$getWebPath(this.requestUrl||"/file/uploadAuth/",!0)},multipleFiles:{get:function(){var e=[];return""!==this.value&&dsf.isDef(this.value)&&"string"===typeof this.value&&(e=JSON.parse(this.value)),e},set:function(e){this.emitValueChange(JSON.stringify(e))}},extendData:function(){var e=this.isStatic,t=this.isPublic,i={isStatic:Number(e),isPublic:Number(t)};return this.$vm&&(i["namespace"]=this.$vm.nameSpace,i["pageName"]=this.$vm.pageName,i["caption"]=this.caption),i},uploadFileExtsV:function(){return this.uploadFileExts}},methods:{beforeUpload:function(e){var t;if(this.uploadFileNum==this.multipleFiles.length&&!this.uploadFile.status)return dsf.layer.message("当前限制选择最多 ".concat(this.uploadFileNum," 个文件"),!1),!1;if(this.uploadFileExtsV){var i,a,s=e.name.lastIndexOf("."),l="";s>0&&(l=e.name.substring(s).toLowerCase());var n=_.filter((null===this||void 0===this||null===(i=this.uploadFileExtsV)||void 0===i||null===(a=i.split)||void 0===a?void 0:a.call(i,","))||[],(function(e){return e}));if(!~n.indexOf(l))return dsf.layer.message("选择文件中包含不支持的文件格式,请选择包含这些格式的文件：".concat(this.uploadFileExtsV),!1),!1}var o=this.maxFileSize?this.getFileSize(this.maxFileSize):"",r=!o||e.size/1024<o;return r?null!==(t=this.uploadFile)&&void 0!==t&&t.status||!_.some(this.multipleFiles,["originalFileName",e.name])?void 0:(setTimeout((function(){dsf.layer.message("已存在文件【".concat(e.name,"】，请修改后重新上传"),!1)}),0),!1):(dsf.layer.message("文件大小不能超过".concat(parseInt(this.maxFileSize),"MB"),!1),!1)},handleProgress:function(){this.loading=!0},handleSuccess:function(e,t,i){if(this.loading=!1,e.success&&2e4==e.state){var a=e.data[0];if(this.uploadFile.status)i.splice(this.uploadFile.index,1),this.multipleFiles.splice(this.uploadFile.index,1,a),this.uploadFile.status=!1,this.emitValueChange(JSON.stringify(this.multipleFiles)),dsf.layer.message("替换成功");else{var s;if(this.uploadFileNum==this.multipleFiles.length)dsf.layer.message("当前限制选择最多 ".concat(this.uploadFileNum," 个文件"),!1),this.multipleFiles.slice(0,this.uploadFileNum);else(s=this.multipleFiles).push.apply(s,n()(e.data)),this.$messageTips&&this.messageTips(a);this.emitValueChange(JSON.stringify(this.multipleFiles))}}else this.$message(e.message||"上传失败",!1),dsf.array.remove(i,t)},messageTips:function(e){dsf.layer.message("【"+e.originalFileName+"】上传成功!")},handleError:function(e,t,i){this.loading=!1;var a=JSON.parse(JSON.stringify(e));"404"==a.status?dsf.layer.message("服务器异常",!1):dsf.layer.message("上传异常",!1)},handleExceed:function(e,t){dsf.layer.message("当前限制选择最多 ".concat(this.uploadFileNum," 个文件"),!1)},getFileSize:function(e){var t=parseInt(e);return(t||e.indexOf("M")>-1||e.indexOf("m")>-1)&&(t=1024*parseInt(e)),t},handleColumnClick:function(e,t,i){var a=this,s={back:function(){if(0!==i){var e=a.multipleFiles[i-1];a.multipleFiles.splice(i-1,1),a.multipleFiles.splice(i,0,e),a.emitValueChange(JSON.stringify(a.multipleFiles))}},right:function(){if(i+1!==a.multipleFiles.length){var e=a.multipleFiles[i+1];a.multipleFiles.splice(i+1,1),a.multipleFiles.splice(i,0,e),a.emitValueChange(JSON.stringify(a.multipleFiles))}},delete:function(){dsf.layer.confirm("确定要删除【".concat(t.originalFileName,"】文件吗?")).then((function(){a.$refs.upload.uploadFiles.splice(i,1),a.multipleFiles.splice(i,1),a.emitValueChange(JSON.stringify(a.multipleFiles))})).catch((function(e){return e}))},scissors:function(){a.editFileImg="",a.editImg=!0,a.editFileImg=t,a.uploadFile.index=i},upload2:function(){a.uploadFile={status:!0,index:i}}};s[e]&&s[e]()},editFile:function(e){this.editImg=!1,this.multipleFiles.splice(this.uploadFile.index,1,e),this.uploadFile.status=!1,this.emitValueChange(JSON.stringify(this.multipleFiles))},handleClose:function(){this.editImg=!1},computeFileSize:function(e){var t="";return t=parseInt(e)>105e4?(e/Math.pow(1024,2)).toFixed(2)+"M":(e/Math.pow(1024,1)).toFixed(2)+"K",t},downLoadFn:function(){if(this.$listeners["file-all-download"])this.$dispatch("file-all-download",this);else{for(var e,t,i=[],a="",s=0;s<this.multipleFiles.length;s++){var l=this.multipleFiles[s].id,n=this.multipleFiles[s].name,o=l+"^"+n;i.push(o)}a=i.join(","),dsf.file.download.call(this,"/file/download",{files:a,zipName:this.zipFileName,initialFileName:this.initialFileName,namespace:null===(e=this.$vm)||void 0===e?void 0:e.nameSpace,pageName:null===(t=this.$vm)||void 0===t?void 0:t.pageName,caption:this.caption},this.zipFileName,!0)}},rebuildDialogData:function(){if(this.extsSetting.extStr){var e=this.extsSetting;this.uploadFileType=e.fileType,this.isLinkeMine=e.isLinkeMine,this.uploadFileExtsV=e.extStr,this.acceptMime=e.mineStr}},clickHandler:function(e,t){var i=this.$refs.elImage[e],a=i.$children.length?i.$children[0]:null,s=t.target;s.className.indexOf("el-image__preview")>-1&&!a.toBody&&(document.body.appendChild(a.$el),a.toBody=!0),this.$nextTick((function(){$(".el-image-viewer__mask").click((function(){i.closeViewer()}))}))}}}),h=f,m=(i(669),i(0)),g=Object(m["a"])(h,a,s,!1,null,null,null);t["default"]=g.exports},1090:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("DsfFormControlBox",{staticClass:"ds-control ds-upload",attrs:{owner:e._self},scopedSlots:e._u([{key:"simple",fn:function(){return[i("DsfTextProxy",e._b({model:{value:e.value,callback:function(t){e.value=t},expression:"value"}},"DsfTextProxy",e._self.$props,!1)),e._t("error",(function(){return[e.errors.length>0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e()]}))]},proxy:!0},{key:"content",fn:function(){return[i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"ds-form-item",class:e.getCss},[i("el-upload",{ref:"upload",class:[{"avatar-uploader":e.switchMode},"upload-demo",e.classObject],style:{width:e.switchMode?e.imgWidth+"px":"",height:e.switchMode?e.imgHeight+"px":""},attrs:{disabled:e.$$disabled,accept:e.uploadFileExts,multiple:!1,headers:e.headersParam,action:e.setRequestUrl,data:e.extendData,"show-file-list":!1,"before-upload":e.beforeUpload,"on-success":e.handleSuccess,"on-error":e.handleError,"on-progress":e.handleProgress,"auto-upload":e.autoUpload}},[e.switchMode?[e.multipleFiles.length&&!e.isImageLoadError?i("img",{staticClass:"avatar",attrs:{src:e.$getWebPath(e.multipleFiles[0].relativePath,!0),fit:"cover"},on:{error:e.imageLoadError,load:e.imageLoadSuccess}}):[e.useDefultHeader?i("img",{staticClass:"avatar",attrs:{src:e.defaultUserIcon,fit:"cover"}}):i("img",{staticClass:"avatar",attrs:{src:e.imageUrl[e.defaultImg],fit:"cover"}}),e.isShowTips?i("p",{staticClass:"tips"},[e._v(" "+e._s("长 * 宽："+e.imgWidth+"px * "+e.imgHeight+"px")+" ")]):e._e()]]:[i("el-button",{staticClass:"ds-button",attrs:{type:"primary"}},[i("i",{staticClass:"el-icon-upload el-icon--left"}),e._v(" "+e._s(e.btnName)+" ")])]],2),e.showPhotoText?i("span",{staticStyle:{color:"red","text-align":"left"}},[e._v(e._s(e.tipsPhotoText))]):e._e(),e.errors.length>0&&e.multipleFiles.length<=0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e(),i("pc-crop-image",{attrs:{"show-tips-text":e.showTipsText,"tips-text":e.tipsText,"edit-img":e.editImg,"edit-file-img":e.editFileImg,"aspect-ratio":e.aspectRatio,"lock-aspect-ratio":e.lockAspectRatio,"request-url":e.requestUrl||"/file/uploadAuth/","extend-data":e.extendData,format:e.format},on:{saveFile:e.editFile,handleClose:e.handleClose}})],1)]},proxy:!0}],null,!0)})},s=[],l=i(3),n=i.n(l),o=i(671),r=i.n(o),c=i(520),u=i.n(c),d=i(672),p=i.n(d);function f(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?f(Object(i),!0).forEach((function(t){n()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):f(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var m=dsf.component({name:"DsfUploadPhoto",mixins:[$mixins.formControl],ctrlCaption:"上传照片",props:{label:{type:String,default:"上传照片"},showLabel:{type:Boolean,default:!1},btnName:{type:String,default:"上传照片"},isShowTips:{type:Boolean,default:!0},isCutPic:{type:Boolean,default:!0},imgWidth:{type:[Number,String],default:"180"},imgHeight:{type:[Number,String],default:"230"},maxFileSize:{type:[Number,String],default:2048},minFileSize:{type:String,default:"0"},required:{type:Boolean,default:!1},defaultImg:{type:[Number,String],default:"0"},photoCard:{type:String,default:""},hasPadding:{type:[Boolean,Number,String],default:!0},hasBorder:{type:[Boolean,Number,String],default:!0},aspectRatio:{type:String,default:"1/1"},lockAspectRatio:{type:Boolean,default:!0},switchMode:{type:Boolean,default:!0},requestUrl:{type:String,default:""},showPhotoText:{type:Boolean,default:!1},tipsPhotoText:{type:String,default:"请上传0.5-2MB大小，JPG、JPEG、PNG格式的免冠证件照"},showTipsText:{type:Boolean,default:!1},tipsText:{type:String,default:"请将照片放于深色区域内"},metadata:{type:Object,default:function(){return dsf.metadata.get("photo-meta-data",{valueAttributes:[{name:"上传照片",code:"photo",type:dsf.metadata.getDataType("object"),length:500,defaultValue:null,unit:null,textType:"JSON"}]})}},isStatic:{type:Boolean,default:!1},isPublic:{type:Boolean,default:!0},format:{type:String,default:"image/jpeg"},useDefultHeader:{type:Boolean,default:!1},formatter:{type:String,default:"multipleFiles^originalFileName"}},watch:{defaultImg:function(e){this.$emit("update:imgWidth",[180,120][3===Number(e)?1:0]),this.$emit("update:imgHeight",[230,120][3===Number(e)?1:0])}},data:function(){return{loading:!1,autoUpload:!0,uploadFileExts:".jpg,.jpeg,.png,.gif",acceptMime:"",headersParam:h({"X-XSRF-TOKEN":dsf.getCookie("XSRF-TOKEN")||""},dsf.getTokenHttpHeader()),imageUrl:[],editImg:!1,editFileImg:{},isImageLoadError:!1}},created:function(){var e;this.imageUrl=[r.a,u.a,null===(e=dsf.config)||void 0===e?void 0:e[this.photoCard],p.a],this.isDesign&&(dsf.isBoolean(this.hasPadding)||this.$emit("update:hasPadding","1"==this.hasPadding),dsf.isBoolean(this.hasBorder)||this.$emit("update:hasBorder","1"==this.hasBorder))},computed:{setRequestUrl:function(){return this.$getWebPath(this.requestUrl||"/file/uploadAuth/",!0)},multipleFiles:{get:function(){var e=[];return""!==this.value&&dsf.isDef(this.value)&&"string"===typeof this.value&&(e=JSON.parse(this.value)),e},set:function(e){this.emitValueChange(JSON.stringify(e))}},classObject:function(){return{padding:!0===this.hasPadding||"1"==this.hasPadding,border:!0===this.hasBorder||"1"==this.hasBorder}},extendData:function(){var e=this.isStatic,t=this.isPublic,i={isStatic:Number(e),isPublic:Number(t)};return this.$vm&&(i["namespace"]=this.$vm.nameSpace,i["pageName"]=this.$vm.pageName,i["caption"]=this.caption),i},defaultUserIcon:function(){var e=dsf.config.setting_public_user_default_header;return this.$replace(e)}},methods:{beforeUpload:function(e){if(this.uploadFileExts){var t,i,a=e.name.lastIndexOf("."),s="";a>0&&(s=e.name.substring(a).toLowerCase());var l=_.filter((null===this||void 0===this||null===(t=this.uploadFileExts)||void 0===t||null===(i=t.split)||void 0===i?void 0:i.call(t,","))||[],(function(e){return e}));if(!~l.indexOf(s))return dsf.layer.message("选择文件中包含不支持的文件格式,请选择包含这些格式的文件：".concat(this.uploadFileExts),!1),!1}var n=_.isNaN(parseInt(this.minFileSize))?0:1024*parseInt(this.minFileSize),o=!n||e.size>n,r=this.maxFileSize+"",c=r.toLocaleLowerCase().indexOf("m")>-1?1024*parseInt(r)*1024:1024*parseInt(r),u=_.isNaN(parseInt(r))?0:c,d=!u||e.size<u;if(!d||!o){var p=o?["大于",u]:["小于",n];return dsf.layer.message("文件大小不能".concat(p[0]).concat(this.formatBytes(p[1])),!1),!1}},formatBytes:function(e,t){if(0==e)return"0 B";var i=1024,a=t||2,s=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],l=Math.floor(Math.log(e)/Math.log(i));return parseFloat((e/Math.pow(i,l)).toFixed(a))+" "+s[l]},handleProgress:function(){this.loading=!0},handleSuccess:function(e){if(this.loading=!1,e.success&&2e4==e.state)if(this.isCutPic)this.editImg=!0,this.editFileImg=e.data[0];else if(this.multipleFiles.push(e.data[0]),this.multipleFiles.length>1){var t=this.multipleFiles.splice(1,1);this.emitValueChange(JSON.stringify(t))}else this.emitValueChange(JSON.stringify(this.multipleFiles));else this.$message(e.message||"上传失败",!1)},handleError:function(){this.loading=!1,dsf.layer.message("上传失败",!1)},getFileSize:function(e){var t=parseInt(e);return(e.indexOf("M")>-1||e.indexOf("m")>-1)&&(t=1024*parseInt(e)),t},editFile:function(e){if(this.editImg=!1,this.multipleFiles.push(e),this.isImageLoadError=!1,this.multipleFiles.length>1){var t=this.multipleFiles.splice(1,1);this.emitValueChange(JSON.stringify(t))}else this.emitValueChange(JSON.stringify(this.multipleFiles))},handleClose:function(){this.editImg=!1},getPhoto:function(e){var t=this;if(!e||"[]"===e||_.isEqual(e,[]))return[];var i=_.isArray(e)?e:JSON.parse(e);return i.map((function(e){return e.relativePath?t.$getWebPath(e.relativePath,!0):e}))},imageLoadSuccess:function(){this.isImageLoadError=!1},imageLoadError:function(){this.isImageLoadError=!0}}}),g=m,v=(i(673),i(0)),y=Object(v["a"])(g,a,s,!1,null,null,null);t["default"]=y.exports},1091:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"ds-control ds-form-item ds-customer-img",class:e.getCss,style:e.containerSty},[e.showLabel?i("DsfFieldLabel",{style:e.getLabelWidthStyle(),attrs:{mode:e.showDataCaptionMode,"show-icon":e.showDataCaptionIcon,trigger:e.showDataCaptionTrigger,"data-caption":e.dataCapion,"is-design":e.isDesign,owner:e._self}},[e._v(" "+e._s(e.$t(e.label))+" ")]):e._e(),e.readOnly?[i("div",{staticClass:"left"},[i("div",{staticClass:"canvas-box"},[i("dsf-image",{ref:"img",style:e.canvasSty,attrs:{src:e.readonlySrc}}),i("div",{staticClass:"tips"},[e._v("宽 * 高："+e._s(e.width)+"px * "+e._s(e.height)+"px")])],1),e._t("error",(function(){return[e.errors.length>0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e()]}))],2)]:[i("div",{staticClass:"left"},[i("div",{staticClass:"canvas-box"},[i("canvas",{ref:"canvas",style:e.canvasSty,attrs:{width:e.width+"px",height:e.height+"px"}}),i("div",{staticClass:"tips"},[e._v("宽 * 高："+e._s(e.width)+"px * "+e._s(e.height)+"px")])]),e.isCutPic?e._e():i("div",{staticClass:"warning"},[e._v("请上传 "+e._s(e.maxFileSize)+"kb 大小以内的图片")]),e._t("error",(function(){return[e.errors.length>0?i("div",{staticClass:"ds-error-text"},[e._v(" "+e._s(e.errorsMsg)+" ")]):e._e()]}))],2),e.readOnly?e._e():i("div",{staticClass:"right"},[i("input",{ref:"uploadFile",staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*"}}),i("dsf-button",{attrs:{title:e.tip,icon:"yunduanshangchuan"},on:{click:e.preUpload}},[e._v("点击上传")]),i("div",{staticClass:"right-item"},[i("label",[e._v("显示文字")]),i("div",{staticClass:"input-box"},[i("el-input",{attrs:{placeholder:"请输入"},on:{change:e.textChangeHandler},model:{value:e.tempValue.text,callback:function(t){e.$set(e.tempValue,"text",t)},expression:"tempValue.text"}})],1)]),i("div",{staticClass:"right-item"},[i("label",[e._v("字体设置")]),i("div",{staticClass:"select-box"},[i("el-select",{model:{value:e.tempValue.fontFamily,callback:function(t){e.$set(e.tempValue,"fontFamily",t)},expression:"tempValue.fontFamily"}},e._l(e.fontList,(function(e){return i("el-option",{key:e.val,attrs:{value:e.val,label:e.txt}})})),1)],1),i("el-input-number",{attrs:{controls:!1,min:0,precision:0},model:{value:e.tempValue.fontSize,callback:function(t){e.$set(e.tempValue,"fontSize",t)},expression:"tempValue.fontSize"}}),i("el-button",{style:e.boldBtnSty,on:{click:e.setBold}},[i("span",{staticClass:"icon iconfont"},[e._v("")])]),i("el-button",{style:e.italicBtnSty,on:{click:e.setItalic}},[i("span",{staticClass:"icon iconfont"},[e._v("")])]),i("el-color-picker",{attrs:{value:e.tempValue.fill},on:{"active-change":e.chooseTextColor,change:e.changeTextColor}})],1),i("div",{staticClass:"right-item"},[i("div",{staticClass:"group"},[i("label",[e._v("文字底色")]),i("el-color-picker",{attrs:{value:e.tempValue.textBackgroundColor},on:{"active-change":e.chooseTextBgColor,change:e.changeTextBgColor}})],1),i("div",{staticClass:"group"},[i("label",[e._v("背景颜色")]),i("el-color-picker",{attrs:{value:e.tempValue.backgroundColor},on:{"active-change":e.chooseBgColor,change:e.changeBgColor}})],1)])],1)],e.ready?i("picture-cut-dialog",{attrs:{src:e.src,width:e.width,height:e.height,"dialog-visible":e.dialogVisible},on:{"update:src":function(t){e.src=t},"cut-img":e.cutImg,"dialog-close":e.dialogClose}}):e._e()],2)},s=[],l=i(3),n=i.n(l),o=i(394);function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){n()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var u={text:"",fontFamily:"SimSun",fontSize:18,fontWeight:"normal",fontStyle:"normal",backgroundImage:"",fill:"#000",borderColor:"#FF0000",cornerStrokeColor:"#FF0000",transparentCorners:!1,cornerSize:10,originX:"center",originY:"center",backgroundColor:null,textBackgroundColor:null},d=dsf.component({name:"DsfCustomerImg",mixins:[$mixins.formControl],ctrlCaption:"封面设置",props:{simple:{type:Boolean,default:!1},width:{type:Number,default:300},height:{type:Number,default:200},maxFileSize:{type:Number,default:2048},metadata:{type:Object,default:function(){return dsf.metadata.get("customer-img-meta-data")}},isCutPic:{type:Boolean,default:!0},readOnly:{type:Boolean,default:!1},value:{type:String,default:null},isStatic:{type:Boolean,default:!1},isPublic:{type:Boolean,default:!0}},data:function(){return{ready:!1,src:"",dialogVisible:!1,upFileUrl:"/file/upload/",upBase64Url:"file/base64Img",fabricCanvas:null,fabricText:null,tempValue:_.clone(u),fontList:[{val:"SimSun",txt:"宋体"},{val:"FangSong",txt:"仿宋"},{val:"KaiTi",txt:"楷书"},{val:"SimHei",txt:"黑体"},{val:"Microsoft YaHei",txt:"微软雅黑"},{val:"YouYuan",txt:"幼圆"}],sizeList:[14,16,18,22,24],isFirst:!0,readonlySrc:null}},computed:{canvasSty:function(){return"width: ".concat(this.width,"px; height: ").concat(this.height,"px")},containerSty:function(){var e=this.isDesign?"20px":0;return"margin-top: ".concat(e)},tip:function(){return"只能上传图片类型的文件，大小不得超过".concat(this.maxFileSize,"kb")},boldBtnSty:function(){return"bold"===this.tempValue.fontWeight?"background: #ff7200;color: #ffffff; border-color: #ff7200":"background: #ffffff; color: #606266; border-color: #DCDFE6"},italicBtnSty:function(){return"italic"===this.tempValue.fontStyle?"background: #ff7200;color: #ffffff; border-color: #ff7200":"background: #ffffff; color: #606266; border-color: #DCDFE6"},extendData:function(){var e=this.isStatic,t=this.isPublic,i={isStatic:Number(e),isPublic:Number(t)};return e&&this.$vm&&(i["namespace"]=this.$vm.nameSpace,i["pageName"]=this.$vm.pageName),i}},watch:{value:{handler:function(e){var t;this.isFirst&&e?this.initComponent(e):null===(t=this.$updateComponent)||void 0===t||t.call(this,e)},immediate:!0},tempValue:{handler:function(){window.fabric&&this.renderText()},deep:!0}},created:function(){this.isDesign||(this.$updateComponent=_.throttle(this.updateComponent,500,{leading:!1,trailing:!0}))},mounted:function(){var e=this;this.isDesign||Object(o["c"])((function(t){e.Tool=t.Tool,e.ready=!0,e.$nextTick((function(){e.createFabric()}))}))},methods:{reset:function(){this.emitValueChange(null),this.$updateComponent()},textChangeHandler:function(e){var t,i;e&&this.errors.length&&(null===(t=(i=this.$vm).removeErrorsByTarget)||void 0===t||t.call(i,this.$formName))},cutImg:function(e){f.call(this,e)},preUpload:function(){var e=this,t=$(e.$refs.uploadFile);t.on("change",(function(){if($(this).val()){var i=$(this)[0].files[0];if(e.isCutPic)e.src=URL.createObjectURL(i),e.dialogVisible=!0;else{if(i.size/1024>e.maxFileSize)return dsf.layer.message("文件大小超过".concat(e.maxFileSize,"kb!"),!1),t.val(""),!1;f.call(e,i)}}})),t.click()},setBold:function(){this.tempValue.fontWeight="normal"===this.tempValue.fontWeight?"bold":"normal"},setItalic:function(){this.tempValue.fontStyle="normal"===this.tempValue.fontStyle?"italic":"normal"},createFabric:function(e){var t=this,i=function(){t.fabricCanvas=t.fabricCanvas||new window.fabric.Canvas(t.$refs.canvas),e?t.renderByHistory(e):t.renderByEmpty()};if(window.fabric)i();else{var a=dsf.url.getWebPath("$/js/libs/fabric/fabric.js");this.$http.importFiles([a]).then(i).catch((function(e){dsf.layer.message("加载fabric文件报错",!1)}))}},changeTextColor:function(e){this.tempValue.fill=e},changeTextBgColor:function(e){this.tempValue.textBackgroundColor=e},changeBgColor:function(e){this.tempValue.backgroundColor=e},renderByEmpty:function(){this.renderText()},renderByHistory:function(e){var t=this;t.fabricCanvas.loadFromJSON(e,(function(){t.fabricText=t.fabricCanvas.getObjects("text")[0],t.fabricCanvas.renderAll(),t.$dispatch("get-history",e)}))},renderText:function(){var e=this;e.fabricCanvas.set("backgroundColor",e.tempValue.backgroundColor);var t=_.pickBy(e.tempValue,(function(e,t){return"backgroundImage"!==t&&"backgroundColor"!==t}));e.tempValue.text||(e.fabricCanvas.remove(e.fabricText),e.fabricText=null),e.fabricText?e.fabricText.set(t):(_.assign(t,{left:Math.floor(e.width/2),top:Math.floor(e.height/2)}),e.fabricText=new window.fabric.Text(e.tempValue.text,t),e.fabricCanvas.add(e.fabricText)),e.fabricCanvas.renderAll()},postBefore:function(){var e=this;if(!this.readOnly){if(this.tempValue.text||this.fabricCanvas.backgroundImage)return new Promise((function(t,i){var a,s,l=null;try{l=e.fabricCanvas.toDataURL()}catch(o){return i(o),void console.error(o)}var n=e.Tool.base64ToBlob(l,"image/png");n.name=dsf.uuid(32)+".png",e.$http.upload(e.upFileUrl,c(c({},e.extendData),{},{files:n,pageName:(null===(a=e.$vm)||void 0===a?void 0:a.pageName)||"",namespace:(null===(s=e.$vm)||void 0===s?void 0:s.namespace)||""})).done((function(a){var s=a.success,l=a.data,n=a.message;if(!s)return dsf.layer.message(n||"上传封面失败",!1),void i(n);e.tempValue.outputImage=l[0].relativePath;var o={pageInfo:e.tempValue,canvasInfo:e.fabricCanvas.toJSON()};e.emitValueChange(JSON.stringify(o)),e.$nextTick((function(){t()}))})).error((function(e){dsf.layer.message("封面上传发生未知异常",!1),i(e)}))}));this.emitValueChange("")}},chooseTextColor:function(e){this.tempValue.fill=p(e)},chooseBgColor:function(e){this.tempValue.backgroundColor=p(e)},chooseTextBgColor:function(e){this.tempValue.textBackgroundColor=p(e)},initComponent:function(e){if(this.isFirst=!1,!this.isDesign){var t=e&&JSON.parse(e)||{};if(this.readOnly){var i=t.pageInfo;i&&i.outputImage&&(this.readonlySrc=i.outputImage)}else{if(dsf.isEmptyObject(t))return void this.createFabric();var a=t.pageInfo,s=t.canvasInfo;this.tempValue=_.assign({},this.tempValue,a),this.createFabric(s)}}},updateComponent:function(e){if(!this.isDesign){var t=e&&JSON.parse(e)||{};if(!this.readOnly){if(dsf.isEmptyObject(t))return this.tempValue=_.clone(u),this.fabricCanvas.setBackgroundImage(null),void this.renderText();var i=t.pageInfo,a=t.canvasInfo;this.tempValue=_.assign({},this.tempValue,i),this.renderByHistory(a)}}},dialogClose:function(){this.dialogVisible=!1,URL.revokeObjectURL(this.src),this.src=""}}});function p(e){for(var t=e.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),i="#",a=0;a<t.length;a++){var s=Number(t[a]).toString(16);s.length<2&&(s="0"+s),i+=s}return 7!==i.length&&(i=e),i}function f(e){var t,i,a=this,s=this;s.$http.upload(s.upFileUrl,c(c({},s.extendData),{},{file:e,pageName:(null===(t=s.$vm)||void 0===t?void 0:t.pageName)||"",namespace:(null===(i=s.$vm)||void 0===i?void 0:i.namespace)||""})).done((function(e){if(e.success){s.dialogVisible=!1,s.tempValue.backgroundImage=e.data[0]["absolutePath"];var t=new Image;t.onload=function(){var e,i;(s.fabricCanvas.setBackgroundImage(t.src,s.fabricCanvas.renderAll.bind(s.fabricCanvas),{scaleX:s.width/t.width,scaleY:s.height/t.height}),s.errors.length)&&(null===(e=(i=s.$vm).removeErrorsByTarget)||void 0===e||e.call(i,a.$formName))},t.src=dsf.url.getWebPath(e.data[0]["relativePath"])}else dsf.layer.message(e.message,!1)})).error((function(e){dsf.layer.message("上传图片失败",!1)})).always((function(){$(s.$refs["uploadFile"]).val("")}))}var h=d,m=(i(675),i(0)),g=Object(m["a"])(h,a,s,!1,null,null,null);t["default"]=g.exports},1092:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.ready?i("el-dialog",{staticClass:"ds-upload",attrs:{width:"800px",title:"图片裁剪","append-to-body":!0,visible:e.editImg,"close-on-click-modal":!1,"before-close":e.handleClose},on:{"update:visible":function(t){e.editImg=t}}},[i("el-container",{staticStyle:{height:"450px"}},[i("el-main",{staticStyle:{padding:"0"}},[i("vue-picture-cut",{ref:"pictureCut",attrs:{src:e.src,format:e.format,"msk-option":e.mskRatio,"menu-thickness":0}})],1),i("el-aside",{staticClass:"edit-img",staticStyle:{width:"200px"}},[i("dsf-title5",{attrs:{value:"旋转","show-color-lump":"","show-weight":""}}),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.rotate(-15)}}},[e._v("顺时针")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.rotate(15)}}},[e._v("逆时针")]),i("dsf-title5",{attrs:{value:"翻转","show-color-lump":"","show-weight":""}}),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:e.scaleH}},[e._v("水平镜像")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:e.scaleV}},[e._v("垂直镜像")]),i("dsf-title5",{attrs:{value:"缩放","show-color-lump":"","show-weight":""}}),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.zoom(.96)}}},[e._v("缩小")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.zoom(1.04)}}},[e._v("放大")]),e.lockAspectRatio?e._e():[i("dsf-title5",{attrs:{value:"裁剪比例","show-color-lump":"","show-weight":""}}),e.aspectRatio?i("dsf-button",{attrs:{title:e.aspectRatio,type:"plain",size:"small"},on:{click:function(t){return e.ratio(e.aspectRatio)}}},[e._v("默认")]):e._e(),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("original")}}},[e._v("自适应")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("1:1")}}},[e._v("1:1")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("4:3")}}},[e._v("4:3")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("3:4")}}},[e._v("3:4")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("16:9")}}},[e._v("16:9")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("9:16")}}},[e._v("9:16")]),i("dsf-button",{attrs:{type:"plain",size:"small"},on:{click:function(t){return e.ratio("3:2")}}},[e._v("3:2")])]],2)],1),i("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[i("div",{directives:[{name:"show",rawName:"v-show",value:e.showTipsText,expression:"showTipsText"}],staticStyle:{position:"absolute","font-size":"26px",left:"30%",color:"red"}},[e._v(e._s(e.tipsText))]),i("dsf-button",{attrs:{type:"plain"},on:{click:e.reset}},[e._v("重 置")]),i("dsf-button",{on:{click:e.saveFileImg}},[e._v("确 定")])],1)],1):e._e()},s=[],l=i(2),n=i.n(l),o=i(4),r=i.n(o),c=i(1),u=i.n(c),d=i(394),p={name:"pcCropImage",inject:{$vm:{default:null}},props:{editImg:{type:Boolean,default:!1},format:{type:String,default:"image/jpeg"},aspectRatio:{type:String,default:""},lockAspectRatio:{type:Boolean,default:!0},editFileImg:{type:Object,default:function(){return{}}},requestUrl:{type:String,default:""},extendData:{type:Object,default:function(){return{}}},showTipsText:{type:Boolean,default:!1},tipsText:{type:String,default:""}},data:function(){return{ready:!1,src:"",mskRatio:{},utils:null,saving:!1}},watch:{editImg:{handler:function(e){e&&this.ready&&this.$nextTick((function(){this.saving=!1,this.loadData()}))},immediate:!0}},created:function(){var e=this;Object(d["c"])((function(t){e.createUtils=t.createUtils,e.ready=!0,e.editImg&&e.$nextTick((function(){this.loadData()}))}))},methods:{loadData:function(){if(this.utils=this.createUtils(this.$refs["pictureCut"]),this.src=this.$getWebPath(this.editFileImg.relativePath,!0),this.aspectRatio){var e=this.getSeparator(this.aspectRatio),t=this.aspectRatio.split(e);this.mskRatio={width:Number(t[0]),height:Number(t[1]),resize:!this.lockAspectRatio}}},saveFileImg:function(){var e=this;return r()(u.a.mark((function t(){var i,a,s,l,n;return u.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.saving){t.next=2;break}return t.abrupt("return");case 2:if(e.saving=!0,t.prev=3,i=e.utils.cut({format:e.format}),!i){t.next=13;break}return l=i.file,l.name=e.editFileImg.originalFileName,t.next=10,dsf.createUploader(l,{owner:e.$vm||null,uploadFileUrl:e.requestUrl||"/file/upload/",extendData:e.extendData,pageName:(null===(a=e.$vm)||void 0===a?void 0:a.pageName)||"",namespace:(null===(s=e.$vm)||void 0===s?void 0:s.nameSpace)||""});case 10:n=t.sent,n.on(dsf.SplitUploader.EVENT_TYPE.finish,(function(t){e.$emit("saveFile",t[0]),n=void 0})),n.on(dsf.SplitUploader.EVENT_TYPE.error,(function(t){dsf.layer.message("裁剪失败："+t.message,!1),n=void 0,e.saving=!1}));case 13:t.next=20;break;case 15:t.prev=15,t.t0=t["catch"](3),e.saving=!1,dsf.layer.message("裁剪失败："+t.t0.message,!1),dsf.error(t.t0);case 20:case"end":return t.stop()}}),t,null,[[3,15]])})))()},rotate:function(e){this.utils.rotate(e,!0)},zoom:function(e){this.utils.scale(e)},scaleV:function(){this.utils.setFlipV(!0)},scaleH:function(){this.utils.setFlipH(!0)},ratio:function(e){if("drag"!=e){var t,i=[];if("original"==e){var a=this.$refs.pictureCut.photoRoot.getEventList("PhotoMain");i=[a.imgRect.w,a.imgRect.h]}else if("custom"==e)i=this.cut.ratio;else{var s=this.getSeparator(e);i=e.split(s).map((function(e){return+e}))}(t=this.utils).setMaskSize.apply(t,n()(i))}},reset:function(){var e=this;this.utils.reset(),setTimeout((function(){e.aspectRatio&&e.ratio(e.aspectRatio)}),100)},handleClose:function(){this.$emit("handleClose")},getSeparator:function(e){return e&&e.indexOf("/")>-1?"/":":"}}},f=p,h=i(0),m=Object(h["a"])(f,a,s,!1,null,null,null);t["default"]=m.exports},1093:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.ready?i("el-dialog",{staticClass:"ds-picture-cut-dialog",attrs:{title:"裁剪图片",visible:e.dialogVisible,"before-close":e.closeDialog,"close-on-click-modal":!1,width:"60%","append-to-body":""},on:{"update:visible":function(t){e.dialogVisible=t},opened:e.dialogOpened},scopedSlots:e._u([{key:"footer",fn:function(){return[i("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取 消")]),i("el-button",{attrs:{type:"primary"},on:{click:e.cutImg}},[e._v("确 定")])]},proxy:!0}],null,!1,4048736834)},[i("el-row",[i("el-col",{staticStyle:{height:"500px"},attrs:{span:16}},[i("vue-picture-cut",{ref:"pictureCut",attrs:{mskOption:{width:e.width,height:e.height,resize:!1},"menu-thickness":0,"max-pixel":Math.min(Math.max(e.width,e.height),1920),src:e.src}})],1),i("el-col",{attrs:{span:7,offset:1}},[i("el-form",{attrs:{"label-width":"90px",size:"small"}},[i("el-form-item",{attrs:{label:"裁剪形状："}},[i("el-radio-group",{model:{value:e.cut.shape,callback:function(t){e.$set(e.cut,"shape",t)},expression:"cut.shape"}},[i("el-radio",{attrs:{label:"rect"}},[e._v("矩形")]),i("el-radio",{attrs:{label:"circle"}},[e._v("椭圆")])],1)],1),i("el-form-item",{attrs:{label:"翻转镜像："}},[i("el-button",{attrs:{size:"mini",type:"info",round:""},on:{click:e.reverLevel}},[i("i",{staticClass:"el-icon-sort vertial"}),e._v(" 水平 ")]),i("el-button",{attrs:{size:"mini",type:"info",round:""},on:{click:e.reverVertical}},[i("i",{staticClass:"el-icon-sort"}),e._v(" 垂直 ")])],1),i("el-form-item",{attrs:{label:"裁剪比例："}},[i("el-select",{staticClass:"ratio-select",on:{change:e.ratioTypeChange},model:{value:e.cut.ratioType,callback:function(t){e.$set(e.cut,"ratioType",t)},expression:"cut.ratioType"}},[i("el-option",{attrs:{label:"拖动",value:"drag"}}),i("el-option",{attrs:{label:"输入",value:"custom"}}),i("el-option",{attrs:{label:"自适应",value:"original"}}),i("el-option",{attrs:{label:"1:1",value:"1:1"}}),i("el-option",{attrs:{label:"4:3",value:"4:3"}}),i("el-option",{attrs:{label:"3:4",value:"3:4"}}),i("el-option",{attrs:{label:"16:9",value:"16:9"}}),i("el-option",{attrs:{label:"9:16",value:"9:16"}}),i("el-option",{attrs:{label:"3:2",value:"3:2"}}),i("el-option",{attrs:{label:"2:3",value:"2:3"}})],1),"custom"==e.cut.ratioType?i("div",{staticClass:"ratio-input"},[i("el-input-number",{attrs:{controls:!1,min:1,placeholder:"宽"},on:{change:e.changeRatio},model:{value:e.cut.ratio[0],callback:function(t){e.$set(e.cut.ratio,0,t)},expression:"cut.ratio[0]"}}),i("span",[e._v("/")]),i("el-input-number",{attrs:{controls:!1,min:1,placeholder:"高"},on:{change:e.changeRatio},model:{value:e.cut.ratio[1],callback:function(t){e.$set(e.cut.ratio,1,t)},expression:"cut.ratio[1]"}})],1):e._e()],1),i("el-form-item",{attrs:{label:"旋转角度："}},[i("el-input-number",{staticClass:"angle-number",attrs:{min:-180,max:180,"step-strictly":"",size:"small"},on:{change:e.angleBlur},model:{value:e.cut.angle,callback:function(t){e.$set(e.cut,"angle",t)},expression:"cut.angle"}}),i("el-button",{staticClass:"angle-button",attrs:{icon:"el-icon-refresh-left",circle:""},on:{click:e.angleReset}}),i("el-slider",{staticClass:"angle-slider",attrs:{min:-180,max:180,"show-tooltip":!1},on:{input:e.angleBlur},model:{value:e.cut.angle,callback:function(t){e.$set(e.cut,"angle",t)},expression:"cut.angle"}})],1)],1)],1)],1)],1):e._e()},s=[],l=i(2),n=i.n(l),o=i(394),r={name:"pictureCutDialog",props:{dialogVisible:{type:Boolean,default:!1},src:{default:""},width:{type:Number,default:1},height:{type:Number,default:1}},data:function(){return{ready:!1,cut:{shape:"rect",ratioType:"custom",badRatio:!1,angle:0,angleStep:45,ratio:[1,1]},utils:null}},watch:{"cut.shape":function(e){this.utils.setMaskRound("circle"===e)}},created:function(){var e=this;Object(o["c"])((function(t){e.createUtils=t.createUtils,e.ready=!0})),this.$set(this.cut,"ratio",[this.width,this.height])},methods:{angleReset:function(){var e;this.$set(this.cut,"angle",0),null===(e=this.utils)||void 0===e||e.rotateTo(0,!0)},angleBlur:function(){var e;null===(e=this.utils)||void 0===e||e.rotateTo(-this.cut.angle)},ratioTypeChange:function(){var e=this.cut.ratioType;if(this.utils.setMaskResize("drag"==e),"drag"!=e){var t,i=[];if("original"==e){var a=this.$refs.pictureCut.photoRoot.getEventList("PhotoMain");i=[a.imgRect.w,a.imgRect.h]}else i="custom"==e?this.cut.ratio:e.split(":").map((function(e){return+e}));(t=this.utils).setMaskSize.apply(t,n()(i))}},changeRatio:function(){var e;(e=this.utils).setMaskSize.apply(e,n()(this.cut.ratio))},reverLevel:function(){this.utils.setFlipH(!0)},reverVertical:function(){this.utils.setFlipV(!0)},cutImg:function(){var e=this,t=e.utils.cut(void 0,1,"image/png");e.$emit("cut-img",t.file)},dialogOpened:function(){this.utils=this.createUtils(this.$refs["pictureCut"])},closeDialog:function(){this.$emit("dialog-close")}}},c=r,u=(i(677),i(0)),d=Object(u["a"])(c,a,s,!1,null,null,null);t["default"]=d.exports},1130:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"ds-control ds-design-img",style:{"text-align":e.align},on:{click:e.clickHandler}},[e.url?i("el-image",{style:{width:e.width,height:e.height,display:"inline-block"},attrs:{src:e.$url}},[i("div",{staticClass:"image-slot",staticStyle:{"text-align":"center","font-size":"30px"},attrs:{slot:"error"},slot:"error"},[i("i",{staticClass:"el-icon-picture-outline"})])]):[e.isDesign?i("div",{staticClass:"el-image",staticStyle:{display:"block"}},[i("div",{staticClass:"el-image__error"},[e._v("请上传图片")])]):e._e()]],2)},s=[],l=dsf.component({name:"DsfUploadDesignImg",mixins:[$mixins.control],ctrlCaption:"设计图",data:function(){return{}},props:{url:{type:String,default:""},width:{type:[Number,String],default:"100%"},height:{type:[Number,String],default:"auto"},align:{type:String,default:"left"},toUrl:{type:String,default:""}},computed:{$url:function(){return dsf.url.getWebPath(this.url)}},created:function(){},methods:{clickHandler:function(){this.toUrl&&this.$openWindow({url:dsf.url.getWebPath(this.toUrl)})}},watch:{}}),n=l,o=i(0),r=Object(o["a"])(n,a,s,!1,null,null,null);t["default"]=r.exports},394:function(e,t,i){"use strict";function a(e,t){dsf.http.importFiles([dsf.url.getWebPath("$/js/libs/vuePictureCut/vue-picture-cut.css"),dsf.url.getWebPath("$/js/libs/vuePictureCut/vue-picture-cut.umd.min.js")]).then((function(){window.Vue.use(window["vue-picture-cut"].default),null===e||void 0===e||e(window["vue-picture-cut"])})).catch((function(e){dsf.error(e),dsf.layer.message("加载vuePictureCut脚本出错",!1),null===t||void 0===t||t(e)}))}function s(e,t){dsf.http.importFiles([dsf.url.getWebPath("$/js/libs/vcrontab/vcrontab.umd.min.js")]).then((function(){window.Vue.use(window["vcrontab"].default),null===e||void 0===e||e()})).catch((function(e){dsf.error(e),dsf.layer.message("加载vcrontab脚本出错",!1),null===t||void 0===t||t(e)}))}function l(e,t){dsf.http.importFiles([dsf.url.getWebPath("$/js/libs/quill/quill.core.css"),dsf.url.getWebPath("$/js/libs/quill/quill.snow.css"),dsf.url.getWebPath("$/js/libs/quill/quill.bubble.css"),dsf.url.getWebPath("$/js/libs/quill/quill.js"),dsf.url.getWebPath("$/js/libs/quill/vue-quill-editor.js")]).then((function(){window.Vue.use(window["VueQuillEditor"]),null===e||void 0===e||e()})).catch((function(e){dsf.error(e),dsf.layer.message("加载quill脚本出错",!1),null===t||void 0===t||t(e)}))}i.d(t,"c",(function(){return a})),i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return l}))},519:function(e,t,i){var a=i(668);"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var s=i(19).default;s("f01dd4aa",a,!0,{sourceMap:!1,shadowMode:!1})},520:function(e,t,i){e.exports=i.p+"modules/platform/img/coverdefault.png"},521:function(e,t,i){var a=i(670);"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var s=i(19).default;s("733aa351",a,!0,{sourceMap:!1,shadowMode:!1})},522:function(e,t,i){var a=i(674);"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var s=i(19).default;s("8eba859e",a,!0,{sourceMap:!1,shadowMode:!1})},523:function(e,t,i){var a=i(676);"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var s=i(19).default;s("b1ae909e",a,!0,{sourceMap:!1,shadowMode:!1})},524:function(e,t,i){var a=i(678);"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var s=i(19).default;s("879e20ee",a,!0,{sourceMap:!1,shadowMode:!1})},667:function(e,t,i){"use strict";i(519)},668:function(e,t,i){"use strict";i.r(t)},669:function(e,t,i){"use strict";i(521)},670:function(e,t,i){"use strict";i.r(t)},671:function(e,t,i){e.exports=i.p+"modules/platform/img/photodefault.jpg"},672:function(e,t,i){e.exports=i.p+"modules/platform/img/thumbnaildefault.png"},673:function(e,t,i){"use strict";i(522)},674:function(e,t,i){"use strict";i.r(t)},675:function(e,t,i){"use strict";i(523)},676:function(e,t,i){"use strict";i.r(t)},677:function(e,t,i){"use strict";i(524)},678:function(e,t,i){"use strict";i.r(t)}}]);
//# sourceMappingURL=../../../smap/platform/dsf-platform.platform_pc_upload.js.map
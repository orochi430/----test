/*!
 * Name: @dsf/cli-platform
 * Version: 5.17.0-alpha.5
 * Description: 平台基础包
 * BuildTime: 2024/6/19 17:49:40
*/
(("undefined"!==typeof self?self:this)["webpackJsonpplatform"]=("undefined"!==typeof self?self:this)["webpackJsonpplatform"]||[]).push([[32],{1265:function(e,t,o){"use strict";o.r(t);var n=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",[o("div",{attrs:{id:"dsf-document-editor"}}),o("div",{directives:[{name:"show",rawName:"v-show",value:e.showRelationControls,expression:"showRelationControls"}],ref:"menu",staticClass:"autoselect-menu",style:e.pos},e._l(e.relationPageControls,(function(t){return o("div",{key:t.designId,staticClass:"autoselect-menu-item",attrs:{tabindex:"1"},on:{click:function(o){return e.selectRelatComponent(t)},keydown:function(t){return t.stopPropagation(),e.handleMenuKeydown.apply(null,arguments)}}},[e._v(" "+e._s(e.getControlLable(t))+" ")])})),0)])},i=[],r=o(4),s=o.n(r),a=o(1),l=o.n(a),d={name:"page-doc-content",inject:{$designer:{default:null}},props:{docId:{type:String,default:null}},data:function(){return{editor:null,show:!1,pos:{},selectionPostion:{},showRelationControls:!1,relationPageControls:[],editorToolBarHeight:0,themeColor:"red"}},computed:{editorValue:function(){return this.$designer.pageDocument}},methods:{handleClose:function(){this.handleSelectAT(!0,"esc");var e=this.editor.getContent(),t=e.replace(/style="([\s\w\u4e00-\u9fa5:;-]*)(background-color:\s*yellow\s*;*)([\s\w\u4e00-\u9fa5:;-]*)"/g,(function(e,t,o,n){return t||n?'style="'.concat(t).concat(n,'"'):""}));this.$designer.pageDocument=t},showComponentDoc:function(e){var t=this;return s()(l.a.mark((function o(){var n,i,r;return l.a.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return n=e.id,t.show=!0,o.next=4,t.$nextTick();case 4:return o.next=6,t.renderUEditor();case 6:n&&(i=t.editor.document,r=i.querySelectorAll("span[did=".concat(n,"]"))||[],_.forEach(r,(function(e){var t=e.parentNode;$(t).css("background-color","yellow")})));case 7:case"end":return o.stop()}}),o)})))()},selectRelatComponent:function(e){var t=this;this.showRelationControls=!1;var o=this;setTimeout((function(){t.editor.focus(),t.handleSelectAT();var n='<span>&nbsp;</span><span did="'.concat(e.designId,'" style="color: ').concat(o.themeColor,';padding: 0 5px;text-decoration: underline;background-color: transparent;cursor: pointer;">').concat(t.getControlLable(e),"</span><span>&nbsp;</span>");t.editor.execCommand("inserthtml",n),o.selectionPostion={}}),0)},getControlLable:function(e){return e.isFormControl&&e.label?e.label:e.caption},handleMenuKeydown:function(e){if(38===e.which){var t=$(e.target).prev(".autoselect-menu-item");t&&t.focus()}else if(40===e.which){var o=$(e.target).next(".autoselect-menu-item");o.focus()}else 13===e.which&&$(e.target).trigger("click")},getPageControls:function(){var e=[],t=function t(o){o.forEach((function(o){o.caption?(e.push(o),(o.slots||o.controls)&&t(o.controls||o.slots)):o.controls&&Array.isArray(o.controls)?t(o.controls):o.slots&&Array.isArray(o.slots)&&t(o.slots)}))},o=this.$designer.$refs.viewProxy.$$getComponent();t(o.slots),this.relationPageControls=e},getEditorHeight:function(){var e=document.querySelector(".pagedoc-drawer").clientHeight-180;return e},renderUEditor:function(){var e=this;return new Promise((function(t){var o;if(e.editor&&e.editor.destroy(),null!==(o=window)&&void 0!==o&&null!==(o=o.UE)&&void 0!==o&&o.getEditor){var n={toolbars:[["undo","redo","bold","italic","underline","removeformat","formatmatch","pasteplain","forecolor","backcolor","insertorderedlist","insertunorderedlist","selectall","cleardoc","rowspacingtop","rowspacingbottom","lineheight","customstyle","paragraph","fontfamily","fontsize","indent","justifyleft","justifycenter","justifyright","justifyjustify","link","unlink","anchor","inserttable","autotypeset","imagenone","imageleft","imageright","imagecenter","simpleupload"]],initialFrameHeight:e.getEditorHeight(),allowDivTransToP:!1,maximumWords:999999,wordCountMsg:!1,wordCount:!1,classList:[]};e.editor=window.UE.getEditor("dsf-document-editor",n),e.editor.ready((function(){c.call(e,t)}))}}))},handleSelectAT:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if(this.selectionPostion.node){var o=this.editor.document.getSelection(),n=this.editor.document.createRange(),i=this.selectionPostion,r=i.start,s=i.end;"#text"===this.selectionPostion.nodeName?(n.setStart(this.selectionPostion.node,r),n.setEnd(this.selectionPostion.node,s)):(n.setStart(this.selectionPostion.node,r-1),n.setEnd(this.selectionPostion.node,r)),o.removeAllRanges(),o.addRange(n),this.selectionPostion={},e&&("esc"===t&&this.editor.focus(),this.editor.execCommand("inserthtml","<span></span>"))}},handleCancelSelete:function(){var e;this.showRelationControls=!1,this.handleSelectAT(!0),null===(e=this.editor)||void 0===e||e.blur()}},mounted:function(){var e=this,t=this;if(window.UE)this.showComponentDoc({id:this.docId});else{var o=dsf.url.getWebPath("$/js/libs/UEditor/ueditor.config.js"),n=dsf.url.getWebPath("$/js/libs/UEditor/ueditor.all.js");t.$http.importFiles([o,n]).then((function(){e.showComponentDoc({id:e.docId})})).catch((function(e){console.error("加载UEditor.js文件出错")}))}this.themeColor=dsf.themeConfig.currentTheme.normal,this.$el.addEventListener("click",this.handleCancelSelete)},beforeDestroy:function(){this.$el.removeEventListener("click",this.handleCancelSelete);try{this.editor&&this.editor.destroy()}catch(s){dsf.error(s)}finally{var e;for(var t in window.$EDITORUI){var o=window.$EDITORUI[t];"edui-dialog-modalmask"!=o.className&&((o.editor==this.editor||_.isEmpty(o.editor))&&(o.dispose(),o.editor=null,delete window.$EDITORUI[o.id]))}this.editor=null;try{window.UE.delEditor("dsf-document-editor")}catch(s){dsf.warn(s)}var n=(null===(e=window)||void 0===e||null===(e=e.UE)||void 0===e?void 0:e.instants)||{};for(var i in n)if("dsf-document-editor"==n[i].key){for(var r in n[i])delete n[i][r];delete n[i].key;break}}}};function c(e){var t=this;t.editorToolBarHeight=$("#dsf-document-editor .edui-editor-toolbarbox").height(),t.editor.setContent(t.editorValue),t.editor.addListener("keydown",_.throttle((function(e,o){if("@"===o.key&&t.editor.isFocus()){var n=UE.dom.domUtils,i=t.editor.selection.getNative(),r=i.getRangeAt(0),s=t.editor.selection.getRange(),a=r.startOffset,l=r.startContainer;t.selectionPostion={start:a,end:a+1,node:l,nodeName:l.nodeName};var d=s.createBookmark().start;d.style.display="";var c=n.getXY(d),u=c.x,h=c.y;$(d).remove(),t.getPageControls(),t.relationPageControls.length&&(t.showRelationControls=!0);var f=document.querySelector("#dsf-document-editor"),m=window.getComputedStyle(f),g=m.width,p=u+35,v=h+t.editorToolBarHeight+10,w=parseInt(g)-200-10;t.pos={left:"".concat(p>w?w:p,"px"),top:"".concat(v,"px")},t.$nextTick((function(){if(t.relationPageControls.length){var e=document.querySelector(".autoselect-menu-item:first-child");e.removeAttribute("tabindex"),window.setTimeout((function(){e.setAttribute("tabindex",0),e.focus()}))}}))}}))),t.editor.addListener("focus",(function(){t.showRelationControls=!1,t.handleSelectAT(!0,"focus")})),e()}var u=d,h=o(0),f=Object(h["a"])(u,n,i,!1,null,null,null);t["default"]=f.exports}}]);
//# sourceMappingURL=../../../smap/platform/dsf-platform.platform_page_doc_content.js.map
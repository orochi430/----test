/*!
 * Name: @dsf/cli-platform
 * Version: 5.17.0-alpha.5
 * Description: 平台基础包
 * BuildTime: 2024/6/19 17:49:40
*/
(("undefined"!==typeof self?self:this)["webpackJsonpplatform"]=("undefined"!==typeof self?self:this)["webpackJsonpplatform"]||[]).push([[60],{504:function(e,t,a){var i=a(633);"string"===typeof i&&(i=[[e.i,i,""]]),i.locals&&(e.exports=i.locals);var s=a(19).default;s("b5f574f2",i,!0,{sourceMap:!1,shadowMode:!1})},632:function(e,t,a){"use strict";a(504)},633:function(e,t,a){"use strict";a.r(t)},959:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("dsf-flexible-box",{staticClass:"dsf-form-history",attrs:{margin:"5px"},scopedSlots:e._u([{key:"bar",fn:function(){return[a("time-line",{attrs:{id:e.id},on:{change:e.itemChange}})]},proxy:!0}])},[a("form-comparator",{attrs:{path:e.viewPath,ids:e.viewId}})],1)},s=[],n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"time-line",attrs:{loading:e.loading}},[a("div",{staticClass:"time-line-header"},[a("div",{staticClass:"ds-control ds-title-box text-left ds-showColorLump ds_font_"},[e._m(0),a("el-tooltip",{staticClass:"item",attrs:{content:e.reverse?"切换为升序":"切换为降序",effect:"light",placement:"right"}},[a("div",{staticClass:"sort-bt right-icon",attrs:{reverse:e.reverse},on:{click:e.doSort}},[a("i",{staticClass:"iconfont icon-paixu"}),a("i",{staticClass:"iconfont icon-paixu"})])])],1)]),a("dsf-virtual-scroll",{staticClass:"time-line-body",attrs:{height:"0"},on:{scroll:e.onScroll}},[a("dsf-empty-data",{directives:[{name:"show",rawName:"v-show",value:!e.historyList.length&&e.finished,expression:"!historyList.length && finished"}],attrs:{text:"暂无记录"}}),a("el-timeline",e._l(e.historyList,(function(t,i){return a("el-timeline-item",{key:t._id,attrs:{active:t._id==e.activeId,disabled:!t["dsfa_log_dbsource.namespace"]},nativeOn:{click:function(a){return e.itemClick(t,i)}}},[a("div",{staticClass:"item-info ds-multi-ellipsis-1"},[a("i",{staticClass:"iconfont icon-person"}),a("span",[e._v(e._s(t["dsfa_log_dbsource.ds_log_user_name"]))])]),a("div",{staticClass:"item-info ds-multi-ellipsis-2"},[a("i",{staticClass:"iconfont icon-jishufuwu"}),e._v(" "+e._s(e._f("logMsg")(t["dsfa_log_dbsource.ds_log_msg"]))+" ")]),a("div",{staticClass:"item-info"},[a("i",{staticClass:"iconfont icon-icon-time"}),e._v(" "+e._s(t["dsfa_log_dbsource.ds_log_create_time"])+" ")]),a("span",{staticClass:"iconfont icon-gengduo1",on:{click:function(a){return a.stopPropagation(),e.showDetail(t)}}})])})),1),a("div",{directives:[{name:"show",rawName:"v-show",value:!e.finished,expression:"!finished"}],staticClass:"time-line-loading"},[a("i",{staticClass:"el-icon-loading"}),e._v(" 加载中... ")])],1),a("el-dialog",{attrs:{visible:!!e.detailInfo._id,"close-on-click-modal":!1,"custom-class":"dsf-form-history-detail",title:"日志详细信息",width:"600px","append-to-body":""},on:{"update:visible":function(t){e.detailInfo={}}}},[a("fieldset",[a("legend",[e._v("设备信息")]),a("el-form",{attrs:{"label-width":"120px",size:"mini"}},[a("el-form-item",{attrs:{label:"设备类型"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_device_type"]||""))]),a("el-form-item",{attrs:{label:"系统(版本)"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_os"]||""))]),a("el-form-item",{attrs:{label:"IP地址"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_ip"]||""))]),a("el-form-item",{attrs:{label:"浏览器内核"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_browser"]||""))])],1)],1),a("fieldset",[a("legend",[e._v("操作账号")]),a("el-form",{attrs:{"label-width":"120px",size:"mini"}},[a("el-form-item",{attrs:{label:"账号ID"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_user_id"]||""))]),a("el-form-item",{attrs:{label:"账号名"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_user_name"]||""))])],1)],1),a("fieldset",[a("legend",[e._v("日志信息")]),a("el-form",{attrs:{"label-width":"120px",size:"mini"}},[a("el-form-item",{attrs:{label:"日志等级"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_level"]||""))]),a("el-form-item",{attrs:{label:"日志时间"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_create_time"]||""))]),a("el-form-item",{attrs:{label:"日志名称"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_name"]||""))]),a("el-form-item",{attrs:{label:"日志信息"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_log_msg"]||""))]),a("el-form-item",{attrs:{label:"表单ID"}},[e._v(e._s(e.detailInfo["dsfa_log_dbsource.ds_meta_id"]||""))]),a("el-form-item",{attrs:{label:"表单路径"}},[e._v(e._s(e._f("pagePath")(e.detailInfo)))])],1)],1)])],1)},o=[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("label",{staticClass:"ds_label ds-label-box pc ds-font3 ds-bold"},[a("span",{staticClass:"ds_label-text"},[e._v("修改历史")])])}],r={name:"TimeLine",props:{id:{type:String,default:""}},data:function(){return{loading:!1,finished:!1,detailInfo:{},reverse:!0,pageNum:1,pageSize:25,activeId:null,historyList:[]}},watch:{reverse:function(){this.pageNum=0,this.pageSize=25,this.activeId=null,this.finished=!1,this.historyList=[],this.reloadData()},id:{handler:function(e){this.pageNum=0,this.pageSize=25,this.activeId=null,this.finished=!1,this.historyList=[],e&&this.reloadData()},immediate:!0}},filters:{logMsg:function(e){return e.split("[")[0]},pagePath:function(e){var t=e["dsfa_log_dbsource.namespace"]||"",a=e["dsfa_log_dbsource.page_name"]||"";return(t+"."+a).replace(/\./g,"/")}},methods:{reloadData:function(){var e=this;this.loading||this.finished||(this.loading=!0,this.$webAPI.getMetaListData({pageNum:++this.pageNum,pageSize:this.pageSize,query:JSON.stringify({searchValue:this.id}),order:JSON.stringify([{code:"ds_log_create_time",sort:this.reverse?"desc":"asc"}]),namespace:"dsfa.log",pageName:"list"}).then((function(t){var a=t.success,i=t.data,s=t.message;if(a){if(e.loading=!1,i.length<e.pageSize&&(e.finished=!0),!i.length)return;if(e.historyList=e.historyList.concat(i),!e.activeId){var n=_.findIndex(i,(function(e){return!!e["dsfa_log_dbsource.namespace"]}));n>-1&&e.itemClick(i[n],n)}}else dsf.layer.message(s||"请求异常",!1),e.loading=!1})).error((function(t){dsf.layer.message((null===t||void 0===t?void 0:t.message)||"请求异常",!1),e.loading=!1})))},onScroll:function(e,t){var a=t.offsetHeight,i=t.scrollHeight,s=t.scrollTop;s+a>=i-300&&this.reloadData()},doSort:function(){this.loading||(this.reverse=!this.reverse)},showDetail:function(e){this.detailInfo=e},itemClick:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.loading&&e&&e["dsfa_log_dbsource.namespace"]&&this.activeId!=e._id){var a,i,s=this.historyList;this.reverse?(i=e,a=(null===s||void 0===s?void 0:s[t+1])||null):(i=e,a=t>0?s[t-1]:null),this.activeId=e._id,this.$emit("change",i,a)}}}},l=r,d=a(0),c=Object(d["a"])(l,n,o,!1,null,null,null),f=c.exports,u=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"form-comparator",attrs:{loading:!!e.loading}},[a("div",{staticClass:"form-comparator-header"},[a("div",{directives:[{name:"show",rawName:"v-show",value:!e.isAdd,expression:"!isAdd"}],staticClass:"form-comparator-menu"},[a("el-radio-group",{attrs:{size:"mini"},on:{change:e.modelChange},model:{value:e.model,callback:function(t){e.model=t},expression:"model"}},[a("el-radio-button",{attrs:{label:1}},[e._v("修改前")]),a("el-radio-button",{attrs:{label:2}},[e._v("修改后")])],1),a("el-checkbox-button",{staticClass:"el-checkbox-button--mini",on:{change:e.modelChange},model:{value:e.isCompare,callback:function(t){e.isCompare=t},expression:"isCompare"}},[e._v("显示差异项")])],1),a("div",{directives:[{name:"show",rawName:"v-show",value:e.isAdd,expression:"isAdd"}],staticClass:"form-comparator-menu"},[a("el-checkbox-button",{staticClass:"el-checkbox-button--mini",attrs:{value:!0}},[e._v("新增")])],1),a("div",{directives:[{name:"show",rawName:"v-show",value:!e.isAdd&&e.isCompare,expression:"!isAdd && isCompare"}],staticClass:"form-comparator-tips"},[a("div",{staticClass:"form-comparator-tip"},[e._v("新增")]),a("div",{staticClass:"form-comparator-tip"},[e._v("删除")]),a("div",{staticClass:"form-comparator-tip"},[e._v("修改")])])]),a("div",{staticClass:"form-comparator-body"},[e.path?a("dsf-view-part",{ref:"view",attrs:{path:e.path,"read-only":"",independent:""},on:{ready:e.ready}}):e._e()],1),a("i",{ref:"style",staticStyle:{display:"none"}})])},m=[],h=a(4),g=a.n(h),p=a(1),v=a.n(p),b={name:"FormComparator",props:{ids:{type:String,default:""},path:{type:String,default:""}},data:function(){return{loading:0,model:2,isCompare:!0,oldData:{},newData:{},marginOldData:{},marginNewData:{},delNum:0,modNum:0,addNum:0,delData:{},modData:{},addData:{},formVm:null}},computed:{isAdd:function(){return/,$/.test(this.ids)}},watch:{path:function(e){this.loading=1,this.formVm=null},ids:function(e){this.oldData={},this.newData={},this.formVm&&this.init(),this.$refs.style.firstElementChild.innerHTML="",e&&this.getData()}},created:function(){var e=this;this._debounceUpdate=_.debounce((function(){e.setFormReadonly(),e.updateStyle()}),100)},mounted:function(){this.$refs.style.innerHTML="<style></style>"},methods:{getData:function(){var e=this,t=this.ids.replace(/,$/,"");t&&(this.loading++,this.$http.get("/es/getLogByEsIds",{ids:t},{},!0).done((function(a){var i=a.success,s=a.data,n=a.message;if(i){t=t.split(",");var o={},r={};_.each(s,(function(e){var a=e["dsfa_log_dbsource.ds_log_data"]||'""';a=JSON.parse(a),e._id==t[0]?r=a:e._id==t[1]&&(o=a)})),e.oldData=o,e.newData=r,--e.loading||e.init()}else dsf.layer.message(n||"请求异常",!1),e.loading--})).error((function(t){dsf.layer.message((null===t||void 0===t?void 0:t.message)||"请求异常",!1),e.loading--})))},ready:function(e){var t=e.target,a=t.$refs.view;a?(this.formVm=a,--this.loading||this.init()):this.loading=!1},init:function(){var e=this,t=this.formVm;this.compareData();var a=t.updateMetaDataDict;t.updateMetaDataDict=function(){for(var i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];a.apply(t,s),e._debounceUpdate()},this.setFormReadonly(),this.modelChange()},setFormReadonly:function(){var e=this.formVm,t=e.metadataDict;_.each(t,(function(e){var t=e.refs;t&&_.each(t,(function(e){e.readOnly||e.$emit("update:readOnly",!0)}))}))},compareData:function(){var e=w(this.oldData,this.newData,this.formVm.metadataDict);this.marginOldData=e.marginOldData,this.marginNewData=e.marginNewData,this.delData=e.delData,this.modData=e.modData,this.addData=e.addData,this.delNum=e.delNum,this.modNum=e.modNum,this.addNum=e.addNum},modelChange:function(){var e=this;return g()(v.a.mark((function t(){var a,i,s,n,o,r,l,d;return v.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(a=e.formVm,i=e.isAdd,s=e.model,n=e.isCompare,o=e.oldData,r=e.newData,l=e.marginOldData,d=e.marginNewData,a){t.next=3;break}return t.abrupt("return");case 3:return t.next=5,e.$nextTick();case 5:if(!i){t.next=9;break}a.setViewData(r),t.next=16;break;case 9:t.t0=s,t.next=1===t.t0?12:2===t.t0?14:16;break;case 12:return a.setViewData(n?l:o),t.abrupt("break",16);case 14:return a.setViewData(n?d:r),t.abrupt("break",16);case 16:e.updateStyle();case 17:case"end":return t.stop()}}),t)})))()},updateStyle:function(){var e=this;return g()(v.a.mark((function t(){var a,i,s,n,o,r,l,d,c;return v.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.isCompare){t.next=3;break}return e.$refs.style.firstElementChild.innerHTML="",t.abrupt("return");case 3:return t.next=5,e.$nextTick();case 5:a=e.formVm,i=a.metadataDict,s=e.delData,n=e.modData,o=e.addData,r=[],l=[],d=[],_.each(n,(function(e,t){var a,s=i[t];if("subtable"!==s.type)r.push('.form-comparator-body [form-name="'.concat(t,'"]'));else if(null!==(a=s.refs)&&void 0!==a&&a.length){var n=s.refs[0],o=n.pageSize;_.each(e,(function(e,a){var i=+a%o+1,s=_.ceil(i/o);_.each(e,(function(e,a){r.push('.form-comparator-body [form-name="'.concat(t,'"][current-page="').concat(s,'"] tr:nth-child(').concat(i,') [form-name^="').concat(a,'"]'))}))}))}})),_.each(s,(function(e,t){var a,s=i[t];if(null!==(a=s.refs)&&void 0!==a&&a.length){var n=s.refs[0],o=n.pageSize;_.each(e,(function(e,a){var i=+a%o+1,s=_.ceil(i/o);l.push('.form-comparator-body [form-name="'.concat(t,'"][current-page="').concat(s,'"] tr:nth-child(').concat(i,") td"))}))}})),_.each(o,(function(e,t){var a,s=i[t];if(null!==(a=s.refs)&&void 0!==a&&a.length){var n=s.refs[0],o=n.pageSize;_.each(e,(function(e,a){var i=+a%o+1,s=_.ceil(i/o);d.push('.form-comparator-body [form-name="'.concat(t,'"][current-page="').concat(s,'"] tr:nth-child(').concat(i,") td"))}))}})),c=[],r.length&&(e.isAdd?c.push(r.join(",\n")+" {\n\tbackground-color: #dbffd5;\n}"):c.push(r.join(",\n")+" {\n\tbackground-color: #fff9db;\n}")),l.length&&c.push(l.join(",\n")+" {\n\tbackground-color: #ffebeb;\n}"),d.length&&c.push(d.join(",\n")+" {\n\tbackground-color: #dbffd5;\n}"),e.$refs.style.firstElementChild.innerHTML=c.join("\n");case 17:case"end":return t.stop()}}),t)})))()}}};function y(e){return!!dsf.isUnDef(e)||(!(!dsf.isPlainObject(e)||!dsf.isEmptyObject(e))||""===e)}function w(e,t,a){var i={},s={},n={},o={},r={},l=0,d=0,c=0;return _.each(a,(function(f,u){if("subtable"==f.type){var m=_.clone(e[u]),h=_.clone(t[u]);i[u]=[],s[u]=[];var g={},p={},v={};_.each(h,(function(e){var t=s[u].length,n=_.findIndex(m,(function(t){return t._id==e._id}));if(n>-1){var o=m.splice(n,1)[0],r={};_.each(a,(function(t,a){if(t.inSubTable==u){var i=o[a],s=e[a];y(i)&&y(s)||JSON.stringify(i)!=JSON.stringify(s)&&(r[a]={old:i,new:s},d++)}})),_.values(r).length>0&&(v[t]=r),i[u].push(o),s[u].push(e)}else p[t]=e,c++,i[u].push(e),s[u].push(e)})),_.each(m,(function(e){g[s[u].length]=e,i[u].push(e),s[u].push(e),l++})),_.values(g).length&&(n[u]=g),_.values(p).length&&(r[u]=p),_.values(v).length&&(o[u]=v)}else if(void 0===f.inSubTable){var b=e[u],w=t[u];y(b)&&y(w)||JSON.stringify(b)==JSON.stringify(w)?(i[u]=w,s[u]=w):(i[u]=b,s[u]=w,o[u]={old:b,new:w},d++)}})),{marginOldData:i,marginNewData:s,delData:n,modData:o,addData:r,delNum:l,modNum:d,addNum:c}}var D=b,C=Object(d["a"])(D,u,m,!1,null,null,null),x=C.exports,N={name:"DsfFormHistory",components:{TimeLine:f,FormComparator:x},data:function(){return{id:"",viewId:"",viewPath:""}},created:function(){this.id=this.$route.query.id},methods:{itemChange:function(e,t){var a=e["dsfa_log_dbsource.namespace"],i=e["dsfa_log_dbsource.page_name"];a&&i?(this.viewId=[e._id,(null===t||void 0===t?void 0:t._id)||""].join(","),this.viewPath=(a+"."+i).replace(/\./g,"/")):dsf.layer.message("当前选择记录缺少页面信息",!1)}}},I=N,k=(a(632),Object(d["a"])(I,i,s,!1,null,null,null));t["default"]=k.exports}}]);
//# sourceMappingURL=../../../smap/platform/dsf-platform.platform_pc_router_form_history.js.map